<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>3. Power Analysis using DeclareDesign | Reproducible and reusable social science with R: a field guide</title>
  <meta name="description" content="This page contains tips to make your R code reproducible." />
  <meta name="generator" content="bookdown 0.42 and GitBook 2.6.7" />

  <meta property="og:title" content="3. Power Analysis using DeclareDesign | Reproducible and reusable social science with R: a field guide" />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="This page contains tips to make your R code reproducible." />
  <meta name="github-repo" content="kleuveld/r_cheatsheet" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="3. Power Analysis using DeclareDesign | Reproducible and reusable social science with R: a field guide" />
  
  <meta name="twitter:description" content="This page contains tips to make your R code reproducible." />
  

<meta name="author" content="Koen" />


<meta name="date" content="2026-02-20" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="programming.html"/>
<link rel="next" href="datawrangling.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>
<link href="libs/tabwid-1.1.3/tabwid.css" rel="stylesheet" />
<script src="libs/tabwid-1.1.3/tabwid.js"></script>
<link href="libs/htmltools-fill-0.5.8.1/fill.css" rel="stylesheet" />
<script src="libs/htmlwidgets-1.6.4/htmlwidgets.js"></script>
<link href="libs/leaflet-1.3.1/leaflet.css" rel="stylesheet" />
<script src="libs/leaflet-1.3.1/leaflet.js"></script>
<link href="libs/leafletfix-1.0.0/leafletfix.css" rel="stylesheet" />
<script src="libs/proj4-2.6.2/proj4.min.js"></script>
<script src="libs/Proj4Leaflet-1.0.1/proj4leaflet.js"></script>
<link href="libs/rstudio_leaflet-1.3.1/rstudio_leaflet.css" rel="stylesheet" />
<script src="libs/leaflet-binding-2.2.2/leaflet.js"></script>


<style type="text/css">
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Reproducible and reusable social science with R: a field guide</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Introduction</a>
<ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#about"><i class="fa fa-check"></i>About</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#setup"><i class="fa fa-check"></i>Setting up</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="reproducible-workflows.html"><a href="reproducible-workflows.html"><i class="fa fa-check"></i>1. Reproducible Workflows</a>
<ul>
<li class="chapter" data-level="" data-path="reproducible-workflows.html"><a href="reproducible-workflows.html#introduction-1"><i class="fa fa-check"></i>Introduction</a></li>
<li class="chapter" data-level="" data-path="reproducible-workflows.html"><a href="reproducible-workflows.html#projects"><i class="fa fa-check"></i>Projects</a>
<ul>
<li class="chapter" data-level="" data-path="reproducible-workflows.html"><a href="reproducible-workflows.html#here"><i class="fa fa-check"></i>Here</a></li>
<li class="chapter" data-level="" data-path="reproducible-workflows.html"><a href="reproducible-workflows.html#using-machine-specific-paths"><i class="fa fa-check"></i>Using machine-specific paths</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="reproducible-workflows.html"><a href="reproducible-workflows.html#renv"><i class="fa fa-check"></i>renv</a>
<ul>
<li class="chapter" data-level="" data-path="reproducible-workflows.html"><a href="reproducible-workflows.html#starting-a-project-with-renv"><i class="fa fa-check"></i>Starting a project with Renv</a></li>
<li class="chapter" data-level="" data-path="reproducible-workflows.html"><a href="reproducible-workflows.html#installing-new-packages-with-renv"><i class="fa fa-check"></i>Installing new packages with Renv</a></li>
<li class="chapter" data-level="" data-path="reproducible-workflows.html"><a href="reproducible-workflows.html#restoring-a-project"><i class="fa fa-check"></i>Restoring a project</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="" data-path="programming.html"><a href="programming.html"><i class="fa fa-check"></i>2. Programming with R</a>
<ul>
<li class="chapter" data-level="" data-path="programming.html"><a href="programming.html#loops"><i class="fa fa-check"></i>Loops</a></li>
<li class="chapter" data-level="" data-path="programming.html"><a href="programming.html#functions"><i class="fa fa-check"></i>Functions</a>
<ul>
<li class="chapter" data-level="" data-path="programming.html"><a href="programming.html#basic-functions"><i class="fa fa-check"></i>Basic Functions</a></li>
<li class="chapter" data-level="" data-path="programming.html"><a href="programming.html#functions-and-the-tidyverse"><i class="fa fa-check"></i>Functions and the tidyverse</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="programming.html"><a href="programming.html#map"><i class="fa fa-check"></i>Map()</a></li>
<li class="chapter" data-level="" data-path="programming.html"><a href="programming.html#other-variants-of-map"><i class="fa fa-check"></i>Other variants of <code>map()</code></a></li>
<li class="chapter" data-level="" data-path="programming.html"><a href="programming.html#making-functions-re-usable-with-box"><i class="fa fa-check"></i>Making functions re-usable with box</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="declaredesign.html"><a href="declaredesign.html"><i class="fa fa-check"></i>3. Power Analysis using DeclareDesign</a>
<ul>
<li class="chapter" data-level="" data-path="declaredesign.html"><a href="declaredesign.html#simple-power-calculation"><i class="fa fa-check"></i>Simple Power Calculation</a>
<ul>
<li class="chapter" data-level="" data-path="declaredesign.html"><a href="declaredesign.html#loading-data"><i class="fa fa-check"></i>Loading data</a></li>
<li class="chapter" data-level="" data-path="declaredesign.html"><a href="declaredesign.html#declare-design"><i class="fa fa-check"></i>Declare Design</a></li>
<li class="chapter" data-level="" data-path="declaredesign.html"><a href="declaredesign.html#diagnosing-design-and-calculating-power"><i class="fa fa-check"></i>Diagnosing Design and calculating power</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="declaredesign.html"><a href="declaredesign.html#dif-in-diff"><i class="fa fa-check"></i>Dif in diff</a></li>
<li class="chapter" data-level="" data-path="declaredesign.html"><a href="declaredesign.html#matching"><i class="fa fa-check"></i>Matching</a>
<ul>
<li class="chapter" data-level="" data-path="declaredesign.html"><a href="declaredesign.html#declare-design-1"><i class="fa fa-check"></i>Declare Design</a></li>
<li class="chapter" data-level="" data-path="declaredesign.html"><a href="declaredesign.html#bias"><i class="fa fa-check"></i>Bias</a></li>
<li class="chapter" data-level="" data-path="declaredesign.html"><a href="declaredesign.html#power"><i class="fa fa-check"></i>Power</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="" data-path="datawrangling.html"><a href="datawrangling.html"><i class="fa fa-check"></i>4. Data Cleaning</a>
<ul>
<li class="chapter" data-level="" data-path="datawrangling.html"><a href="datawrangling.html#the-basic-pattern"><i class="fa fa-check"></i>The basic pattern</a></li>
<li class="chapter" data-level="" data-path="datawrangling.html"><a href="datawrangling.html#using-plots-to-identify-data-issues-reproducibly"><i class="fa fa-check"></i>Using plots to identify data issues reproducibly</a></li>
<li class="chapter" data-level="" data-path="datawrangling.html"><a href="datawrangling.html#dealing-with-multiple-levels-of-data"><i class="fa fa-check"></i>Dealing with multiple levels of data</a>
<ul>
<li class="chapter" data-level="" data-path="datawrangling.html"><a href="datawrangling.html#pivoting-long-to-wide"><i class="fa fa-check"></i>Pivoting long to wide</a></li>
<li class="chapter" data-level="" data-path="datawrangling.html"><a href="datawrangling.html#pivoting-wide-to-long"><i class="fa fa-check"></i>Pivoting wide to long</a></li>
<li class="chapter" data-level="" data-path="datawrangling.html"><a href="datawrangling.html#joining-or-merging-data"><i class="fa fa-check"></i>Joining (or merging) data</a></li>
<li class="chapter" data-level="" data-path="datawrangling.html"><a href="datawrangling.html#summarizing-over-groups-or-collapsing-data"><i class="fa fa-check"></i>Summarizing over groups (or collapsing data)</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="datawrangling.html"><a href="datawrangling.html#editing-many-variables-at-once"><i class="fa fa-check"></i>Editing many variables at once</a>
<ul>
<li class="chapter" data-level="" data-path="datawrangling.html"><a href="datawrangling.html#across"><i class="fa fa-check"></i>across(): doing the same operations on multiple variables using across</a></li>
<li class="chapter" data-level="" data-path="datawrangling.html"><a href="datawrangling.html#converting-all-yesno-factors-to-dummies"><i class="fa fa-check"></i>Converting all yes/no factors to dummies</a></li>
<li class="chapter" data-level="" data-path="datawrangling.html"><a href="datawrangling.html#pivoting"><i class="fa fa-check"></i>Pivoting</a></li>
<li class="chapter" data-level="" data-path="datawrangling.html"><a href="datawrangling.html#using-many-variables-as-inputs"><i class="fa fa-check"></i>Using many variables as inputs</a></li>
<li class="chapter" data-level="" data-path="datawrangling.html"><a href="datawrangling.html#renaming-many-variables"><i class="fa fa-check"></i>Renaming many variables</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="datawrangling.html"><a href="datawrangling.html#seperate_longer"><i class="fa fa-check"></i>Splitting multi-response variable into dummies</a></li>
<li class="chapter" data-level="" data-path="datawrangling.html"><a href="datawrangling.html#cleaning-rmd"><i class="fa fa-check"></i>Structure of a cleaning Rmarkdown doc with multi-level data</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="reporting.html"><a href="reporting.html"><i class="fa fa-check"></i>5. Estimating and reporting</a>
<ul>
<li class="chapter" data-level="" data-path="reporting.html"><a href="reporting.html#generating-some-fake-data"><i class="fa fa-check"></i>Generating some fake data</a></li>
<li class="chapter" data-level="" data-path="reporting.html"><a href="reporting.html#making-a-table-of-summary-statistics"><i class="fa fa-check"></i>Making a table of summary statistics</a>
<ul>
<li class="chapter" data-level="" data-path="reporting.html"><a href="reporting.html#using-modelsummary-and-flextable"><i class="fa fa-check"></i>Using modelsummary and flextable</a></li>
<li class="chapter" data-level="" data-path="reporting.html"><a href="reporting.html#balance-table"><i class="fa fa-check"></i>Balance Table</a></li>
<li class="chapter" data-level="" data-path="reporting.html"><a href="reporting.html#advanced-using-only-flextable"><i class="fa fa-check"></i>Advanced: Using only Flextable</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="reporting.html"><a href="reporting.html#regression-tables"><i class="fa fa-check"></i>Regression Tables</a>
<ul>
<li class="chapter" data-level="" data-path="reporting.html"><a href="reporting.html#simple-regression"><i class="fa fa-check"></i>Simple regression</a></li>
<li class="chapter" data-level="" data-path="reporting.html"><a href="reporting.html#robust-standard-errors-and-custom-glance-methods"><i class="fa fa-check"></i>Robust standard errors, and custom glance methods</a></li>
<li class="chapter" data-level="" data-path="reporting.html"><a href="reporting.html#probit-with-cluster-robust-ses"><i class="fa fa-check"></i>Probit with cluster robust SEs</a></li>
<li class="chapter" data-level="" data-path="reporting.html"><a href="reporting.html#marginal-effects"><i class="fa fa-check"></i>Marginal Effects</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="reporting.html"><a href="reporting.html#plots"><i class="fa fa-check"></i>Plots</a>
<ul>
<li class="chapter" data-level="" data-path="reporting.html"><a href="reporting.html#faceting"><i class="fa fa-check"></i>Faceting</a></li>
<li class="chapter" data-level="" data-path="reporting.html"><a href="reporting.html#stacked-bar-plots-in-wur-style"><i class="fa fa-check"></i>Stacked bar plots in WUR style</a></li>
<li class="chapter" data-level="" data-path="reporting.html"><a href="reporting.html#lollipop-plot"><i class="fa fa-check"></i>Lollipop plot</a></li>
<li class="chapter" data-level="" data-path="reporting.html"><a href="reporting.html#maps"><i class="fa fa-check"></i>Maps</a></li>
</ul></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Reproducible and reusable social science with R: a field guide</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="declaredesign" class="section level1 hasAnchor">
<h1>3. Power Analysis using DeclareDesign<a href="declaredesign.html#declaredesign" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>There’s a lot that goes into research design,
but here we focus on one thing that can be done well in R: power calculations.
For this, I love <a href="https://declaredesign.org/">DeclareDesign</a>,
a system to simulate Research Designs.
Essentially, rather than plugging some parameters into a power calculator,
you simulate your research and so investigate the statistical properties of your design.
This is great, because it is often hard to include things like clustering and
covariates in standard power calculators,
and it forces you to be explicit about what you expect about your research.</p>
<p>This chapter will only scratch the surface of what you can do,
so I really recommend further learning about DeclareDesign:</p>
<ul>
<li><a href="https://macartan.github.io/slides/202211_declaredesign_and_power.html">Slides by the authors of DeclareDesign: Graeme Blair, Alex Coppock, Macartan Humphreys</a></li>
<li><a href="https://raw.githubusercontent.com/rstudio/cheatsheets/master/declaredesign.pdf">The DeclareDesign CheatSheet</a></li>
<li>The book <a href="https://book.declaredesign.org/">Research Design in the Social Sciences: Declaration, Diagnosis, and Redesign</a></li>
</ul>
<p>Read at least the slides before going forward!</p>
<p>This chapter covers power calculations in three designs:
a simple comparison of means, a diff-in-diff design, and a matching design.
To start of, we need example data.
You can simulate this, but I prefer using existing data.
Here we use Rhomis data.</p>
<div id="simple-power-calculation" class="section level2 hasAnchor">
<h2>Simple Power Calculation<a href="declaredesign.html#simple-power-calculation" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>The first design we consider is simply a comparison of means.
We are interested in the effects of a project on the input of fertilizers.</p>
<div id="loading-data" class="section level3 hasAnchor">
<h3>Loading data<a href="declaredesign.html#loading-data" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Here we take the Rhomis data, and add some variables.
(For example, village codes: I create fake ones based on y-cooridnates.)</p>
<div class="sourceCode" id="cb52"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb52-1"><a href="declaredesign.html#cb52-1" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb52-2"><a href="declaredesign.html#cb52-2" tabindex="-1"></a><span class="fu">library</span>(DeclareDesign)</span>
<span id="cb52-3"><a href="declaredesign.html#cb52-3" tabindex="-1"></a><span class="fu">library</span>(here)</span>
<span id="cb52-4"><a href="declaredesign.html#cb52-4" tabindex="-1"></a></span>
<span id="cb52-5"><a href="declaredesign.html#cb52-5" tabindex="-1"></a></span>
<span id="cb52-6"><a href="declaredesign.html#cb52-6" tabindex="-1"></a>n_clusters <span class="ot">=</span> <span class="dv">18</span></span>
<span id="cb52-7"><a href="declaredesign.html#cb52-7" tabindex="-1"></a></span>
<span id="cb52-8"><a href="declaredesign.html#cb52-8" tabindex="-1"></a>rhomis <span class="ot">&lt;-</span></span>
<span id="cb52-9"><a href="declaredesign.html#cb52-9" tabindex="-1"></a>  <span class="fu">read_csv</span>(<span class="fu">here</span>(<span class="st">&quot;data/RHoMIS_Indicators.csv&quot;</span>)) <span class="sc">%&gt;%</span> <span class="co">#names()</span></span>
<span id="cb52-10"><a href="declaredesign.html#cb52-10" tabindex="-1"></a>  <span class="fu">filter</span>(Country <span class="sc">==</span> <span class="st">&quot;Burundi&quot;</span>) <span class="sc">%&gt;%</span> <span class="co">#count(Livestock_Orientation)</span></span>
<span id="cb52-11"><a href="declaredesign.html#cb52-11" tabindex="-1"></a></span>
<span id="cb52-12"><a href="declaredesign.html#cb52-12" tabindex="-1"></a>  <span class="co"># split the sample in villages, by lattitude</span></span>
<span id="cb52-13"><a href="declaredesign.html#cb52-13" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(GPS_LAT)) <span class="sc">%&gt;%</span></span>
<span id="cb52-14"><a href="declaredesign.html#cb52-14" tabindex="-1"></a>  <span class="fu">arrange</span>(GPS_LAT) <span class="sc">%&gt;%</span></span>
<span id="cb52-15"><a href="declaredesign.html#cb52-15" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">village =</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span>n_clusters, <span class="at">each =</span> <span class="fu">nrow</span>(.) <span class="sc">/</span> n_clusters , <span class="at">length.out =</span>  <span class="fu">nrow</span>(.))) <span class="sc">%&gt;%</span></span>
<span id="cb52-16"><a href="declaredesign.html#cb52-16" tabindex="-1"></a>  <span class="co"># create some variables</span></span>
<span id="cb52-17"><a href="declaredesign.html#cb52-17" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">HFIAS_status =</span> <span class="fu">factor</span>(HFIAS_status, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">&quot;FoodSecure&quot;</span>, <span class="st">&quot;MildlyFI&quot;</span>, <span class="st">&quot;ModeratelyFI&quot;</span>, <span class="st">&quot;SeverelyFI&quot;</span>)),</span>
<span id="cb52-18"><a href="declaredesign.html#cb52-18" tabindex="-1"></a>         <span class="at">food_secure =</span> <span class="dv">1</span> <span class="sc">*</span> (<span class="fu">as.numeric</span>(HFIAS_status) <span class="sc">&lt;=</span> <span class="dv">3</span>),</span>
<span id="cb52-19"><a href="declaredesign.html#cb52-19" tabindex="-1"></a>         <span class="at">educated =</span> <span class="dv">1</span><span class="sc">*</span>(Head_EducationLevel <span class="sc">!=</span> <span class="st">&quot;No_school&quot;</span>),</span>
<span id="cb52-20"><a href="declaredesign.html#cb52-20" tabindex="-1"></a>         <span class="at">female =</span> <span class="dv">1</span><span class="sc">*</span> (HouseholdType <span class="sc">==</span> <span class="st">&quot;woman_single&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb52-21"><a href="declaredesign.html#cb52-21" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">hh =</span> <span class="fu">row_number</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb52-22"><a href="declaredesign.html#cb52-22" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">!</span>HFIAS_status) <span class="sc">%&gt;%</span></span>
<span id="cb52-23"><a href="declaredesign.html#cb52-23" tabindex="-1"></a></span>
<span id="cb52-24"><a href="declaredesign.html#cb52-24" tabindex="-1"></a>  <span class="co"># there are too many missings in my data; these seem reasonable to assume to be 0 when missing:</span></span>
<span id="cb52-25"><a href="declaredesign.html#cb52-25" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">c</span>(LandOwned,NFertInput,educated),</span>
<span id="cb52-26"><a href="declaredesign.html#cb52-26" tabindex="-1"></a>         <span class="sc">~</span> <span class="fu">if_else</span>(<span class="fu">is.na</span>(.x),<span class="dv">0</span>,.x))) <span class="sc">%&gt;%</span></span>
<span id="cb52-27"><a href="declaredesign.html#cb52-27" tabindex="-1"></a>  <span class="fu">select</span>(village, hh, NFertInput, food_secure, educated, LivestockHoldings)</span></code></pre></div>
</div>
<div id="declare-design" class="section level3 hasAnchor">
<h3>Declare Design<a href="declaredesign.html#declare-design" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Now it’s time to start declaring our design. The first element of the
design is the model, using <code>declare_model()</code> which essentially is my data.
<code>declare_model()</code> follows the syntax of <code>fabricate()</code>:
a package that is part of the DeclareDesign ecosystem that allows you to generate fake data.
In this syntax, instead of using <code>mutate()</code> we can just supply new variables
after a comma.
In this case, I add potential outcomes, using <code>potential_outcomes()</code>:</p>
<div class="sourceCode" id="cb53"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb53-1"><a href="declaredesign.html#cb53-1" tabindex="-1"></a>effect_size_simple <span class="ot">&lt;-</span> <span class="dv">70</span></span>
<span id="cb53-2"><a href="declaredesign.html#cb53-2" tabindex="-1"></a></span>
<span id="cb53-3"><a href="declaredesign.html#cb53-3" tabindex="-1"></a>model_simple <span class="ot">&lt;-</span> </span>
<span id="cb53-4"><a href="declaredesign.html#cb53-4" tabindex="-1"></a>  <span class="fu">declare_model</span>(</span>
<span id="cb53-5"><a href="declaredesign.html#cb53-5" tabindex="-1"></a>    rhomis <span class="sc">%&gt;%</span> <span class="fu">select</span>(village, NFertInput),</span>
<span id="cb53-6"><a href="declaredesign.html#cb53-6" tabindex="-1"></a>    <span class="fu">potential_outcomes</span>(Y <span class="sc">~</span> NFertInput <span class="sc">+</span> Z <span class="sc">*</span> effect_size_simple)</span>
<span id="cb53-7"><a href="declaredesign.html#cb53-7" tabindex="-1"></a>)</span></code></pre></div>
<p>The potential outcomes are generated using <code>potential_outcomes()</code>.
This will create two variables <code>Y_Z_1</code> and <code>Y_Z_0</code>, which are
the potential outcomes if having received treatment (<code>Z == 1</code>) or not.
The difference between these is the effect size, which we assume to be 70 kg,
we store this in a variable, so we can play with it later on.
Note that I will generate <code>Z</code> in the next step.</p>
<p>Then it’s time to think about assignment.
I do a clustered randomization, based on the villages:</p>
<div class="sourceCode" id="cb54"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb54-1"><a href="declaredesign.html#cb54-1" tabindex="-1"></a>assignment_simple <span class="ot">&lt;-</span></span>
<span id="cb54-2"><a href="declaredesign.html#cb54-2" tabindex="-1"></a>  <span class="fu">declare_assignment</span>(<span class="at">Z =</span> <span class="fu">cluster_ra</span>(<span class="at">clusters =</span> village, <span class="at">prob =</span> <span class="fl">0.5</span>)) </span></code></pre></div>
<p>Next, I declare my theoretical quantity of interest is the treatment
effect in year 1.
This is basically my research question.</p>
<div class="sourceCode" id="cb55"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb55-1"><a href="declaredesign.html#cb55-1" tabindex="-1"></a>inquiry_simple <span class="ot">&lt;-</span>  </span>
<span id="cb55-2"><a href="declaredesign.html#cb55-2" tabindex="-1"></a>  <span class="fu">declare_inquiry</span>(<span class="at">ATE =</span> <span class="fu">mean</span>(Y_Z_1 <span class="sc">-</span> Y_Z_0)) </span></code></pre></div>
<div class="sourceCode" id="cb56"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb56-1"><a href="declaredesign.html#cb56-1" tabindex="-1"></a>measurement_simple <span class="ot">&lt;-</span> <span class="fu">declare_measurement</span>(</span>
<span id="cb56-2"><a href="declaredesign.html#cb56-2" tabindex="-1"></a>  <span class="at">Y =</span> <span class="fu">reveal_outcomes</span>(Y <span class="sc">~</span> Z)</span>
<span id="cb56-3"><a href="declaredesign.html#cb56-3" tabindex="-1"></a>)</span></code></pre></div>
<p>Since I won’t be able to observe Y_Z_1 for the control group, nor Y_Z_0 for the treatment group,
I will need an estimation strategy.
The below arguments will be put into <code>lm_robust</code> by default,
and the <code>term</code> argument determines which coefficient is our estimate of interest:</p>
<div class="sourceCode" id="cb57"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb57-1"><a href="declaredesign.html#cb57-1" tabindex="-1"></a>estimator_simple <span class="ot">&lt;-</span></span>
<span id="cb57-2"><a href="declaredesign.html#cb57-2" tabindex="-1"></a>  <span class="fu">declare_estimator</span>(Y <span class="sc">~</span> Z,</span>
<span id="cb57-3"><a href="declaredesign.html#cb57-3" tabindex="-1"></a>                    <span class="at">clusters =</span> village, </span>
<span id="cb57-4"><a href="declaredesign.html#cb57-4" tabindex="-1"></a>                    <span class="at">inquiry =</span> <span class="st">&quot;ATE&quot;</span>, </span>
<span id="cb57-5"><a href="declaredesign.html#cb57-5" tabindex="-1"></a>                    <span class="at">term =</span> <span class="st">&quot;Z&quot;</span>, </span>
<span id="cb57-6"><a href="declaredesign.html#cb57-6" tabindex="-1"></a>                    <span class="at">label =</span> <span class="st">&quot;Simple&quot;</span>)</span></code></pre></div>
<p>Finally, I combine all these elements to declare my design. Note that
it’s only here that R starts actually running the code to randomize
things. The previous was just declaration!</p>
<div class="sourceCode" id="cb58"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb58-1"><a href="declaredesign.html#cb58-1" tabindex="-1"></a>design_simple <span class="ot">&lt;-</span> model_simple <span class="sc">+</span> assignment_simple <span class="sc">+</span> inquiry_simple <span class="sc">+</span> measurement_simple <span class="sc">+</span> estimator_simple</span>
<span id="cb58-2"><a href="declaredesign.html#cb58-2" tabindex="-1"></a><span class="fu">summary</span>(design_simple)</span></code></pre></div>
<pre><code>## 
## Research design declaration summary
## 
## Step 1 (model): declare_model(rhomis %&gt;% select(village, NFertInput), potential_outcomes(Y ~ NFertInput + Z * effect_size_simple)) 
## 
## N = 290 
## 
## Added variable: village 
##  min median mean max   sd N_missing N_unique
##    1      9 9.44  18 5.23         0       18
## 
## Added variable: NFertInput 
##  min median  mean  max     sd N_missing N_unique
##    0     16 72.71 7500 465.79         0       44
## 
## Added variable: ID 
##  N_missing N_unique     class
##          0      290 character
## 
## Added variable: Y_Z_0 
##  min median  mean  max     sd N_missing N_unique
##    0     16 72.71 7500 465.79         0       44
## 
## Added variable: Y_Z_1 
##  min median   mean  max     sd N_missing N_unique
##   70     86 142.71 7570 465.79         0       44
## 
## Step 2 (assignment): declare_assignment(Z = cluster_ra(clusters = village, prob = 0.5)) 
## 
## Added variable: Z 
##     0    1
##   146  144
##  0.50 0.50
## 
## Step 3 (inquiry): declare_inquiry(ATE = mean(Y_Z_1 - Y_Z_0)) -------------------
## 
## A single draw of the inquiry:
##  inquiry estimand
##      ATE       70
## 
## Step 4 (measurement): declare_measurement(Y = reveal_outcomes(Y ~ Z)) ----------
## 
## Added variable: Y 
##  min median   mean  max     sd N_missing N_unique
##    0     70 107.46 7500 464.29         0       56
## 
## Step 5 (estimator): declare_estimator(Y ~ Z, clusters = village, inquiry = &quot;ATE&quot;, term = &quot;Z&quot;, label = &quot;Simple&quot;) 
## 
## Formula: Y ~ Z 
## 
## A single draw of the estimator:
##  term estimator  estimate std.error  statistic   p.value  conf.low conf.high
##     Z    Simple -4.859351  58.40995 -0.0831939 0.9347302 -128.6916  118.9729
##        df outcome inquiry
##  15.98618       Y     ATE</code></pre>
</div>
<div id="diagnosing-design-and-calculating-power" class="section level3 hasAnchor">
<h3>Diagnosing Design and calculating power<a href="declaredesign.html#diagnosing-design-and-calculating-power" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>If you want to browse a version of the data created by your design,
use the <code>draw_data()</code> function. This is useful to examine the properties of the data.</p>
<div class="sourceCode" id="cb60"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb60-1"><a href="declaredesign.html#cb60-1" tabindex="-1"></a><span class="fu">draw_data</span>(design_simple) <span class="sc">%&gt;%</span></span>
<span id="cb60-2"><a href="declaredesign.html#cb60-2" tabindex="-1"></a>  <span class="fu">as_tibble</span>()</span></code></pre></div>
<pre><code>## # A tibble: 290 × 7
##    village NFertInput ID    Y_Z_0 Y_Z_1     Z     Y
##      &lt;int&gt;      &lt;dbl&gt; &lt;chr&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;int&gt; &lt;dbl&gt;
##  1       1          5 001       5    75     0     5
##  2       1         26 002      26    96     0    26
##  3       1         40 003      40   110     0    40
##  4       1          0 004       0    70     0     0
##  5       1         10 005      10    80     0    10
##  6       1         25 006      25    95     0    25
##  7       1         25 007      25    95     0    25
##  8       1         60 008      60   130     0    60
##  9       1          0 009       0    70     0     0
## 10       1          0 010       0    70     0     0
## # ℹ 280 more rows</code></pre>
<p>Now to calculate our power. The <code>diagnose_design()</code> will run our
model 500 times and our power is simply the fraction of times we
find a statistically significant effect.</p>
<div class="sourceCode" id="cb62"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb62-1"><a href="declaredesign.html#cb62-1" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb62-2"><a href="declaredesign.html#cb62-2" tabindex="-1"></a><span class="fu">diagnose_design</span>(design_simple)</span></code></pre></div>
<pre><code>## 
## Research design diagnosis based on 500 simulations. Diagnosis completed in 5 secs. Diagnosand estimates with bootstrapped standard errors in parentheses (100 replicates).
## 
##         Design Inquiry Estimator Outcome Term N Sims Mean Estimand
##  design_simple     ATE    Simple       Y    Z    500         70.00
##                                                             (0.00)
##  Mean Estimate   Bias SD Estimate   RMSE  Power Coverage
##          72.34   2.34       60.30  60.29   0.27     1.00
##         (2.84) (2.84)      (0.82) (0.80) (0.02)   (0.00)</code></pre>
<p>Our power is 0.23, meaning we found a significant result in 23%
of our model runs.
That’s way lower than the traditional 80% threshold.</p>
<p>How large should our effect size be to reach a power of 0.8?
We can use the <code>redesign()</code> function for this.
Redesign allows you to vary certain parameters of your design,
and run the design 500 times for each value of the parameter.
You can change this number using the <code>sims</code> argument.</p>
<div class="sourceCode" id="cb64"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb64-1"><a href="declaredesign.html#cb64-1" tabindex="-1"></a>num_sims <span class="ot">&lt;-</span> <span class="dv">500</span></span>
<span id="cb64-2"><a href="declaredesign.html#cb64-2" tabindex="-1"></a></span>
<span id="cb64-3"><a href="declaredesign.html#cb64-3" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb64-4"><a href="declaredesign.html#cb64-4" tabindex="-1"></a>diagnosis_simple <span class="ot">&lt;-</span></span>
<span id="cb64-5"><a href="declaredesign.html#cb64-5" tabindex="-1"></a>  design_simple <span class="sc">%&gt;%</span></span>
<span id="cb64-6"><a href="declaredesign.html#cb64-6" tabindex="-1"></a>  <span class="fu">redesign</span>(<span class="at">effect_size_simple =</span> <span class="fu">seq</span>(<span class="dv">100</span>,<span class="dv">300</span>,<span class="dv">50</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb64-7"><a href="declaredesign.html#cb64-7" tabindex="-1"></a>  <span class="fu">diagnose_design</span>(<span class="at">sims =</span> num_sims) <span class="sc">%&gt;%</span></span>
<span id="cb64-8"><a href="declaredesign.html#cb64-8" tabindex="-1"></a>  <span class="fu">tidy</span>() <span class="sc">%&gt;%</span></span>
<span id="cb64-9"><a href="declaredesign.html#cb64-9" tabindex="-1"></a>  <span class="fu">as_tibble</span>()</span></code></pre></div>
<p>Now, I want a nice plot.
For this I filter the tibble I created, and pipe it into <code>ggplot()</code>:</p>
<div class="sourceCode" id="cb65"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb65-1"><a href="declaredesign.html#cb65-1" tabindex="-1"></a>diagnosis_simple <span class="sc">%&gt;%</span></span>
<span id="cb65-2"><a href="declaredesign.html#cb65-2" tabindex="-1"></a>  <span class="fu">filter</span>(diagnosand <span class="sc">==</span> <span class="st">&quot;power&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb65-3"><a href="declaredesign.html#cb65-3" tabindex="-1"></a>  <span class="fu">select</span>(effect_size_simple,<span class="at">power =</span> estimate) <span class="sc">%&gt;%</span></span>
<span id="cb65-4"><a href="declaredesign.html#cb65-4" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> effect_size_simple, <span class="at">y =</span> power)) <span class="sc">+</span></span>
<span id="cb65-5"><a href="declaredesign.html#cb65-5" tabindex="-1"></a>    <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb65-6"><a href="declaredesign.html#cb65-6" tabindex="-1"></a>    <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb65-7"><a href="declaredesign.html#cb65-7" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept=</span><span class="fl">0.8</span>,<span class="at">linetype=</span><span class="dv">2</span>) </span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-43-1.png" width="672" /></p>
<p>We can reliably detect an effect size between 150 and 200 kgs of fertilizer.
The mean fertilizer use is 70kg, so that seems unlikely to be realistic.
Perhaps we can increase power using a diff-in-diff design?</p>
</div>
</div>
<div id="dif-in-diff" class="section level2 hasAnchor">
<h2>Dif in diff<a href="declaredesign.html#dif-in-diff" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>We have one round of data,
so to analyze a diff in diff, we would have to simulate data.
The key reason why a diff in diff design would matter,
is because the outcomes are correlated between years,
which should reduce standard errors and increase power.</p>
<p>So first order of business is to figure out how we can generate values for
year 1 that are correlated to year 0,
by a coefficient that we can vary so we can investigate the properties of our design.</p>
<p>Here’s what I’ve got (so far), a function that takes a vector,
converts it to normal space, generates something correlated and maps it back:</p>
<div class="sourceCode" id="cb66"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb66-1"><a href="declaredesign.html#cb66-1" tabindex="-1"></a>correlate_var <span class="ot">&lt;-</span> <span class="cf">function</span>(x, rho) {</span>
<span id="cb66-2"><a href="declaredesign.html#cb66-2" tabindex="-1"></a></span>
<span id="cb66-3"><a href="declaredesign.html#cb66-3" tabindex="-1"></a>  n <span class="ot">&lt;-</span> <span class="fu">length</span>(x)</span>
<span id="cb66-4"><a href="declaredesign.html#cb66-4" tabindex="-1"></a></span>
<span id="cb66-5"><a href="declaredesign.html#cb66-5" tabindex="-1"></a>  <span class="co"># convert X to normal scores</span></span>
<span id="cb66-6"><a href="declaredesign.html#cb66-6" tabindex="-1"></a>  u  <span class="ot">&lt;-</span> <span class="fu">rank</span>(x) <span class="sc">/</span> (n <span class="sc">+</span> <span class="dv">1</span>)     <span class="co"># empirical CDF</span></span>
<span id="cb66-7"><a href="declaredesign.html#cb66-7" tabindex="-1"></a>  z1 <span class="ot">&lt;-</span> <span class="fu">qnorm</span>(u)              <span class="co"># normal scores</span></span>
<span id="cb66-8"><a href="declaredesign.html#cb66-8" tabindex="-1"></a></span>
<span id="cb66-9"><a href="declaredesign.html#cb66-9" tabindex="-1"></a>  <span class="co"># generate correlated normal</span></span>
<span id="cb66-10"><a href="declaredesign.html#cb66-10" tabindex="-1"></a>  z2 <span class="ot">&lt;-</span> rho <span class="sc">*</span> z1 <span class="sc">+</span> <span class="fu">sqrt</span>(<span class="dv">1</span> <span class="sc">-</span> rho<span class="sc">^</span><span class="dv">2</span>) <span class="sc">*</span> <span class="fu">rnorm</span>(n)</span>
<span id="cb66-11"><a href="declaredesign.html#cb66-11" tabindex="-1"></a></span>
<span id="cb66-12"><a href="declaredesign.html#cb66-12" tabindex="-1"></a>  <span class="co"># transform back</span></span>
<span id="cb66-13"><a href="declaredesign.html#cb66-13" tabindex="-1"></a>  u2 <span class="ot">&lt;-</span> <span class="fu">pnorm</span>(z2)</span>
<span id="cb66-14"><a href="declaredesign.html#cb66-14" tabindex="-1"></a></span>
<span id="cb66-15"><a href="declaredesign.html#cb66-15" tabindex="-1"></a>  <span class="co"># map onto original distribution</span></span>
<span id="cb66-16"><a href="declaredesign.html#cb66-16" tabindex="-1"></a>  x_sorted <span class="ot">&lt;-</span> <span class="fu">sort</span>(x)</span>
<span id="cb66-17"><a href="declaredesign.html#cb66-17" tabindex="-1"></a>  y <span class="ot">&lt;-</span> <span class="fu">quantile</span>(x_sorted, <span class="at">probs =</span> u2, <span class="at">type =</span> <span class="dv">8</span>)</span>
<span id="cb66-18"><a href="declaredesign.html#cb66-18" tabindex="-1"></a>  y</span>
<span id="cb66-19"><a href="declaredesign.html#cb66-19" tabindex="-1"></a>}</span></code></pre></div>
<p>I update my design accordingly, by generating the second year.
For that, I prefer to use <code>dplyr</code>,
but it should be possible with <code>fabricate()</code> as well.
I first rename all our time-variant varaible to have <code>_0</code> at the end,
create a correlated varaible with <code>_1</code> at the end, and then <code>pivot_longer</code>.</p>
<div class="sourceCode" id="cb67"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb67-1"><a href="declaredesign.html#cb67-1" tabindex="-1"></a>effect_size_dd <span class="ot">&lt;-</span> <span class="dv">70</span></span>
<span id="cb67-2"><a href="declaredesign.html#cb67-2" tabindex="-1"></a>sd_dd <span class="ot">&lt;-</span> <span class="dv">100</span></span>
<span id="cb67-3"><a href="declaredesign.html#cb67-3" tabindex="-1"></a>rho_dd <span class="ot">&lt;-</span> <span class="fl">0.7</span></span>
<span id="cb67-4"><a href="declaredesign.html#cb67-4" tabindex="-1"></a>model_dd <span class="ot">&lt;-</span> <span class="fu">declare_model</span>(</span>
<span id="cb67-5"><a href="declaredesign.html#cb67-5" tabindex="-1"></a></span>
<span id="cb67-6"><a href="declaredesign.html#cb67-6" tabindex="-1"></a>  rhomis <span class="sc">%&gt;%</span></span>
<span id="cb67-7"><a href="declaredesign.html#cb67-7" tabindex="-1"></a>    <span class="fu">select</span>(village, NFertInput) <span class="sc">%&gt;%</span></span>
<span id="cb67-8"><a href="declaredesign.html#cb67-8" tabindex="-1"></a>    <span class="co"># add one more year</span></span>
<span id="cb67-9"><a href="declaredesign.html#cb67-9" tabindex="-1"></a>    <span class="fu">rename_with</span>(<span class="sc">~</span> <span class="fu">paste0</span>(., <span class="st">&quot;_0&quot;</span>), <span class="sc">-</span>village) <span class="sc">%&gt;%</span></span>
<span id="cb67-10"><a href="declaredesign.html#cb67-10" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb67-11"><a href="declaredesign.html#cb67-11" tabindex="-1"></a>      <span class="at">NFertInput_1 =</span> <span class="fu">correlate_var</span>(NFertInput_0, rho_dd)</span>
<span id="cb67-12"><a href="declaredesign.html#cb67-12" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb67-13"><a href="declaredesign.html#cb67-13" tabindex="-1"></a>    <span class="fu">pivot_longer</span>(</span>
<span id="cb67-14"><a href="declaredesign.html#cb67-14" tabindex="-1"></a>      <span class="fu">ends_with</span>(<span class="fu">c</span>(<span class="st">&quot;_0&quot;</span>,<span class="st">&quot;_1&quot;</span>)), </span>
<span id="cb67-15"><a href="declaredesign.html#cb67-15" tabindex="-1"></a>      <span class="at">names_to =</span> <span class="fu">c</span>(<span class="st">&quot;.value&quot;</span>, <span class="st">&quot;t&quot;</span>),</span>
<span id="cb67-16"><a href="declaredesign.html#cb67-16" tabindex="-1"></a>      <span class="at">names_pattern =</span> <span class="st">&quot;(.*)_([0-9]+)$&quot;</span>,</span>
<span id="cb67-17"><a href="declaredesign.html#cb67-17" tabindex="-1"></a>      <span class="at">values_drop_na =</span> <span class="cn">TRUE</span>,</span>
<span id="cb67-18"><a href="declaredesign.html#cb67-18" tabindex="-1"></a>      <span class="at">names_transform =</span> <span class="fu">list</span>(<span class="at">t =</span> as.integer)</span>
<span id="cb67-19"><a href="declaredesign.html#cb67-19" tabindex="-1"></a>    ),</span>
<span id="cb67-20"><a href="declaredesign.html#cb67-20" tabindex="-1"></a>    <span class="fu">potential_outcomes</span>(Y <span class="sc">~</span> NFertInput <span class="sc">+</span> Z <span class="sc">*</span> effect_size_dd)</span>
<span id="cb67-21"><a href="declaredesign.html#cb67-21" tabindex="-1"></a></span>
<span id="cb67-22"><a href="declaredesign.html#cb67-22" tabindex="-1"></a></span>
<span id="cb67-23"><a href="declaredesign.html#cb67-23" tabindex="-1"></a>)</span></code></pre></div>
<p>I modify the inquiry and assignment to only take into account <code>t == 1</code></p>
<div class="sourceCode" id="cb68"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb68-1"><a href="declaredesign.html#cb68-1" tabindex="-1"></a>inquiry_dd <span class="ot">&lt;-</span>  </span>
<span id="cb68-2"><a href="declaredesign.html#cb68-2" tabindex="-1"></a>  <span class="fu">declare_inquiry</span>(<span class="at">ATE =</span> <span class="fu">mean</span>(Y_Z_1 <span class="sc">-</span> Y_Z_0), <span class="at">subset =</span> (t <span class="sc">==</span> <span class="dv">1</span>)) </span>
<span id="cb68-3"><a href="declaredesign.html#cb68-3" tabindex="-1"></a></span>
<span id="cb68-4"><a href="declaredesign.html#cb68-4" tabindex="-1"></a>assignment_dd <span class="ot">&lt;-</span></span>
<span id="cb68-5"><a href="declaredesign.html#cb68-5" tabindex="-1"></a>  <span class="fu">declare_assignment</span>(<span class="at">treatment_group =</span> <span class="fu">cluster_ra</span>(<span class="at">clusters =</span> village, <span class="at">prob =</span> <span class="fl">0.5</span>),</span>
<span id="cb68-6"><a href="declaredesign.html#cb68-6" tabindex="-1"></a>                     <span class="at">Z =</span> t <span class="sc">*</span> treatment_group)</span></code></pre></div>
<p>Measurement is unchanged:</p>
<div class="sourceCode" id="cb69"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb69-1"><a href="declaredesign.html#cb69-1" tabindex="-1"></a>measurement_dd <span class="ot">&lt;-</span> <span class="fu">declare_measurement</span>(</span>
<span id="cb69-2"><a href="declaredesign.html#cb69-2" tabindex="-1"></a>  <span class="at">Y =</span> <span class="fu">reveal_outcomes</span>(Y<span class="sc">~</span>Z)</span>
<span id="cb69-3"><a href="declaredesign.html#cb69-3" tabindex="-1"></a></span>
<span id="cb69-4"><a href="declaredesign.html#cb69-4" tabindex="-1"></a>)</span></code></pre></div>
<p>Then I use <a href="https://lrberge.github.io/fixest/reference/feols.html"><code>feols()</code></a>
from the <a href="https://lrberge.github.io/fixest/index.html">fixest</a>
package to estimate a Two-way fixed effects (2FE) model.
This can be easily extended to more complex
designs (<a href="https://doi.org/10.1017/pan.2020.33">but beware!</a>).</p>
<div class="sourceCode" id="cb70"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb70-1"><a href="declaredesign.html#cb70-1" tabindex="-1"></a><span class="fu">library</span>(fixest)</span>
<span id="cb70-2"><a href="declaredesign.html#cb70-2" tabindex="-1"></a><span class="fu">library</span>(broom)</span>
<span id="cb70-3"><a href="declaredesign.html#cb70-3" tabindex="-1"></a> </span>
<span id="cb70-4"><a href="declaredesign.html#cb70-4" tabindex="-1"></a>estimator_dd <span class="ot">&lt;-</span></span>
<span id="cb70-5"><a href="declaredesign.html#cb70-5" tabindex="-1"></a>  <span class="fu">declare_estimator</span>(Y <span class="sc">~</span> Z <span class="sc">|</span> treatment_group <span class="sc">+</span> t,</span>
<span id="cb70-6"><a href="declaredesign.html#cb70-6" tabindex="-1"></a>                    <span class="at">cluster =</span> <span class="st">&quot;village&quot;</span>,</span>
<span id="cb70-7"><a href="declaredesign.html#cb70-7" tabindex="-1"></a>                    <span class="at">.method =</span> feols, </span>
<span id="cb70-8"><a href="declaredesign.html#cb70-8" tabindex="-1"></a>                    <span class="at">term =</span> <span class="st">&quot;Z&quot;</span>, </span>
<span id="cb70-9"><a href="declaredesign.html#cb70-9" tabindex="-1"></a>                    <span class="at">inquiry =</span> <span class="st">&quot;ATE&quot;</span>, </span>
<span id="cb70-10"><a href="declaredesign.html#cb70-10" tabindex="-1"></a>                    <span class="at">label =</span> <span class="st">&quot;2FE&quot;</span>)</span></code></pre></div>
<p>The complete design is then:</p>
<div class="sourceCode" id="cb71"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb71-1"><a href="declaredesign.html#cb71-1" tabindex="-1"></a>design_dd <span class="ot">&lt;-</span> model_dd <span class="sc">+</span> assignment_dd <span class="sc">+</span> inquiry_dd <span class="sc">+</span> measurement_dd <span class="sc">+</span> estimator_dd</span></code></pre></div>
<p>Let’s have a look at our power now!
Of course, in a DiD setting, power depends not only on the effect size, but also on how well the years correlate.
I therefore also vary the <code>rho_dd</code> variable,
which controls the correlation between fertilizer input in years 0 and 1:</p>
<div class="sourceCode" id="cb72"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb72-1"><a href="declaredesign.html#cb72-1" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb72-2"><a href="declaredesign.html#cb72-2" tabindex="-1"></a>diagnosis_dd <span class="ot">&lt;-</span></span>
<span id="cb72-3"><a href="declaredesign.html#cb72-3" tabindex="-1"></a>  design_dd <span class="sc">%&gt;%</span></span>
<span id="cb72-4"><a href="declaredesign.html#cb72-4" tabindex="-1"></a>  <span class="fu">redesign</span>(</span>
<span id="cb72-5"><a href="declaredesign.html#cb72-5" tabindex="-1"></a>    <span class="at">effect_size_dd =</span> <span class="fu">c</span>(<span class="dv">100</span>, <span class="dv">150</span>, <span class="dv">200</span>),</span>
<span id="cb72-6"><a href="declaredesign.html#cb72-6" tabindex="-1"></a>    <span class="at">rho_dd =</span> <span class="fu">c</span>(<span class="fl">0.3</span>,<span class="fl">0.6</span>, <span class="fl">0.9</span>)</span>
<span id="cb72-7"><a href="declaredesign.html#cb72-7" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb72-8"><a href="declaredesign.html#cb72-8" tabindex="-1"></a>  <span class="fu">diagnose_design</span>(<span class="at">sims =</span> num_sims) <span class="sc">%&gt;%</span></span>
<span id="cb72-9"><a href="declaredesign.html#cb72-9" tabindex="-1"></a>  <span class="fu">tidy</span>() <span class="sc">%&gt;%</span></span>
<span id="cb72-10"><a href="declaredesign.html#cb72-10" tabindex="-1"></a>  <span class="fu">as_tibble</span>()</span></code></pre></div>
<p>Putting it in a plot again:</p>
<div class="sourceCode" id="cb73"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb73-1"><a href="declaredesign.html#cb73-1" tabindex="-1"></a>diagnosis_dd <span class="sc">%&gt;%</span></span>
<span id="cb73-2"><a href="declaredesign.html#cb73-2" tabindex="-1"></a>  <span class="fu">filter</span>(diagnosand <span class="sc">==</span> <span class="st">&quot;power&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb73-3"><a href="declaredesign.html#cb73-3" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">power =</span> estimate) <span class="sc">%&gt;%</span></span>
<span id="cb73-4"><a href="declaredesign.html#cb73-4" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">rho_dd =</span> <span class="fu">factor</span>(rho_dd)) <span class="sc">%&gt;%</span></span>
<span id="cb73-5"><a href="declaredesign.html#cb73-5" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> effect_size_dd, <span class="at">y =</span> power, <span class="at">color =</span> rho_dd, <span class="at">shape =</span> rho_dd)) <span class="sc">+</span></span>
<span id="cb73-6"><a href="declaredesign.html#cb73-6" tabindex="-1"></a>    <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb73-7"><a href="declaredesign.html#cb73-7" tabindex="-1"></a>    <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb73-8"><a href="declaredesign.html#cb73-8" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept=</span><span class="fl">0.8</span>, <span class="at">linetype=</span><span class="dv">2</span>) </span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-52-1.png" width="672" /></p>
<p>So at high levels of Rho, our power is slightly higher than when using the simple model.
The lower rho is, the less added value the diff-in-diff model has.
But honestly, I am suprised with how small the differences are.</p>
</div>
<div id="matching" class="section level2 hasAnchor">
<h2>Matching<a href="declaredesign.html#matching" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Finally, let’s imagine a scenario where treatment isn’t random,
but correlated to outcomes, so we would need matching.</p>
<p>Let’s also look at <code>food_secure</code>, since it’s binary, and thus adds a twist here and there.</p>
<p>Also, I will use the <code>resample_data()</code> function to pretend that we can visit
more households than are in my original data set.</p>
<div id="declare-design-1" class="section level3 hasAnchor">
<h3>Declare Design<a href="declaredesign.html#declare-design-1" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The first novel thing is the binary outcome.
We want an easy to interpret effect size:
a percentage point increase in food secure households.
This is a bit trickey: before we just added the effect size to everyone.
But for binary variables, we only change a 0 to a 1 for a certain share of the population.
Let’s just define that first.
The function below flips a certain number of 0s to 1, so that we have a nice effect size:</p>
<div class="sourceCode" id="cb74"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb74-1"><a href="declaredesign.html#cb74-1" tabindex="-1"></a>flip_zeroes <span class="ot">&lt;-</span> <span class="cf">function</span>(x, Z, effect) {</span>
<span id="cb74-2"><a href="declaredesign.html#cb74-2" tabindex="-1"></a></span>
<span id="cb74-3"><a href="declaredesign.html#cb74-3" tabindex="-1"></a>    <span class="co"># how many 1s do we currently have?</span></span>
<span id="cb74-4"><a href="declaredesign.html#cb74-4" tabindex="-1"></a>    n_current_ones <span class="ot">&lt;-</span> <span class="fu">sum</span>(x[Z <span class="sc">==</span> <span class="dv">1</span>])</span>
<span id="cb74-5"><a href="declaredesign.html#cb74-5" tabindex="-1"></a></span>
<span id="cb74-6"><a href="declaredesign.html#cb74-6" tabindex="-1"></a>    <span class="co"># how many 1s should we have?</span></span>
<span id="cb74-7"><a href="declaredesign.html#cb74-7" tabindex="-1"></a>    p_current <span class="ot">&lt;-</span> <span class="fu">mean</span>(x[Z <span class="sc">==</span> <span class="dv">1</span>])</span>
<span id="cb74-8"><a href="declaredesign.html#cb74-8" tabindex="-1"></a>    p_target  <span class="ot">&lt;-</span> p_current <span class="sc">+</span> effect</span>
<span id="cb74-9"><a href="declaredesign.html#cb74-9" tabindex="-1"></a>    n_target_ones  <span class="ot">&lt;-</span> <span class="fu">round</span>(p_target <span class="sc">*</span> <span class="fu">sum</span>(Z <span class="sc">==</span> <span class="dv">1</span>))</span>
<span id="cb74-10"><a href="declaredesign.html#cb74-10" tabindex="-1"></a>  </span>
<span id="cb74-11"><a href="declaredesign.html#cb74-11" tabindex="-1"></a>    <span class="co"># figure out which zeros to flip</span></span>
<span id="cb74-12"><a href="declaredesign.html#cb74-12" tabindex="-1"></a>    n_to_flip <span class="ot">&lt;-</span> n_target_ones <span class="sc">-</span> n_current_ones</span>
<span id="cb74-13"><a href="declaredesign.html#cb74-13" tabindex="-1"></a>    </span>
<span id="cb74-14"><a href="declaredesign.html#cb74-14" tabindex="-1"></a>    <span class="co"># If nothing to flip, return x</span></span>
<span id="cb74-15"><a href="declaredesign.html#cb74-15" tabindex="-1"></a>    <span class="cf">if</span> (n_to_flip <span class="sc">&lt;=</span> <span class="dv">0</span>) <span class="fu">return</span>(x)</span>
<span id="cb74-16"><a href="declaredesign.html#cb74-16" tabindex="-1"></a>    </span>
<span id="cb74-17"><a href="declaredesign.html#cb74-17" tabindex="-1"></a>    zeros_index <span class="ot">&lt;-</span> <span class="fu">which</span>(x[Z<span class="sc">==</span><span class="dv">1</span>] <span class="sc">==</span> <span class="dv">0</span>)</span>
<span id="cb74-18"><a href="declaredesign.html#cb74-18" tabindex="-1"></a>    </span>
<span id="cb74-19"><a href="declaredesign.html#cb74-19" tabindex="-1"></a>    <span class="co"># Can&#39;t flip more zeros than exist</span></span>
<span id="cb74-20"><a href="declaredesign.html#cb74-20" tabindex="-1"></a>    n_to_flip <span class="ot">&lt;-</span> <span class="fu">min</span>(n_to_flip, <span class="fu">length</span>(zeros_index))</span>
<span id="cb74-21"><a href="declaredesign.html#cb74-21" tabindex="-1"></a>    <span class="cf">if</span> (n_to_flip <span class="sc">==</span> <span class="dv">0</span>) <span class="fu">return</span>(x)</span>
<span id="cb74-22"><a href="declaredesign.html#cb74-22" tabindex="-1"></a>    </span>
<span id="cb74-23"><a href="declaredesign.html#cb74-23" tabindex="-1"></a>    flip_index <span class="ot">&lt;-</span> <span class="fu">sample</span>(zeros_index, n_to_flip)</span>
<span id="cb74-24"><a href="declaredesign.html#cb74-24" tabindex="-1"></a></span>
<span id="cb74-25"><a href="declaredesign.html#cb74-25" tabindex="-1"></a>    <span class="co"># do it, and return the new x</span></span>
<span id="cb74-26"><a href="declaredesign.html#cb74-26" tabindex="-1"></a>    x[Z<span class="sc">==</span><span class="dv">1</span>][flip_index] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb74-27"><a href="declaredesign.html#cb74-27" tabindex="-1"></a>    x</span>
<span id="cb74-28"><a href="declaredesign.html#cb74-28" tabindex="-1"></a>  }</span></code></pre></div>
<p>Our model then becomes:</p>
<div class="sourceCode" id="cb75"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb75-1"><a href="declaredesign.html#cb75-1" tabindex="-1"></a>model_matching <span class="ot">&lt;-</span> </span>
<span id="cb75-2"><a href="declaredesign.html#cb75-2" tabindex="-1"></a>  <span class="fu">declare_model</span>(</span>
<span id="cb75-3"><a href="declaredesign.html#cb75-3" tabindex="-1"></a>    rhomis</span>
<span id="cb75-4"><a href="declaredesign.html#cb75-4" tabindex="-1"></a>  )</span></code></pre></div>
<p>Then we do the assignment.
This now consists of two steps:</p>
<ul>
<li>Communities are assigned randomly, using <code>cluster_ra()</code></li>
<li>Households are assigned in a way that is correlated with education and livestock holdings,
(and also food_secure) using <code>correlate()</code>.</li>
</ul>
<div class="sourceCode" id="cb76"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb76-1"><a href="declaredesign.html#cb76-1" tabindex="-1"></a>rho <span class="ot">&lt;-</span> <span class="fl">0.5</span></span>
<span id="cb76-2"><a href="declaredesign.html#cb76-2" tabindex="-1"></a></span>
<span id="cb76-3"><a href="declaredesign.html#cb76-3" tabindex="-1"></a>assignment_matching <span class="ot">&lt;-</span> <span class="fu">declare_assignment</span>(</span>
<span id="cb76-4"><a href="declaredesign.html#cb76-4" tabindex="-1"></a>  <span class="at">hh_treat =</span> <span class="fu">correlate</span>(</span>
<span id="cb76-5"><a href="declaredesign.html#cb76-5" tabindex="-1"></a>    <span class="at">given =</span> educated <span class="sc">*</span> LivestockHoldings<span class="sc">^</span><span class="dv">2</span>,</span>
<span id="cb76-6"><a href="declaredesign.html#cb76-6" tabindex="-1"></a>    <span class="at">rho =</span> rho,</span>
<span id="cb76-7"><a href="declaredesign.html#cb76-7" tabindex="-1"></a>    draw_binomial,</span>
<span id="cb76-8"><a href="declaredesign.html#cb76-8" tabindex="-1"></a>    <span class="at">prob =</span> <span class="fl">0.3</span></span>
<span id="cb76-9"><a href="declaredesign.html#cb76-9" tabindex="-1"></a>  ), </span>
<span id="cb76-10"><a href="declaredesign.html#cb76-10" tabindex="-1"></a>  <span class="at">vill_treat =</span> <span class="fu">cluster_ra</span>(<span class="at">clusters =</span> village, <span class="at">prob =</span> <span class="fl">0.5</span>), </span>
<span id="cb76-11"><a href="declaredesign.html#cb76-11" tabindex="-1"></a>  <span class="at">Z =</span> hh_treat <span class="sc">*</span> vill_treat</span>
<span id="cb76-12"><a href="declaredesign.html#cb76-12" tabindex="-1"></a>)</span></code></pre></div>
<p>Then we take an extra step: re-sampling.</p>
<p>Some notes:</p>
<ul>
<li>We use <code>resample_data()</code> to sample more households than are in our original data set.
The resulting data set will thus follow the same distribution as our original data,
but with more observations.</li>
<li>In treatment communities, we only sample from treated households.
In control communities, we don’t know who would have been treated,
so we sample randomly.</li>
<li>We sample a certain number of households per community,
which is a parameter we can vary in our diagnosis.
The number differs between treatment and control communities,
to allow oversampling the control observation to compensate for matching losses.
To do this, we run the <code>resample_data()</code> function separately for treatment and control communities,
using a combination of nest and map2 functions
(see <a href="https://jennybc.github.io/purrr-tutorial/ls12_different-sized-samples.html">here</a>).</li>
</ul>
<div class="sourceCode" id="cb77"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb77-1"><a href="declaredesign.html#cb77-1" tabindex="-1"></a>communities_per_arm <span class="ot">&lt;-</span> <span class="dv">10</span></span>
<span id="cb77-2"><a href="declaredesign.html#cb77-2" tabindex="-1"></a>respondents_treat <span class="ot">&lt;-</span> <span class="dv">10</span></span>
<span id="cb77-3"><a href="declaredesign.html#cb77-3" tabindex="-1"></a>respondents_control <span class="ot">&lt;-</span> <span class="dv">15</span></span>
<span id="cb77-4"><a href="declaredesign.html#cb77-4" tabindex="-1"></a></span>
<span id="cb77-5"><a href="declaredesign.html#cb77-5" tabindex="-1"></a>resample_hhs  <span class="ot">&lt;-</span> <span class="cf">function</span>(df, communities_per_arm, respondents_treat, respondents_control){</span>
<span id="cb77-6"><a href="declaredesign.html#cb77-6" tabindex="-1"></a>  df <span class="sc">%&gt;%</span> </span>
<span id="cb77-7"><a href="declaredesign.html#cb77-7" tabindex="-1"></a>    <span class="fu">filter</span>(vill_treat <span class="sc">==</span> <span class="dv">0</span> <span class="sc">|</span> Z <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb77-8"><a href="declaredesign.html#cb77-8" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">respondents =</span> <span class="fu">if_else</span>(Z <span class="sc">==</span> <span class="dv">1</span>, respondents_treat, respondents_control)) <span class="sc">%&gt;%</span></span>
<span id="cb77-9"><a href="declaredesign.html#cb77-9" tabindex="-1"></a>    <span class="fu">nest</span>(<span class="at">.by =</span> <span class="fu">c</span>(Z, respondents)) <span class="sc">%&gt;%</span></span>
<span id="cb77-10"><a href="declaredesign.html#cb77-10" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb77-11"><a href="declaredesign.html#cb77-11" tabindex="-1"></a>      <span class="at">data =</span> <span class="fu">map2</span>(</span>
<span id="cb77-12"><a href="declaredesign.html#cb77-12" tabindex="-1"></a>        data, </span>
<span id="cb77-13"><a href="declaredesign.html#cb77-13" tabindex="-1"></a>        respondents, </span>
<span id="cb77-14"><a href="declaredesign.html#cb77-14" tabindex="-1"></a>        <span class="sc">~</span><span class="fu">resample_data</span>(</span>
<span id="cb77-15"><a href="declaredesign.html#cb77-15" tabindex="-1"></a>          .x, </span>
<span id="cb77-16"><a href="declaredesign.html#cb77-16" tabindex="-1"></a>          <span class="at">N =</span> <span class="fu">c</span>(communities_per_arm,.y), </span>
<span id="cb77-17"><a href="declaredesign.html#cb77-17" tabindex="-1"></a>          <span class="at">ID_labels =</span> <span class="fu">c</span>(<span class="st">&quot;village&quot;</span>, <span class="st">&quot;hh&quot;</span>),</span>
<span id="cb77-18"><a href="declaredesign.html#cb77-18" tabindex="-1"></a>          <span class="at">unique_labels =</span> <span class="cn">TRUE</span></span>
<span id="cb77-19"><a href="declaredesign.html#cb77-19" tabindex="-1"></a>        )</span>
<span id="cb77-20"><a href="declaredesign.html#cb77-20" tabindex="-1"></a>      )</span>
<span id="cb77-21"><a href="declaredesign.html#cb77-21" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb77-22"><a href="declaredesign.html#cb77-22" tabindex="-1"></a>  <span class="fu">unnest</span>(data) </span>
<span id="cb77-23"><a href="declaredesign.html#cb77-23" tabindex="-1"></a>}</span>
<span id="cb77-24"><a href="declaredesign.html#cb77-24" tabindex="-1"></a></span>
<span id="cb77-25"><a href="declaredesign.html#cb77-25" tabindex="-1"></a>resampling_matching <span class="ot">&lt;-</span> <span class="fu">declare_step</span>(</span>
<span id="cb77-26"><a href="declaredesign.html#cb77-26" tabindex="-1"></a>  <span class="at">handler =</span> resample_hhs,</span>
<span id="cb77-27"><a href="declaredesign.html#cb77-27" tabindex="-1"></a>  <span class="at">communities_per_arm =</span> communities_per_arm,</span>
<span id="cb77-28"><a href="declaredesign.html#cb77-28" tabindex="-1"></a>  <span class="at">respondents_treat =</span> respondents_treat,</span>
<span id="cb77-29"><a href="declaredesign.html#cb77-29" tabindex="-1"></a>  <span class="at">respondents_control =</span> respondents_control</span>
<span id="cb77-30"><a href="declaredesign.html#cb77-30" tabindex="-1"></a>)</span></code></pre></div>
<p>Measurement and inquiry are slightly different.
I defined my treatment effects as a percentage point increase in food secure households.
So if the percentage of food insecure households is very large relative to the effect size,
the chance an individual household become food insecure is low.
This messes with potential outcomes,
as the effect on each individal depends on the means in the treatment group,
and thus on the randomization.
I therefore skip the potential outcomes,
and just define my estimand as the effect size.</p>
<div class="sourceCode" id="cb78"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb78-1"><a href="declaredesign.html#cb78-1" tabindex="-1"></a>effect_size_matching <span class="ot">&lt;-</span> <span class="fl">0.1</span></span>
<span id="cb78-2"><a href="declaredesign.html#cb78-2" tabindex="-1"></a></span>
<span id="cb78-3"><a href="declaredesign.html#cb78-3" tabindex="-1"></a>measurement_matching <span class="ot">&lt;-</span></span>
<span id="cb78-4"><a href="declaredesign.html#cb78-4" tabindex="-1"></a> <span class="fu">declare_measurement</span>(</span>
<span id="cb78-5"><a href="declaredesign.html#cb78-5" tabindex="-1"></a>  <span class="at">Y =</span> <span class="fu">flip_zeroes</span>(food_secure, Z, effect_size_matching)</span>
<span id="cb78-6"><a href="declaredesign.html#cb78-6" tabindex="-1"></a>)</span>
<span id="cb78-7"><a href="declaredesign.html#cb78-7" tabindex="-1"></a></span>
<span id="cb78-8"><a href="declaredesign.html#cb78-8" tabindex="-1"></a>inquiry_matching <span class="ot">&lt;-</span> <span class="fu">declare_inquiry</span>(<span class="at">ATE =</span> effect_size_matching)</span></code></pre></div>
<p>Now for the estimators, let’s start with a simple one, with no matching:</p>
<div class="sourceCode" id="cb79"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb79-1"><a href="declaredesign.html#cb79-1" tabindex="-1"></a>estimator_matching_no_matching <span class="ot">&lt;-</span> </span>
<span id="cb79-2"><a href="declaredesign.html#cb79-2" tabindex="-1"></a>  <span class="fu">declare_estimator</span>(Y <span class="sc">~</span> Z, </span>
<span id="cb79-3"><a href="declaredesign.html#cb79-3" tabindex="-1"></a>                    <span class="at">inquiry =</span> <span class="st">&quot;ATE&quot;</span>, </span>
<span id="cb79-4"><a href="declaredesign.html#cb79-4" tabindex="-1"></a>                    <span class="at">term =</span> <span class="st">&quot;Z&quot;</span>, </span>
<span id="cb79-5"><a href="declaredesign.html#cb79-5" tabindex="-1"></a>                    <span class="at">label =</span> <span class="st">&quot;Not matched&quot;</span>,</span>
<span id="cb79-6"><a href="declaredesign.html#cb79-6" tabindex="-1"></a>                    <span class="at">cluster=</span> village_unique)</span></code></pre></div>
<p>Finally, I need to somehow put my matching model in DeclareDesign.
Fortunately, you can put any the output of any function into the <code>declare_estimator()</code> function
using the <code>handler</code> argument.
It does need to accept a <code>data</code> argument,
and output a <a href="https://broom.tidymodels.org/articles/broom.html"><code>tidy()</code></a> dataframe.</p>
<p>My function <code>custom_match()</code> accepts a data frame, uses <code>MatchIt</code> to create
a matched data set,
I define a function that does that, and some labelling:</p>
<div class="sourceCode" id="cb80"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb80-1"><a href="declaredesign.html#cb80-1" tabindex="-1"></a><span class="co"># the select function would conflict with dplyr</span></span>
<span id="cb80-2"><a href="declaredesign.html#cb80-2" tabindex="-1"></a><span class="co"># this syntax requires R 4.0 or higher</span></span>
<span id="cb80-3"><a href="declaredesign.html#cb80-3" tabindex="-1"></a></span>
<span id="cb80-4"><a href="declaredesign.html#cb80-4" tabindex="-1"></a><span class="fu">library</span>(MatchIt, <span class="fu">exclude</span>(<span class="st">&quot;select&quot;</span>))</span>
<span id="cb80-5"><a href="declaredesign.html#cb80-5" tabindex="-1"></a></span>
<span id="cb80-6"><a href="declaredesign.html#cb80-6" tabindex="-1"></a></span>
<span id="cb80-7"><a href="declaredesign.html#cb80-7" tabindex="-1"></a>custom_match <span class="ot">&lt;-</span> <span class="cf">function</span>(data,</span>
<span id="cb80-8"><a href="declaredesign.html#cb80-8" tabindex="-1"></a>                         equation,</span>
<span id="cb80-9"><a href="declaredesign.html#cb80-9" tabindex="-1"></a>                         <span class="at">outcome =</span> <span class="st">&quot;Y&quot;</span>, </span>
<span id="cb80-10"><a href="declaredesign.html#cb80-10" tabindex="-1"></a>                         <span class="at">term =</span> <span class="st">&quot;Z&quot;</span>, </span>
<span id="cb80-11"><a href="declaredesign.html#cb80-11" tabindex="-1"></a>                         <span class="at">method =</span> <span class="st">&quot;nearest&quot;</span>){</span>
<span id="cb80-12"><a href="declaredesign.html#cb80-12" tabindex="-1"></a></span>
<span id="cb80-13"><a href="declaredesign.html#cb80-13" tabindex="-1"></a>  <span class="co"># the command filter(term == term) wouldn&#39;t do anything, so this is a workaround</span></span>
<span id="cb80-14"><a href="declaredesign.html#cb80-14" tabindex="-1"></a>  term_value <span class="ot">&lt;-</span> term</span>
<span id="cb80-15"><a href="declaredesign.html#cb80-15" tabindex="-1"></a></span>
<span id="cb80-16"><a href="declaredesign.html#cb80-16" tabindex="-1"></a>  <span class="co"># run the matching model</span></span>
<span id="cb80-17"><a href="declaredesign.html#cb80-17" tabindex="-1"></a>  matchit_model <span class="ot">&lt;-</span> <span class="fu">matchit</span>(equation,</span>
<span id="cb80-18"><a href="declaredesign.html#cb80-18" tabindex="-1"></a>                          <span class="at">data =</span> data,</span>
<span id="cb80-19"><a href="declaredesign.html#cb80-19" tabindex="-1"></a>                         <span class="at">method =</span> method)</span>
<span id="cb80-20"><a href="declaredesign.html#cb80-20" tabindex="-1"></a>  matched_df <span class="ot">&lt;-</span> <span class="fu">match.data</span>(matchit_model)</span>
<span id="cb80-21"><a href="declaredesign.html#cb80-21" tabindex="-1"></a></span>
<span id="cb80-22"><a href="declaredesign.html#cb80-22" tabindex="-1"></a>  <span class="co"># run a regression, weighted by the propensity score</span></span>
<span id="cb80-23"><a href="declaredesign.html#cb80-23" tabindex="-1"></a>  <span class="fu">lm_robust</span>(Y <span class="sc">~</span> Z, <span class="at">data =</span> matched_df, <span class="at">weights =</span> weights, <span class="at">clusters =</span> village_unique) <span class="sc">%&gt;%</span></span>
<span id="cb80-24"><a href="declaredesign.html#cb80-24" tabindex="-1"></a>    <span class="fu">tidy</span>() <span class="sc">%&gt;%</span></span>
<span id="cb80-25"><a href="declaredesign.html#cb80-25" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">outcome =</span> outcome) <span class="sc">%&gt;%</span></span>
<span id="cb80-26"><a href="declaredesign.html#cb80-26" tabindex="-1"></a>    <span class="fu">filter</span>(term <span class="sc">==</span> term_value)</span>
<span id="cb80-27"><a href="declaredesign.html#cb80-27" tabindex="-1"></a>}</span></code></pre></div>
<p>Then I add two estimator: one that uses PSM (‘nearest’) and one that uses CEM (‘cem’),
so that we can compare these two matching methods in our diagnosis.</p>
<div class="sourceCode" id="cb81"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb81-1"><a href="declaredesign.html#cb81-1" tabindex="-1"></a>estimator_matching_psm <span class="ot">&lt;-</span> <span class="fu">declare_estimator</span>(</span>
<span id="cb81-2"><a href="declaredesign.html#cb81-2" tabindex="-1"></a>  Z <span class="sc">~</span> educated <span class="sc">+</span> LivestockHoldings,</span>
<span id="cb81-3"><a href="declaredesign.html#cb81-3" tabindex="-1"></a>  <span class="at">handler =</span> <span class="fu">label_estimator</span>(custom_match),</span>
<span id="cb81-4"><a href="declaredesign.html#cb81-4" tabindex="-1"></a>  <span class="at">inquiry =</span> <span class="st">&quot;ATE&quot;</span>,  <span class="co"># Tie the estimator to the declared inquiry</span></span>
<span id="cb81-5"><a href="declaredesign.html#cb81-5" tabindex="-1"></a>  <span class="at">label =</span> <span class="st">&quot;Matched PSM&quot;</span>,</span>
<span id="cb81-6"><a href="declaredesign.html#cb81-6" tabindex="-1"></a>  <span class="at">term =</span> <span class="st">&quot;Z&quot;</span>,</span>
<span id="cb81-7"><a href="declaredesign.html#cb81-7" tabindex="-1"></a>)</span>
<span id="cb81-8"><a href="declaredesign.html#cb81-8" tabindex="-1"></a></span>
<span id="cb81-9"><a href="declaredesign.html#cb81-9" tabindex="-1"></a>estimator_matching_cem <span class="ot">&lt;-</span> <span class="fu">declare_estimator</span>(</span>
<span id="cb81-10"><a href="declaredesign.html#cb81-10" tabindex="-1"></a>  Z <span class="sc">~</span> educated <span class="sc">+</span> LivestockHoldings,</span>
<span id="cb81-11"><a href="declaredesign.html#cb81-11" tabindex="-1"></a>  <span class="at">handler =</span> <span class="fu">label_estimator</span>(custom_match),</span>
<span id="cb81-12"><a href="declaredesign.html#cb81-12" tabindex="-1"></a>  <span class="at">inquiry =</span> <span class="st">&quot;ATE&quot;</span>,  <span class="co"># Tie the estimator to the declared inquiry</span></span>
<span id="cb81-13"><a href="declaredesign.html#cb81-13" tabindex="-1"></a>  <span class="at">label =</span> <span class="st">&quot;Matched CEM&quot;</span>,</span>
<span id="cb81-14"><a href="declaredesign.html#cb81-14" tabindex="-1"></a>  <span class="at">term =</span> <span class="st">&quot;Z&quot;</span>,</span>
<span id="cb81-15"><a href="declaredesign.html#cb81-15" tabindex="-1"></a>  <span class="at">method =</span> <span class="st">&quot;cem&quot;</span></span>
<span id="cb81-16"><a href="declaredesign.html#cb81-16" tabindex="-1"></a>)</span></code></pre></div>
<p>And let’s combine it into one design!</p>
<div class="sourceCode" id="cb82"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb82-1"><a href="declaredesign.html#cb82-1" tabindex="-1"></a>design_matching  <span class="ot">&lt;-</span></span>
<span id="cb82-2"><a href="declaredesign.html#cb82-2" tabindex="-1"></a>  model_matching <span class="sc">+</span>  assignment_matching <span class="sc">+</span>  resampling_matching <span class="sc">+</span> measurement_matching <span class="sc">+</span> </span>
<span id="cb82-3"><a href="declaredesign.html#cb82-3" tabindex="-1"></a>  inquiry_matching <span class="sc">+</span> </span>
<span id="cb82-4"><a href="declaredesign.html#cb82-4" tabindex="-1"></a>  estimator_matching_no_matching <span class="sc">+</span> estimator_matching_psm <span class="sc">+</span> estimator_matching_cem</span></code></pre></div>
<p>Note that to explore this design and fine tune matching procedures,
it may be useful to run <code>draw_data()</code> a few times.</p>
</div>
<div id="bias" class="section level3 hasAnchor">
<h3>Bias<a href="declaredesign.html#bias" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>First, let’s examine bias, given selection effects.
The strength of the selection effect is given by <code>rho</code>,
so I use <code>redesign()</code> to vary it:</p>
<div class="sourceCode" id="cb83"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb83-1"><a href="declaredesign.html#cb83-1" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb83-2"><a href="declaredesign.html#cb83-2" tabindex="-1"></a>diagnosis_matching_bias <span class="ot">&lt;-</span></span>
<span id="cb83-3"><a href="declaredesign.html#cb83-3" tabindex="-1"></a>  design_matching <span class="sc">%&gt;%</span></span>
<span id="cb83-4"><a href="declaredesign.html#cb83-4" tabindex="-1"></a>  <span class="fu">redesign</span>(<span class="at">rho =</span> <span class="fu">seq</span>(<span class="at">from =</span> <span class="dv">0</span>, <span class="at">to =</span> <span class="fl">0.75</span>, <span class="at">by =</span> <span class="fl">0.25</span>))  <span class="sc">%&gt;%</span></span>
<span id="cb83-5"><a href="declaredesign.html#cb83-5" tabindex="-1"></a>  <span class="fu">diagnose_design</span>(<span class="at">sims =</span> num_sims) <span class="sc">%&gt;%</span></span>
<span id="cb83-6"><a href="declaredesign.html#cb83-6" tabindex="-1"></a>  <span class="fu">tidy</span>() <span class="sc">%&gt;%</span></span>
<span id="cb83-7"><a href="declaredesign.html#cb83-7" tabindex="-1"></a>  <span class="fu">as_tibble</span>()</span></code></pre></div>
<p>And I put the result in a plot:</p>
<div class="sourceCode" id="cb84"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb84-1"><a href="declaredesign.html#cb84-1" tabindex="-1"></a>diagnosis_matching_bias <span class="sc">%&gt;%</span></span>
<span id="cb84-2"><a href="declaredesign.html#cb84-2" tabindex="-1"></a>  <span class="fu">filter</span>(diagnosand <span class="sc">==</span> <span class="st">&quot;bias&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb84-3"><a href="declaredesign.html#cb84-3" tabindex="-1"></a>  <span class="fu">select</span>(rho, <span class="at">bias =</span> estimate, estimator) <span class="sc">%&gt;%</span></span>
<span id="cb84-4"><a href="declaredesign.html#cb84-4" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> rho, <span class="at">y =</span> bias, </span>
<span id="cb84-5"><a href="declaredesign.html#cb84-5" tabindex="-1"></a>             <span class="at">shape =</span> estimator, <span class="at">color=</span>estimator)) <span class="sc">+</span></span>
<span id="cb84-6"><a href="declaredesign.html#cb84-6" tabindex="-1"></a>    <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb84-7"><a href="declaredesign.html#cb84-7" tabindex="-1"></a>    <span class="fu">geom_point</span>() </span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-64-1.png" width="672" /></p>
<p>It’s clear that while PSM reduced bias, but CEM performed much better.</p>
</div>
<div id="power" class="section level3 hasAnchor">
<h3>Power<a href="declaredesign.html#power" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Then, let’s examine power.
I drop the no matching a psm, to save some simulation time.</p>
<div class="sourceCode" id="cb85"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb85-1"><a href="declaredesign.html#cb85-1" tabindex="-1"></a>design_cem  <span class="ot">&lt;-</span></span>
<span id="cb85-2"><a href="declaredesign.html#cb85-2" tabindex="-1"></a>  model_matching <span class="sc">+</span>  assignment_matching <span class="sc">+</span>  resampling_matching <span class="sc">+</span> measurement_matching <span class="sc">+</span> </span>
<span id="cb85-3"><a href="declaredesign.html#cb85-3" tabindex="-1"></a>  inquiry_matching <span class="sc">+</span> </span>
<span id="cb85-4"><a href="declaredesign.html#cb85-4" tabindex="-1"></a>  estimator_matching_cem</span>
<span id="cb85-5"><a href="declaredesign.html#cb85-5" tabindex="-1"></a></span>
<span id="cb85-6"><a href="declaredesign.html#cb85-6" tabindex="-1"></a></span>
<span id="cb85-7"><a href="declaredesign.html#cb85-7" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb85-8"><a href="declaredesign.html#cb85-8" tabindex="-1"></a>diagnosis_matched_power <span class="ot">&lt;-</span></span>
<span id="cb85-9"><a href="declaredesign.html#cb85-9" tabindex="-1"></a>  design_cem <span class="sc">%&gt;%</span></span>
<span id="cb85-10"><a href="declaredesign.html#cb85-10" tabindex="-1"></a>  <span class="fu">redesign</span>(</span>
<span id="cb85-11"><a href="declaredesign.html#cb85-11" tabindex="-1"></a>    <span class="at">communities_per_arm =</span> <span class="fu">c</span>(<span class="dv">5</span>,<span class="dv">30</span>,<span class="dv">50</span>),</span>
<span id="cb85-12"><a href="declaredesign.html#cb85-12" tabindex="-1"></a>    <span class="at">effect_size_matching =</span> <span class="fu">c</span>(<span class="fl">0.01</span>,<span class="fl">0.2</span>, <span class="fl">0.3</span>)</span>
<span id="cb85-13"><a href="declaredesign.html#cb85-13" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb85-14"><a href="declaredesign.html#cb85-14" tabindex="-1"></a>  <span class="fu">diagnose_design</span>(<span class="at">sims =</span> num_sims) <span class="sc">%&gt;%</span></span>
<span id="cb85-15"><a href="declaredesign.html#cb85-15" tabindex="-1"></a>  <span class="fu">tidy</span>() <span class="sc">%&gt;%</span></span>
<span id="cb85-16"><a href="declaredesign.html#cb85-16" tabindex="-1"></a>  <span class="fu">as_tibble</span>()</span></code></pre></div>
<p>So at 30 communities per arm,
our design can pick up an effect of 0.3,
but to pick up an effect of 0.2 we should ideally increase our sample.</p>
<div class="sourceCode" id="cb86"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb86-1"><a href="declaredesign.html#cb86-1" tabindex="-1"></a>diagnosis_matched_power <span class="sc">%&gt;%</span> </span>
<span id="cb86-2"><a href="declaredesign.html#cb86-2" tabindex="-1"></a>  <span class="fu">filter</span>(diagnosand <span class="sc">==</span> <span class="st">&quot;power&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb86-3"><a href="declaredesign.html#cb86-3" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">effect_size_matching =</span> <span class="fu">factor</span>(effect_size_matching)) <span class="sc">%&gt;%</span></span>
<span id="cb86-4"><a href="declaredesign.html#cb86-4" tabindex="-1"></a>  <span class="fu">select</span>(communities_per_arm, <span class="at">power =</span> estimate, estimator, effect_size_matching) <span class="sc">%&gt;%</span></span>
<span id="cb86-5"><a href="declaredesign.html#cb86-5" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> communities_per_arm, <span class="at">y =</span> power, </span>
<span id="cb86-6"><a href="declaredesign.html#cb86-6" tabindex="-1"></a>             <span class="at">shape =</span> effect_size_matching, <span class="at">color=</span>effect_size_matching)) <span class="sc">+</span></span>
<span id="cb86-7"><a href="declaredesign.html#cb86-7" tabindex="-1"></a>    <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb86-8"><a href="declaredesign.html#cb86-8" tabindex="-1"></a>    <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb86-9"><a href="declaredesign.html#cb86-9" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept=</span><span class="fl">0.8</span>,<span class="at">linetype=</span><span class="dv">2</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-67-1.png" width="672" /></p>

</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="programming.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="datawrangling.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
  "sharing": {
    "github": false,
    "facebook": false,
    "twitter": false,
    "linkedin": false,
    "weibo": false,
    "instapaper": false,
    "vk": false,
    "whatsapp": false,
    "all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
  },
  "fontsettings": {
    "theme": "white",
    "family": "sans",
    "size": 2
  },
  "edit": {
    "link": "https://github.com/kleuveld/r_cheatsheet/edit/main/chapters/03-declaredesign.Rmd",
    "text": "Edit"
  },
  "history": {
    "link": null,
    "text": null
  },
  "view": {
    "link": null,
    "text": null
  },
  "download": null,
  "search": {
    "engine": "fuse",
    "options": null
  },
  "toc": {
    "collapse": "section"
  }
});
});
</script>

</body>

</html>
