[["index.html", "Reproducible and reusable social science with R: a field guide Introduction About Setting up", " Reproducible and reusable social science with R: a field guide Koen 2026-02-19 Introduction About This website is intended as a quick reference for some techniques that I think people may need to keep their code reproducible when cleaning, analyzing, or presenting data. For a more basic intro to R try the R for Social Science Data Carpentry Workshop , on which some of this website is based. The site covers advice on workflows, general R techniques such as loops and functions that facilitate reproducibility. Then the following chapters each cover a part of the research cycle: design, data cleaning and data analysis (including reporting the results). For each, there’s specific code examples using survey data. Setting up This book uses the SAFI data set, and a large number of libraries. Everything is available on github, and cloning that repo will ensure you can install all packages through renv (see Chapter 1). Throughout this book, I will mostly make use of tidyverse packages. While there are alternatives that have advantages of this, such as data.table which is faster, tidyverse makes easily readable code, which is imortant from a reproducibility perspective. Moreover, we are not so concerned with performance, since household survey datasets are almost never large enough for that matter. "],["reproducible-workflows.html", "1. Reproducible Workflows Introduction Projects renv", " 1. Reproducible Workflows Introduction The most important aspect of reproducibility is not the R code itself, but the way you organize your work. To be reproducible, your work should be organized in such a way that it easily transfers from you to a collaborator, and from one machine to another. This helps you, because if you need to come back to your own code on a new device (potentially years after initially working on it), you can easily get it running again. It also helps your co-workers, as they can easily use your code. It also helps research integrity, as you can easily show how you got your results. In fact, this website was made using these principles: you can download the all code from github and run it on your own machine. Do note that there is an up-front cost in setting up such workflows, so plan for that, making sure all collaborators are on-board with how you approach the organization of your code and data. This chapter discusses two R-specific aspects of reproducible workflows: projects and the renv package. I also recommend using git, but that goes beyond the scope of this cookbook. Projects Oftentimes, you will see R scripts start with setwd(). This means the script is no longer reproducible, as it relies on the exact folder structure of the machine the script was written on. A better practice is to adopt a project-oriented workflow. In the words of Jenny Bryan: I suggest organizing each data analysis into a project: a folder on your computer that holds all the files relevant to that particular piece of work. I’m not assuming this is an RStudio Project, though this is a nice implementation discussed below. Any resident R script is written assuming that it will be run from a fresh R process with working directory set to the project directory. It creates everything it needs, in its own workspace or folder, and it touches nothing it did not create. For example, it does not install additional packages (another pet peeve of mine). This convention guarantees that the project can be moved around on your computer or onto other computers and will still “just work” How to exactly implement this depends on your editor of choice, but most will support some form of project-oriented workflow. RStudio, VSCode and Sublime Text all have built-in support for projects. And though they may differ in details, they all have in common that when you open a project, the working directory is properly set to the project’s root folder,, and you’re working with a clean R environment unaffected by whatever other thing you were doing in R just before you switched to work on your current project. As long as you make sure that all scripts and data are in subfolders of your project, you can reference files using relative paths, i.e. paths that start from the project root folder. These relative paths will work on any machine. Here Whether you use RStudio projects VS Code, VIM, Sublime Text, or some custom solution, the here package, makes referencing files in a project just a little bit easier. Any time you include library(here) in a script, it will start looking for the project root folder of the project. This is either the .RProj file, a .git folder for if you use git, or some other file you specify. here will start looking at the current working folder (usually the folder containing the file you just opened), then if it can’t find the file, recursively looks in the parent folder until it’s found. You can then reference files using here(\"path/to\",\"yourfile\"). This path will work wherever you move your file, which is especially useful for RMarkdown files, which tend to ignore your project root folder. Using machine-specific paths Sometimes, you may want to be able to reference files outside your project. This is not great from a project workflow point of view, but sometimes it can’t be helped. For example, your project lives on git, but you need a file from your Teams environment (research data is not supposed to be on git). The bad way to solve this is to hardcode the path to your teams folder in your script. This will mean your collaborators (and you, if you change devices) may not be able to use the script, even if they have access to Teams. To get around this, you can use the .Renviron file, which could be located in your home directory (c:\\users\\%username% on windows) or in your project root folder (if using the project root folder, make sure there’s a way to not sync it with other machines, which git allows), and in it put the following: TEAMS = &quot;C:/path/to/teams&quot; This sets an environment variable called teams if you load your project. Access the variable using Sys.getenv(\"TEAMS\"): teams_path &lt;- Sys.getenv(&quot;TEAMS&quot;) This way, you can just use teams_path wherever you had wanted to use the path to teams, and it should work for anyone, regardless of the exact path to their teams folder. This does take a little coordination, as you should make sure everyone has a .Renviron set. renv The power of R lies in the many packages that are available. However, here also lies a risk: there’s no guarantee packages keep working the way they work now, meaning that any update may break your work. However, you shouldn’t stay at an old version of a package for all your work, just so that one old project of yours will keep working. What if you want to collaborate with someone using a newer version of that package? [renv](https://rstudio.github.io/renv/) gets around this by instead of having a global package library, it has a project-specific project-library. So different projects can use different versions of the same package, without interfering with each other. NB: renv only really works with collaborators if you use some form of version control like git. Something like onedrive, teams or dropbox is difficult, as some folders created by renv should not be shared with co-workers. I am sure there is work-around for this, but since git is so great anyway, I haven’t bothered looking. Starting a project with Renv In RStudio, just tick the box “use renv” when creating a new project. Otherwise, type renv::init(). This will create: The lock file renv.lock, which logs all the packages and their versions. The renv folder, which contains the project package library. Installing new packages with Renv When starting a new project, that project’s library will be empty, so you’ll have to reinstall all packages, just by using install.packages(). Fortunately, renv keeps a global cache of the packages you use across all your projects, so any packages that you already have will install very quickly. After installing the packages, use renv::snapshot() to make sure that all packages are in the lockfile. You should then commit this snapshot to git, so your co-workers can easily update their own packages. Restoring a project If you join an existing project, or copy a project you were working on to a new device, you simply type renv::restore() after opening the project to install all packages listed in the lockfile. That’s it! You now the exact same packages as your co-workers! "],["programming.html", "2. Programming with R Loops Functions Map() Other variants of map() Making functions re-usable with box", " 2. Programming with R Before diving into specific R techniques about managing social science research, this chapter will cover some general programming concepts that will help you make your R code more reusable. These techniques help you move away from the specifics of your data, and make generalizable solutions that you can then reapply to other data sets. This also prevents mistakes, where you copy-paste code and fail to make the necessary changes. But perhaps most importantly, it saves you time: these concepts allow you to do a lot of work with just a few simple building blocks of code. This chapter will cover ways to iterate code (using either loops or the map() function), functions (which will let you easily reuse code snippets you often need), and making code more reusable with the box package. Loops Loops are a fundamental programming concept that allow you to repeat code multiple times without duplicating it. In R, a loop has the following structure: for (i in 1:4){ print(i) } ## [1] 1 ## [1] 2 ## [1] 3 ## [1] 4 This consists of two parts: The for statement, which tells R to start a loop. The code block within the curly braces {} that contains the code to be repeated. The for statement should be read as: “for each element in the sequence 1 to 4, assign that element to the variable i, and then run the code block”. Therefore, this code is equivalent to: print(1) print(2) print(3) print(4) ## [1] 1 ## [1] 2 ## [1] 3 ## [1] 4 But it’s much easier to maintain! Imagine having to do 86 iterations: you would need to copy paste the code 85 times every time you want to update something. Using loops, you don’t need to copy-paste a thing, leading to fewer errors. While loops can be a perfectly fine way of doing repeated work, most R programmers prefer not to use loops, but instead use functions such as lapply() and map(). However, for this you will need to know how to write functions. Functions Basic Functions A function is an R object that’s essentially a shortcut to run a bit of code. Usually, a function takes an argument (the input), and returns an output. The argument is always provided within parentheses. The sqrt() function, for example, takes a number as its argument and returns the square root of that number. sqrt(4) ## [1] 2 The beauty of functions is that they allow you to define a set of operations in one place, and re-use it as often as you want. If you then need to update the operations, all you need to do is update the function, instead of hunting down every instance of the operations throughout your script. Let’s say I have a report, where I run the same model many times, each time with different variables: library(tidyverse) df &lt;- tibble(y = rnorm(50),x1 = rnorm(50),x2 = rnorm(50), x3 = rnorm(50)) # lots of code in between... lm(y ~ x1, data = df) # lots of code in between... lm(y ~ x2, data = df) # lots of code in between... lm(y ~ x3, data = df) # lots of code in between... lm(y ~ x1 + x2 + x3 , data = df) ## ## Call: ## lm(formula = y ~ x1, data = df) ## ## Coefficients: ## (Intercept) x1 ## -0.04777 0.15943 ## ## ## Call: ## lm(formula = y ~ x2, data = df) ## ## Coefficients: ## (Intercept) x2 ## -0.03077 -0.21363 ## ## ## Call: ## lm(formula = y ~ x3, data = df) ## ## Coefficients: ## (Intercept) x3 ## -0.04774 -0.40042 ## ## ## Call: ## lm(formula = y ~ x1 + x2 + x3, data = df) ## ## Coefficients: ## (Intercept) x1 x2 x3 ## -0.08542 0.09003 -0.16673 -0.34797 If I now want to slightly change the model (e.g. use robust standard errors), I would have to find the places the model is used, and change it each time. Instead, I can put the model code in a function: my_model &lt;- function(independent_variable){ results &lt;- lm(formula = reformulate(independent_variable, response = &quot;y&quot;), data = df) return(results) } This has the following structure: - The function statement tells R to create a function. It also list the arguments the function takes. In this case just one: independent_variable, which should be passed a string (that reformulate() can convert to a formula). - The code block within the curly braces {} contains the code that will be run when the function is called. It ends with the return() function, which tells R what to return as output of the function. This will be printed to to the console, or can be assigned to an object. I can then run my model four times: my_model(&quot;x1&quot;) # lots of code in between... my_model(&quot;x2&quot;) # lots of code in between... my_model(&quot;x3&quot;) # lots of code in between... my_model(c(&quot;x1&quot;,&quot;x2&quot;,&quot;x3&quot;)) ## ## Call: ## lm(formula = reformulate(independent_variable, response = &quot;y&quot;), ## data = df) ## ## Coefficients: ## (Intercept) x1 ## -0.04777 0.15943 ## ## ## Call: ## lm(formula = reformulate(independent_variable, response = &quot;y&quot;), ## data = df) ## ## Coefficients: ## (Intercept) x2 ## -0.03077 -0.21363 ## ## ## Call: ## lm(formula = reformulate(independent_variable, response = &quot;y&quot;), ## data = df) ## ## Coefficients: ## (Intercept) x3 ## -0.04774 -0.40042 ## ## ## Call: ## lm(formula = reformulate(independent_variable, response = &quot;y&quot;), ## data = df) ## ## Coefficients: ## (Intercept) x1 x2 x3 ## -0.08542 0.09003 -0.16673 -0.34797 I don’t need to touch these anymore if I want to change something in the model. I only need to update the function definition. Note that any variables we created in the function are kept within the function, and you can’t access them later: model &lt;- my_model(&quot;x3&quot;) results ## Error: object &#39;results&#39; not found This keeps your working environment nice and clean, which again prevents problems. Above I used the return function. That was purely to to make it explicit what the output is for explanation purposes, it is not actually needed. Anything on the last line of the function that would normally be returned to the console, is used a return value of the function: my_model &lt;- function(independent_variable){ lm(formula = reformulate(independent_variable, response = &quot;y&quot;), data = df) } my_model(&quot;x1&quot;) ## ## Call: ## lm(formula = reformulate(independent_variable, response = &quot;y&quot;), ## data = df) ## ## Coefficients: ## (Intercept) x1 ## -0.04777 0.15943 Functions and the tidyverse Tidyverse can be a bit tricky when writing functions, because the unquoted variable names often break stuff. Let’s say I want to have standard scatter plots like this: df %&gt;% ggplot(aes(y = y, x = x1)) + geom_point() But I don’t want to copy all that, so I make a function: my_plot &lt;- function(x_variable){ df %&gt;% ggplot(aes(y = y, x = x_variable)) + geom_point() } my_plot(x1) ## Error in `geom_point()`: ## ! Problem while computing aesthetics. ## ℹ Error occurred in the 1st layer. ## Caused by error: ## ! object &#39;x1&#39; not found Why can’t it find x1? It’s right there in the data frame! But when evaluating my_plot(x1), R doesn’t look for x1 in the dataframe (why would it?), it looks for x1 in the global environment. So we have to make sure R waits until it’s inside ggplot() to look for x1 in the data frame. This is actually quite easy to do, simply wrap the variable name in {{ }} in the function body: my_plot &lt;- function(x_variable){ df %&gt;% ggplot(aes(y = y, x = {{ x_variable }})) + geom_point() } my_plot(x1) However easy that solution was, the explanation behind it is a bit more complex, see here. If that’s all black magic to you, just remember that if you want to use unquoted variable names in your functions, wrap them in {{ }} in the function body. Map() map() works just like loop, but generally faster. It takes two arguments: An iterable object, like a vector or list A function It will then apply the function to each element of the object. It will return a list with the results of each iteration. For example, to get the the square root for each of the numbers in a vector: vector &lt;- c(4,9,16) map(vector,sqrt) ## [[1]] ## [1] 2 ## ## [[2]] ## [1] 3 ## ## [[3]] ## [1] 4 You may not quite like the fact that map returns a list, but quite a few things in R use lists. modelsummary() for example. Suppose I want to put all the results from my_model() above in a nice table. Suppose I want to regress the same y on a number of combinations of independent variables, I can put the combination of variables in a list, and then run my model for each element of the list. library(modelsummary) # define a list of models: # the left-hand sides are the labels # the right-hand sides the independent variables I will pass to reformulate. models &lt;- list(&quot;X1 only&quot; = &quot;x1&quot;, &quot;X2 only&quot; = &quot;x2&quot;, &quot;X3 only&quot; = &quot;x3&quot;, &quot;Full&quot; = c(&quot;x1&quot;, &quot;x2&quot;, &quot;x3&quot;)) # map() works nicely in dplyr pipe! models %&gt;% map(my_model) %&gt;% modelsummary(output = &quot;flextable&quot;) .cl-c4e9c73c{}.cl-c4e0e680{font-family:'DejaVu Sans';font-size:11pt;font-weight:normal;font-style:normal;text-decoration:none;color:rgba(0, 0, 0, 1.00);background-color:transparent;}.cl-c4e5bb24{margin:0;text-align:left;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);padding-bottom:5pt;padding-top:5pt;padding-left:5pt;padding-right:5pt;line-height: 1;background-color:transparent;}.cl-c4e5d992{width:0.75in;background-color:transparent;vertical-align: middle;border-bottom: 1.5pt solid rgba(102, 102, 102, 1.00);border-top: 1.5pt solid rgba(102, 102, 102, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-c4e5d99c{width:0.75in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-c4e5d9a6{width:0.75in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 1pt solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-c4e5d9a7{width:0.75in;background-color:transparent;vertical-align: middle;border-bottom: 1.5pt solid rgba(102, 102, 102, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;} X1 onlyX2 onlyX3 onlyFull(Intercept)-0.048-0.031-0.048-0.085(0.148)(0.143)(0.136)(0.141)x10.1590.090(0.140)(0.136)x2-0.214-0.167(0.135)(0.131)x3-0.400-0.348(0.146)(0.152)Num.Obs.50505050R20.0260.0500.1350.171R2 Adj.0.0060.0300.1170.117AIC147.4146.2141.4143.3BIC153.1151.9147.2152.9Log.Lik.-70.687-70.083-67.724-66.667F1.2952.5017.4993.161RMSE0.990.980.940.92 If you want to specify more arguments to the function you are using in map(), you can do so by using an anonymous function. Let’s say I want to calculate the mean of a number of vectors, but I want to remove missing values. vectors &lt;- list(c(1,NA,3,-99,5), c(10,20,-99,30,40,50), c(-99,NA,200,300)) # the ~ creates a purrr-style anonymous function, where .x is current element of the list vectors %&gt;% map(mean) ## [[1]] ## [1] NA ## ## [[2]] ## [1] 8.5 ## ## [[3]] ## [1] NA That didn;t work, since mean doesn’t remove NAs by default. I can make a new function that does remove NAs by defaults: mean_narm &lt;- function(x){ mean(x, na.rm = TRUE) } vectors %&gt;% map(mean_narm) ## [[1]] ## [1] -22.5 ## ## [[2]] ## [1] 8.5 ## ## [[3]] ## [1] 133.6667 Or, if I don’t want this new function cluttering up my environment, I can make an anonymous function on the fly: vectors %&gt;% map(function(x) mean(x, na.rm = TRUE)) ## [[1]] ## [1] -22.5 ## ## [[2]] ## [1] 8.5 ## ## [[3]] ## [1] 133.6667 Note it will be quite difficult to use map() with data frame columns to edit multiple variables. For this, use across(), as seen in the data cleaning chapter Other variants of map() map() is an entire family of functions. One that I like is pmap(), which allows you to iterate over a number of things at the same time. Suppose, like before I want to run a model a few times, but now I want to not only change one thing (like the control), but more things, like the dependent variable. First, I put the parameters of each specification in a data frame like this: specs &lt;- tribble( ~label, ~depvar, ~controls, &quot;X1 only&quot; ,&quot;y&quot;, &quot;x1&quot;, &quot;X2 only&quot; ,&quot;y&quot;, &quot;x2&quot;, &quot;X3 only&quot; , &quot;y&quot;,&quot;x3&quot;, &quot;Full&quot; ,&quot;y&quot;, c(&quot;x1&quot;, &quot;x2&quot;, &quot;x3&quot;) ) I can print this in my markdown file, so it’s easily seen what I am doing: library(flextable) specs %&gt;% mutate( controls = map_chr(controls, ~ paste(.x, collapse = &quot;,&quot;)) ) %&gt;% flextable() .cl-c4fe9360{}.cl-c4f92cfe{font-family:'DejaVu Sans';font-size:11pt;font-weight:normal;font-style:normal;text-decoration:none;color:rgba(0, 0, 0, 1.00);background-color:transparent;}.cl-c4fb7cc0{margin:0;text-align:left;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);padding-bottom:5pt;padding-top:5pt;padding-left:5pt;padding-right:5pt;line-height: 1;background-color:transparent;}.cl-c4fb967e{width:0.75in;background-color:transparent;vertical-align: middle;border-bottom: 1.5pt solid rgba(102, 102, 102, 1.00);border-top: 1.5pt solid rgba(102, 102, 102, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-c4fb9688{width:0.75in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-c4fb9692{width:0.75in;background-color:transparent;vertical-align: middle;border-bottom: 1.5pt solid rgba(102, 102, 102, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}labeldepvarcontrolsX1 onlyyx1X2 onlyyx2X3 onlyyx3Fullyx1,x2,x3 I used the map_chr() function to concatenate each cell in the controls column using paste() and turn that into a vector of strings. This vector can go straight into mutate, and in the dataframe. Then I feed my spec into a function using pmap: specs %&gt;% pmap( function(depvar, controls, ... ){ lm(reformulate(controls, response = depvar), data =df) } ) %&gt;% set_names(specs$label) %&gt;% modelsummary(output = &quot;flextable&quot;, stars = TRUE) .cl-c56dbe66{}.cl-c5679932{font-family:'DejaVu Sans';font-size:11pt;font-weight:normal;font-style:normal;text-decoration:none;color:rgba(0, 0, 0, 1.00);background-color:transparent;}.cl-c56a24b8{margin:0;text-align:left;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);padding-bottom:5pt;padding-top:5pt;padding-left:5pt;padding-right:5pt;line-height: 1;background-color:transparent;}.cl-c56a3f84{width:0.75in;background-color:transparent;vertical-align: middle;border-bottom: 1.5pt solid rgba(102, 102, 102, 1.00);border-top: 1.5pt solid rgba(102, 102, 102, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-c56a3f8e{width:0.75in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-c56a3f8f{width:0.75in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 1pt solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-c56a3f98{width:0.75in;background-color:transparent;vertical-align: middle;border-bottom: 1.5pt solid rgba(102, 102, 102, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-c56a3fa2{width:0.75in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(255, 255, 255, 0.00);border-top: 0 solid rgba(255, 255, 255, 0.00);border-left: 0 solid rgba(255, 255, 255, 0.00);border-right: 0 solid rgba(255, 255, 255, 0.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;} X1 onlyX2 onlyX3 onlyFull(Intercept)-0.048-0.031-0.048-0.085(0.148)(0.143)(0.136)(0.141)x10.1590.090(0.140)(0.136)x2-0.214-0.167(0.135)(0.131)x3-0.400**-0.348*(0.146)(0.152)Num.Obs.50505050R20.0260.0500.1350.171R2 Adj.0.0060.0300.1170.117AIC147.4146.2141.4143.3BIC153.1151.9147.2152.9Log.Lik.-70.687-70.083-67.724-66.667F1.2952.5017.4993.161RMSE0.990.980.940.92+ p &lt; 0.1, * p &lt; 0.05, ** p &lt; 0.01, *** p &lt; 0.001 Notes: The column names of spec will be passed to the function as arguments. If spec has columns that my function does not accept as arguments, it will throw an error. The ... prevents this, as that captures all unused arguments. This particular function uses only 2 arguments, so map2() would have worked fine here as well, but this can be more easily expanded to more complex things than map2(). Making functions re-usable with box Now that you have a bunch of functions, it’s a good idea to make them re-usable across projects. The box package makes this easy. You define your functions in a script, say box_modules/functions.R: prop_miss &lt;- function(x,na.rm = TRUE) { box::use(r/core[...]) mean(is.na(x)) } This is just a function that returns the proportion of missing values in a vector. box::use(r/core[...]) loads all functions from the core package, so you can use them in your function (box modules don’t load anything you don’t tell them to). You can then use this function in any project loading the entire script: box::use(./box_modules/functions) This looks in the folder where your script is located for a folder called box_modules, and loads all functions in the functions.R script. You can run the function by: functions$prop_miss(c(1,2,NA,4)) ## [1] 0.25 Box even allows you to load packages: box::use(dplyr) dplyr$starwars |&gt; dplyr$filter(species == &quot;Droid&quot;) ## # A tibble: 6 × 14 ## name height mass hair_color skin_color eye_color birth_year sex gender ## &lt;chr&gt; &lt;int&gt; &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt; ## 1 C-3PO 167 75 &lt;NA&gt; gold yellow 112 none masculi… ## 2 R2-D2 96 32 &lt;NA&gt; white, blue red 33 none masculi… ## 3 R5-D4 97 32 &lt;NA&gt; white, red red NA none masculi… ## 4 IG-88 200 140 none metal red 15 none masculi… ## 5 R4-P17 96 NA none silver, red red, blue NA none feminine ## 6 BB8 NA NA none none black NA none masculi… ## # ℹ 5 more variables: homeworld &lt;chr&gt;, species &lt;chr&gt;, films &lt;list&gt;, ## # vehicles &lt;list&gt;, starships &lt;list&gt; In fact, when writing your own box modules, this is the only way to load packages (hence thr box::use(r/core[...] in the function above). Note that you have to use the $ operator to access functions and data from the package or module you loaded. If you dont want that you can also attach specific functions: box::use(dplyr[filter, `%&gt;%`]) dplyr$starwars %&gt;% filter(species == &quot;Droid&quot;) ## # A tibble: 6 × 14 ## name height mass hair_color skin_color eye_color birth_year sex gender ## &lt;chr&gt; &lt;int&gt; &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt; ## 1 C-3PO 167 75 &lt;NA&gt; gold yellow 112 none masculi… ## 2 R2-D2 96 32 &lt;NA&gt; white, blue red 33 none masculi… ## 3 R5-D4 97 32 &lt;NA&gt; white, red red NA none masculi… ## 4 IG-88 200 140 none metal red 15 none masculi… ## 5 R4-P17 96 NA none silver, red red, blue NA none feminine ## 6 BB8 NA NA none none black NA none masculi… ## # ℹ 5 more variables: homeworld &lt;chr&gt;, species &lt;chr&gt;, films &lt;list&gt;, ## # vehicles &lt;list&gt;, starships &lt;list&gt; Or just attach everything just like you would with library(): box::use(dplyr[...]) starwars %&gt;% filter(species == &quot;Droid&quot;) ## # A tibble: 6 × 14 ## name height mass hair_color skin_color eye_color birth_year sex gender ## &lt;chr&gt; &lt;int&gt; &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt; ## 1 C-3PO 167 75 &lt;NA&gt; gold yellow 112 none masculi… ## 2 R2-D2 96 32 &lt;NA&gt; white, blue red 33 none masculi… ## 3 R5-D4 97 32 &lt;NA&gt; white, red red NA none masculi… ## 4 IG-88 200 140 none metal red 15 none masculi… ## 5 R4-P17 96 NA none silver, red red, blue NA none feminine ## 6 BB8 NA NA none none black NA none masculi… ## # ℹ 5 more variables: homeworld &lt;chr&gt;, species &lt;chr&gt;, films &lt;list&gt;, ## # vehicles &lt;list&gt;, starships &lt;list&gt; Alright, let’s unload our own function, so we can load it in another way, using: box::unload(functions) Alternatively, you can specify a search path, where box will look for modules. I will put my box modules in C:/Users/koen/documents/box_modules. The following code will allow box to look in that folder for modules: options(&#39;box.path&#39; = &quot;C:/Users/koen/documents/&quot;) # &lt;-- the parent folder!! Note that I have used the parent folder of box_modules, because for whatever reason you have to do that (the .R files need to be in a subfolder). By adding this to your [.Rprofile](https://docs.posit.co/ide/user/ide/guide/environments/r/managing-r.html) file, it will be run any time you open R. Now I can just use the following code in any project to access my functions: box::use(box_modules/functions) functions$prop_miss(c(1,2,NA,4,5,NA)) ## [1] 0.3333333 Of course you are no longer working project-oriented: your box modules aren’t in your project folder! If you want to use box modules within your project folder, best to add the root folder as search path: options(&#39;box.path&#39; = c(here::here(), getOption(&#39;box.path&#39;)) The function getOption('box.path') gets your current box search path, and c() combines it with your project root folder returned by here(). One way I like to organize my box modules is to have them in a git repository and use it as a submodule in my projects. That way you can have a specific version or branch of all your box modules in every project. You can also merge changes you make to you box modules of one project, back to all your other active projects. It’s fantastic, but a bit finnicky to set up. "],["declaredesign.html", "3. Power Analysis using DeclareDesign Simple Power Calculation Dif in diff Matching", " 3. Power Analysis using DeclareDesign There’s a lot that goes into research design, but here we focus on one thing that can be done well in R: power calculations. For this, I love DeclareDesign, a system to simulate Research Designs. Essentially, rather than plugging some parameters into a power calculator, you simulate your research and so investigate the statistical properties of your design. This is great, because it is often hard to include things like clustering and covariates in standard power calculators, and it forces you to be explicit about what you expect about your research. This chapter will only scratch the surface of what you can do, so I really recommend further learning about DeclareDesign: Slides by the authors of DeclareDesign: Graeme Blair, Alex Coppock, Macartan Humphreys The DeclareDesign CheatSheet The book Research Design in the Social Sciences: Declaration, Diagnosis, and Redesign Read at least the slides before going forward! This chapter covers power calculations in three designs: a simple comparison of means, a diff-in-diff design, and a matching design. To start of, we need example data. You can simulate this, but I prefer using existing data. Here we use Rhomis data. Simple Power Calculation The first design we consider is simply a comparison of means. We are interested in the effects of a project on the input of fertilizers. Loading data Here we take the Rhomis data, and add some variables. (For example, village codes: I create fake ones based on y-cooridnates.) library(tidyverse) library(DeclareDesign) library(here) n_clusters = 18 rhomis &lt;- read_csv(here(&quot;data/RHoMIS_Indicators.csv&quot;)) %&gt;% #names() filter(Country == &quot;Burundi&quot;) %&gt;% #count(Livestock_Orientation) # split the sample in villages, by lattitude filter(!is.na(GPS_LAT)) %&gt;% arrange(GPS_LAT) %&gt;% mutate(village = rep(1:n_clusters, each = nrow(.) / n_clusters , length.out = nrow(.))) %&gt;% # create some variables mutate(HFIAS_status = factor(HFIAS_status, levels = c(&quot;FoodSecure&quot;, &quot;MildlyFI&quot;, &quot;ModeratelyFI&quot;, &quot;SeverelyFI&quot;)), food_secure = 1 * (as.numeric(HFIAS_status) &lt;= 3), educated = 1*(Head_EducationLevel != &quot;No_school&quot;), female = 1* (HouseholdType == &quot;woman_single&quot;)) %&gt;% mutate(hh = row_number()) %&gt;% select(!HFIAS_status) %&gt;% # there are too many missings in my data; these seem reasonable to assume to be 0 when missing: mutate(across(c(LandOwned,NFertInput,educated), ~ if_else(is.na(.x),0,.x))) %&gt;% select(village, hh, NFertInput, food_secure, educated, LivestockHoldings) Declare Design Now it’s time to start declaring our design. The first element of the design is the model, using declare_model() which essentially is my data. declare_model() follows the syntax of fabricate(): a package that is part of the DeclareDesign ecosystem that allows you to generate fake data. In this syntax, instead of using mutate() we can just supply new variables after a comma. In this case, I add potential outcomes, using potential_outcomes(): effect_size_simple &lt;- 70 model_simple &lt;- declare_model( rhomis %&gt;% select(village, NFertInput), potential_outcomes(Y ~ NFertInput + Z * effect_size_simple) ) The potential outcomes are generated using potential_outcomes(). This will create two variables Y_Z_1 and Y_Z_0, which are the potential outcomes if having received treatment (Z == 1) or not. The difference between these is the effect size, which we assume to be 70 kg, we store this in a variable, so we can play with it later on. Note that I will generate Z in the next step. Then it’s time to think about assignment. I do a clustered randomization, based on the villages: assignment_simple &lt;- declare_assignment(Z = cluster_ra(clusters = village, prob = 0.5)) Next, I declare my theoretical quantity of interest is the treatment effect in year 1. This is basically my research question. inquiry_simple &lt;- declare_inquiry(ATE = mean(Y_Z_1 - Y_Z_0)) measurement_simple &lt;- declare_measurement( Y = reveal_outcomes(Y ~ Z) ) Since I won’t be able to observe Y_Z_1 for the control group, nor Y_Z_0 for the treatment group, I will need an estimation strategy. The below arguments will be put into lm_robust by default, and the term argument determines which coefficient is our estimate of interest: estimator_simple &lt;- declare_estimator(Y ~ Z, clusters = village, inquiry = &quot;ATE&quot;, term = &quot;Z&quot;, label = &quot;Simple&quot;) Finally, I combine all these elements to declare my design. Note that it’s only here that R starts actually running the code to randomize things. The previous was just declaration! design_simple &lt;- model_simple + assignment_simple + inquiry_simple + measurement_simple + estimator_simple summary(design_simple) ## ## Research design declaration summary ## ## Step 1 (model): declare_model(rhomis %&gt;% select(village, NFertInput), potential_outcomes(Y ~ NFertInput + Z * effect_size_simple)) ## ## N = 290 ## ## Added variable: village ## min median mean max sd N_missing N_unique ## 1 9 9.44 18 5.23 0 18 ## ## Added variable: NFertInput ## min median mean max sd N_missing N_unique ## 0 16 72.71 7500 465.79 0 44 ## ## Added variable: ID ## N_missing N_unique class ## 0 290 character ## ## Added variable: Y_Z_0 ## min median mean max sd N_missing N_unique ## 0 16 72.71 7500 465.79 0 44 ## ## Added variable: Y_Z_1 ## min median mean max sd N_missing N_unique ## 70 86 142.71 7570 465.79 0 44 ## ## Step 2 (assignment): declare_assignment(Z = cluster_ra(clusters = village, prob = 0.5)) ## ## Added variable: Z ## 0 1 ## 144 146 ## 0.50 0.50 ## ## Step 3 (inquiry): declare_inquiry(ATE = mean(Y_Z_1 - Y_Z_0)) ------------------- ## ## A single draw of the inquiry: ## inquiry estimand ## ATE 70 ## ## Step 4 (measurement): declare_measurement(Y = reveal_outcomes(Y ~ Z)) ---------- ## ## Added variable: Y ## min median mean max sd N_missing N_unique ## 0 70 107.95 7570 469.88 0 58 ## ## Step 5 (estimator): declare_estimator(Y ~ Z, clusters = village, inquiry = &quot;ATE&quot;, term = &quot;Z&quot;, label = &quot;Simple&quot;) ## ## Formula: Y ~ Z ## ## A single draw of the estimator: ## term estimator estimate std.error statistic p.value conf.low conf.high ## Z Simple 143.8593 58.44713 2.461358 0.02559529 19.94821 267.7704 ## df outcome inquiry ## 15.98618 Y ATE Diagnosing Design and calculating power If you want to browse a version of the data created by your design, use the draw_data() function. This is useful to examine the properties of the data. draw_data(design_simple) %&gt;% as_tibble() ## # A tibble: 290 × 7 ## village NFertInput ID Y_Z_0 Y_Z_1 Z Y ## &lt;int&gt; &lt;dbl&gt; &lt;chr&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;int&gt; &lt;dbl&gt; ## 1 1 5 001 5 75 0 5 ## 2 1 26 002 26 96 0 26 ## 3 1 40 003 40 110 0 40 ## 4 1 0 004 0 70 0 0 ## 5 1 10 005 10 80 0 10 ## 6 1 25 006 25 95 0 25 ## 7 1 25 007 25 95 0 25 ## 8 1 60 008 60 130 0 60 ## 9 1 0 009 0 70 0 0 ## 10 1 0 010 0 70 0 0 ## # ℹ 280 more rows Now to calculate our power. The diagnose_design() will run our model 500 times and our power is simply the fraction of times we find a statistically significant effect. set.seed(1) diagnose_design(design_simple) ## ## Research design diagnosis based on 500 simulations. Diagnosis completed in 5 secs. Diagnosand estimates with bootstrapped standard errors in parentheses (100 replicates). ## ## Design Inquiry Estimator Outcome Term N Sims Mean Estimand ## design_simple ATE Simple Y Z 500 70.00 ## (0.00) ## Mean Estimate Bias SD Estimate RMSE Power Coverage ## 72.34 2.34 60.30 60.29 0.27 1.00 ## (2.84) (2.84) (0.82) (0.80) (0.02) (0.00) Our power is 0.23, meaning we found a significant result in 23% of our model runs. That’s way lower than the traditional 80% threshold. How large should our effect size be to reach a power of 0.8? We can use the redesign() function for this. Redesign allows you to vary certain parameters of your design, and run the design 500 times for each value of the parameter. Here I set it to run 200 times, as that takes long enough already. set.seed(1) diagnosis_simple &lt;- design_simple %&gt;% redesign(effect_size_simple = seq(100,300,50)) %&gt;% diagnose_design(sims = 200) %&gt;% tidy() %&gt;% as_tibble() Now, I want a nice plot. For this I filter the tibble I created, and pipe it into ggplot(): diagnosis_simple %&gt;% filter(diagnosand == &quot;power&quot;) %&gt;% select(effect_size_simple,power = estimate) %&gt;% ggplot(aes(x = effect_size_simple, y = power)) + geom_line() + geom_point() + geom_hline(yintercept=0.8,linetype=2) We can reliably detect an effect size between 150 and 200 kgs of fertilizer. The mean fertilizer use is 70kg, so that seems unlikely to be realistic. Perhaps we should add covariates to reduce the standard error? Dif in diff Perhaps we can increase power using a diff-in-diff design? If fertilizer input in one year is correlated to the next, this should reduce standard errors and increase power. But then we have to pretend we have two rounds of data collection. For that, I prefer to use dplyr, but it should be possible with fabricate() as well. I first rename all our time-variant varaible to have _0 at the end, create a bunch of correlated varaibles with _1 at the end, and then pivot_longer. First, I make a function to make some variation of a given variable, with correlation coefficient rho. I like the correlate() function for this, but it can only handle distributions such as rnorm(), which NFertInput just isn’t. So what I do is, I transform NFertInput to a normal distribution using bestNormalize, the I use correlate to generate a variable that’s correlated to to that normally distruted version of NFertInput, and transform that back. library(bestNormalize) variate_var &lt;- function(x, rho, slope = 1) { suppressWarnings({ bn &lt;- bestNormalize(x) x_trans &lt;- bn$x.t sd_x &lt;- sd(x_trans) mean_x &lt;- sd(x_trans) x_new_trans &lt;- correlate(given = x_trans, rho = rho, rnorm, mean = mean_x, sd = sd_x) x_new &lt;- predict(bn, x_new_trans, inverse = TRUE) x_new[x_new == Inf] &lt;- mean(x_new[x_new != Inf], na.rm = TRUE) # correlated is fine, but the slope of the relationship should not be too steep x_new * (mean(x) / mean(x_new)) * slope }) } This all feels like it should be illegal, but since properly varying things is actually quite hard to do, this is the best I have so far. I update my design accordingly: effect_size_dd &lt;- 70 sd_dd &lt;- 100 rho_dd &lt;- 0.7 model_dd &lt;- declare_model( rhomis %&gt;% select(village, NFertInput) %&gt;% # add one more year rename_with(~ paste0(., &quot;_0&quot;), -village) %&gt;% mutate( NFertInput_1 = variate_var(NFertInput_0, rho_dd) ) %&gt;% pivot_longer( ends_with(c(&quot;_0&quot;,&quot;_1&quot;)), names_to = c(&quot;.value&quot;, &quot;t&quot;), names_pattern = &quot;(.*)_([0-9]+)$&quot;, values_drop_na = TRUE, names_transform = list(t = as.integer) ), potential_outcomes(Y ~ NFertInput + Z * effect_size_dd) ) I modify the inquiry and assignment to only take into account t == 1 inquiry_dd &lt;- declare_inquiry(ATE = mean(Y_Z_1 - Y_Z_0), subset = (t == 1)) assignment_dd &lt;- declare_assignment(treatment_group = cluster_ra(clusters = village, prob = 0.5), Z = t * treatment_group) Measurement is unchanged: measurement_dd &lt;- declare_measurement( Y = reveal_outcomes(Y~Z) ) Then I use feols() from the fixest package to estimate a Two-way fixed effects (2FE) model. This can be easily extended to more complex designs (but beware!). library(fixest) library(broom) estimator_dd &lt;- declare_estimator(Y ~ Z | treatment_group + t, cluster = &quot;village&quot;, .method = feols, term = &quot;Z&quot;, inquiry = &quot;ATE&quot;, label = &quot;2FE&quot;) The complete design is then: design_dd &lt;- model_dd + assignment_dd + inquiry_dd + measurement_dd + estimator_dd Let’s have a look at our power now! Of course, in a DiD setting, power depends not only on the effect size, but also on how well the years correlate. I therefore also vary the rho_dd variable, which controls the correlation between fertilizer input in years 0 and 1: set.seed(1) diagnosis_dd &lt;- design_dd %&gt;% redesign( effect_size_dd = c(100, 150, 200), rho_dd = c(0.3,0.7, 0.9) ) %&gt;% diagnose_design(sims = 100) %&gt;% tidy() %&gt;% as_tibble() ## Error: object &#39;design_dd&#39; not found Putting it in a plot again: diagnosis_dd %&gt;% filter(diagnosand == &quot;power&quot;) %&gt;% rename(power = estimate) %&gt;% mutate(rho_dd = factor(rho_dd)) %&gt;% ggplot(aes(x = effect_size_dd, y = power, color = rho_dd, shape = rho_dd)) + geom_line() + geom_point() + geom_hline(yintercept=0.8, linetype=2) So at high levels of Rho, our power is higher than when using the simple model. The lower rho is, the less added value the diff-in-diff model has. Matching Finally, let’s imagine a scenario where treatment isn’t random, but correlated to outcomes, so we would need matching. Let’s also look at food_secure, since it’s binary, and thus adds a twist here and there. Also, I will use the resample_data() function to pretend that we can visit more households than are in my original data set. Declare Design The first novel thing is the binary outcome. We want an easy to interpret effect size: a percentage point increase in food secure households. This is a bit trickey: before we just added the effect size to everyone. But for binary variables, we only change a 0 to a 1 for a certain share of the population. Let’s just define that first. The function below flips a certain number of 0s to 1, so that we have a nice effect size: flip_zeroes &lt;- function(x, Z, effect) { # how many 1s do we currently have? n_current_ones &lt;- sum(x[Z == 1]) # how many 1s should we have? p_current &lt;- mean(x[Z == 1]) p_target &lt;- p_current + effect n_target_ones &lt;- round(p_target * sum(Z == 1)) # figure out which zeros to flip n_to_flip &lt;- n_target_ones - n_current_ones # If nothing to flip, return x if (n_to_flip &lt;= 0) return(x) zeros_index &lt;- which(x[Z==1] == 0) # Can&#39;t flip more zeros than exist n_to_flip &lt;- min(n_to_flip, length(zeros_index)) if (n_to_flip == 0) return(x) flip_index &lt;- sample(zeros_index, n_to_flip) # do it, and return the new x x[Z==1][flip_index] &lt;- 1 x } Our model then becomes: model_matching &lt;- declare_model( rhomis ) Then we do the assignment. This now consists of two steps: Communities are assigned randomly, using cluster_ra() Households are assigned in a way that is correlated with education and livestock holdings, (and also food_secure) using correlate(). rho &lt;- 0.5 assignment_matching &lt;- declare_assignment( hh_treat = correlate( given = educated * LivestockHoldings^2, rho = rho, raw_binomial, prob = 0.3 ), vill_treat = cluster_ra(clusters = village, prob = 0.5), Z = hh_treat * vill_treat ) Then we take an extra step: re-sampling. Some notes: We use resample_data() to sample more households than are in our original data set. The resulting data set will thus follow the same distribution as our original data, but with more observations. In treatment communities, we only sample from treated households. In control communities, we don’t know who would have been treated, so we sample randomly. We sample a certain number of households per community, which is a parameter we can vary in our diagnosis. The number differs between treatment and control communities, to allow oversampling the control observation to compensate for matching losses. To do this, we run the resample_data() function separately for treatment and control communities, using a combination of nest and map2 functions (see here). communities_per_arm &lt;- 10 respondents_treat &lt;- 10 respondents_control &lt;- 15 resample_hhs &lt;- function(df, communities_per_arm, respondents_treat, respondents_control){ df %&gt;% filter(vill_treat == 0 | Z == 1) %&gt;% mutate(respondents = if_else(Z == 1, respondents_treat, respondents_control)) %&gt;% nest(.by = c(Z, respondents)) %&gt;% mutate( data = map2( data, respondents, ~resample_data( .x, N = c(communities_per_arm,.y), ID_labels = c(&quot;village&quot;, &quot;hh&quot;), unique_labels = TRUE ) ) ) %&gt;% unnest(data) } resampling_matching &lt;- declare_step( handler = resample_hhs, communities_per_arm = communities_per_arm, respondents_treat = respondents_treat, respondents_control = respondents_control ) Measurement and inquiry are slightly different. I defined my treatment effects as a percentage point increase in food secure households. So if the percentage of food insecure households is very large relative to the effect size, the chance an individual household become food insecure is low. This messes with potential outcomes, as the effect on each individal depends on the means in the treatment group, and thus on the randomization. I therefore skip the potential outcomes, and just define my estimand as the effect size. effect_size_matching &lt;- 0.1 measurement_matching &lt;- declare_measurement( Y = flip_zeroes(food_secure, Z, effect_size_matching) ) inquiry_matching &lt;- declare_inquiry(ATE = effect_size_matching) Now for the estimators, let’s start with a simple one, with no matching: estimator_matching_no_matching &lt;- declare_estimator(Y ~ Z, inquiry = &quot;ATE&quot;, term = &quot;Z&quot;, label = &quot;Not matched&quot;, cluster= village_unique) Finally, I need to somehow put my matching model in DeclareDesign. Fortunately, you can put any the output of any function into the declare_estimator() function using the handler argument. It does need to accept a data argument, and output a tidy() dataframe. My function custom_match() accepts a data frame, uses MatchIt to create a matched data set, I define a function that does that, and some labelling: # the select function would conflict with dplyr # this syntax requires R 4.0 or higher library(MatchIt, exclude(&quot;select&quot;)) custom_match &lt;- function(data, equation, outcome = &quot;Y&quot;, term = &quot;Z&quot;, method = &quot;nearest&quot;){ # the command filter(term == term) wouldn&#39;t do anything, so this is a workaround term_value &lt;- term # run the matching model matchit_model &lt;- matchit(equation, data = data, method = method) matched_df &lt;- match.data(matchit_model) # run a regression, weighted by the propensity score lm_robust(Y ~ Z, data = matched_df, weights = weights, clusters = village_unique) %&gt;% tidy() %&gt;% mutate(outcome = outcome) %&gt;% filter(term == term_value) } Then I add two estimator: one that uses PSM (‘nearest’) and one that uses CEM (‘cem’), so that we can compare these two matching methods in our diagnosis. estimator_matching_psm &lt;- declare_estimator( Z ~ educated + LivestockHoldings, handler = label_estimator(custom_match), inquiry = &quot;ATE&quot;, # Tie the estimator to the declared inquiry label = &quot;Matched PSM&quot;, term = &quot;Z&quot;, ) estimator_matching_cem &lt;- declare_estimator( Z ~ educated + LivestockHoldings, handler = label_estimator(custom_match), inquiry = &quot;ATE&quot;, # Tie the estimator to the declared inquiry label = &quot;Matched CEM&quot;, term = &quot;Z&quot;, method = &quot;cem&quot; ) And let’s combine it into one design! design_matching &lt;- model_matching + assignment_matching + resampling_matching + measurement_matching + inquiry_matching + estimator_matching_no_matching + estimator_matching_psm + estimator_matching_cem Checking balance It’s useful to explore the property’s of our matching estimator. First I draw data based on my design and create matched version of that data. set.seed(1) test_data &lt;- draw_data(design_matching) %&gt;% as_tibble() ## Error: Error in step 2 (): ## Error: object &#39;raw_binomial&#39; not found matchit_model_psm &lt;- matchit( Z ~ educated + LivestockHoldings , data = test_data, method = &quot;nearest&quot;, discard = &quot;both&quot;) ## Error: object &#39;test_data&#39; not found test_data_psm &lt;- match.data(matchit_model_psm) ## Error: object &#39;matchit_model_psm&#39; not found matchit_model_cem &lt;- matchit( Z ~ educated + LivestockHoldings, data = test_data, method = &quot;cem&quot;, discard = &quot;both&quot;) ## Error: object &#39;test_data&#39; not found test_data_cem &lt;- match.data(matchit_model_cem) ## Error: object &#39;matchit_model_cem&#39; not found Then I create balance table for the test_data: library(modelsummary) library(flextable) # balance table test_data %&gt;% mutate(Z = factor(Z, labels = c(&quot;Control&quot;, &quot;Treatment&quot;))) %&gt;% select(Z, Y, food_secure, educated, LivestockHoldings) %&gt;% datasummary_balance( ~ Z , data = ., output = &quot;flextable&quot;, stars = TRUE, dinm = TRUE, dinm_statistic = &quot;p.value&quot;) %&gt;% fix_border_issues() %&gt;% autofit() ## Error: object &#39;test_data&#39; not found And for the test_data_psm, which is balanced in terms of the variables we matched on: test_data_psm %&gt;% mutate(Z = factor(Z, labels = c(&quot;Control&quot;, &quot;Treatment&quot;))) %&gt;% select(Z, Y, food_secure, educated, LivestockHoldings) %&gt;% datasummary_balance( ~ Z , data = ., output = &quot;flextable&quot;, stars = TRUE, dinm = TRUE, dinm_statistic = &quot;p.value&quot;) %&gt;% fix_border_issues() %&gt;% autofit() ## Error: object &#39;test_data_psm&#39; not found For CEM, it’s a bit more complex, as it relies on weighting. While the [documentation](https://modelsummary.com/reference/datasummary_balance.html#global-options) claimsdatasummary_balance()reports weighted means if aweights` variable is present, I find this is not the case in the version I use here. So here’s a custom balance table: library(flextable) library(estimatr) balance_table &lt;- function(data, by){ # get a table with summ stats: summstats &lt;- data %&gt;% select(-weights) %&gt;% group_by( {{ by }} ) %&gt;% summarize( across( .cols = everything(), .fns = list( mean = ~mean(.x,na.rm=TRUE), sd = ~sd(.x,na.rm=TRUE) ), .names = &quot;{.col}-{.fn}&quot; ) ) %&gt;% pivot_longer(cols = -Z, names_to = c(&quot;Variable&quot;,&quot;.value&quot;), names_sep=&quot;-&quot;) # function to get the difference between treatment and control get_diffs &lt;- function(equation, clusters = NULL, weights = NULL){ reg &lt;- lm_robust( equation, clusters = {{ clusters }}, weights = {{ weights }} ) %&gt;% broom::tidy() estimate &lt;- round(reg[2,2],2) p &lt;- reg[2,5] stars = case_when(p &lt; 0.001 ~ &quot;***&quot;, p &lt; 0.01 ~ &quot;**&quot;, p &lt; 0.05 ~ &quot;*&quot;, .default = &quot;&quot;) paste0(estimate, stars) } # compute differences for all vars: difcol &lt;- data %&gt;% summarize(across(.cols = c(everything(), -Z), .fns = ~get_diffs(.x ~ Z, weights = weights))) %&gt;% pivot_longer(cols =everything(), names_to = &quot;Variable&quot;, values_to=&quot;Difference&quot;) # output summstats %&gt;% tabulator( rows = names(summstats)[2], columns = names(summstats)[1], datasup_last = difcol, Mean = as_paragraph(as_chunk(mean, digits=2)), SD = as_paragraph(as_chunk(sd, digits=2)) ) %&gt;% as_flextable() %&gt;% #labelizor(j = &quot;Variable&quot;, labels = labels, part = &quot;body&quot;) %&gt;% fix_border_issues() %&gt;% autofit() } test_data_cem %&gt;% select(Z, Y, food_secure, educated, LivestockHoldings, weights) %&gt;% balance_table(by = Z) ## Error: object &#39;test_data_cem&#39; not found CEM balances a bit better it seems. Let’s run the models two times: unmatched_model &lt;- lm_robust(Y ~ Z, data = test_data) ## Error: object &#39;test_data&#39; not found matched_model_psm &lt;- lm_robust(Y~Z, data = test_data_psm, weights = weights) ## Error: object &#39;test_data_psm&#39; not found matched_model_cem &lt;- lm_robust(Y~Z, data = test_data_cem, weights = weights) ## Error: object &#39;test_data_cem&#39; not found modelsummary(list(lm = unmatched_model, psm = matched_model_psm, cem = matched_model_cem), output = &quot;flextable&quot;, gof_map = c(&quot;nobs&quot;,&quot;r.squared&quot;,&quot;adj.r.squared&quot;), stars = TRUE) ## Error: object &#39;unmatched_model&#39; not found The true effect is 0.3, so the simple model is actually closest in this case. Of course, this is just for one draw of the data, so let’s see how this looks on average when we run the design many times! Bias First, let’s examine bias, given selection effects. The strength of the selection effect is given by rho, so I use redesign() to vary it: set.seed(1) diagnosis_matching_bias &lt;- design_matching %&gt;% redesign(rho = seq(from = 0, to = 0.75, by = 0.25)) %&gt;% diagnose_design(sims = 100) %&gt;% tidy() %&gt;% as_tibble() And I put the result in a plot: diagnosis_matching_bias %&gt;% filter(diagnosand == &quot;bias&quot;) %&gt;% select(rho, bias = estimate, estimator) %&gt;% ggplot(aes(x = rho, y = bias, shape = estimator, color=estimator)) + geom_line() + geom_point() It’s clear that while PSM reduced bias, but CEM performed much better. Power Then, let’s examine power. I drop the no matching a psm, to save some simulation time. design_cem &lt;- model_matching + assignment_matching + resampling_matching + measurement_matching + inquiry_matching + estimator_matching_cem set.seed(1) diagnosis_matched_power &lt;- design_cem %&gt;% redesign( communities_per_arm = c(5,30,50), effect_size_matching = c(0.01,0.2, 0.3) ) %&gt;% diagnose_design(sims = 100) %&gt;% tidy() %&gt;% as_tibble() So at 30 communities per arm, our design can pick up an effect of 0.3, but to pick up an effect of 0.2 we should ideally increase our sample. diagnosis_matched_power %&gt;% filter(diagnosand == &quot;power&quot;) %&gt;% mutate(effect_size_matching = factor(effect_size_matching)) %&gt;% select(communities_per_arm, power = estimate, estimator, effect_size_matching) %&gt;% ggplot(aes(x = communities_per_arm, y = power, shape = effect_size_matching, color=effect_size_matching)) + geom_line() + geom_point() + geom_hline(yintercept=0.8,linetype=2) "],["datawrangling.html", "4. Data Cleaning The basic pattern Using plots to identify data issues reproducibly Dealing with multiple levels of data Editing many variables at once Splitting multi-response variable into dummies Structure of a cleaning Rmarkdown doc with multi-level data", " 4. Data Cleaning Data from the field never quite comes in the form you want, and the form you want your data in changes depending on what you want to do with it. So for every project, you’ll likely do a substantial amount of data wrangling. The goal of reproducible data cleaning is that at any moment, you can re-run your code to go from raw data to outputs. This is only useful, if you organize and document your code in such a way that people unfamiliar with the project (this could be future you!) can understand and modify the code. For this, RMarkdown is great, as it contains code, results and documentation all in one place. This chapter will provide examples of common data wrangling patterns, as well as how they can fit it into a reproducible data cleaning RMarkdown file. Make sure you have the tidyverse installed, and the SAFI data set downloaded to your data folder by running the code from the Set-up section The basic pattern Below is an example R Script, with some common data wrangling tasks, organized as follows: Loading raw data Cleaning variables by topic using dplyr, including mutating and changing factor levels. Combine topics into one large data file Saving cleaned data, so it can be used in analysis scripts. Note that objects are never overwritten: data is loaded as raw_data, and each topic takes its info from there, and then the cleaned variables are saved in their own new data object. The final clean_data is then assembled from all separate data files. This has a number of advantages: It comparimentalizes your code: any cleaning you do on the conflict data will not affect the housing data. This is especially useful when running code interactively when you’re working on it, as you can run the bits out of order without causing problems. Your analysis data set will only contain the data you need. This makes for data files that are easier to handle, and minimizes the impact of data breaches if analyses data needs to be shared with co-authors. Note furthermore that any filtering is done at the beginging, in the “paradata” section. Paradata are metadata recorded during data collection (e.g., timestamps, interviewer IDs, and device logs) that document how, when, and by whom data were collected; here the paradata object serves as a central reference to which all other data are joined. By doing the filter in a specific object, near the top of your script, you make sure this is done transparently. # loading packages library(tidyverse) library(here) # loading raw data raw_data &lt;- read_csv(here(&quot;data/SAFI_clean.csv&quot;), na = &quot;NULL&quot;) # Paradata paradata &lt;- raw_data %&gt;% mutate(day = day(interview_date), month = month(interview_date), year = year(interview_date)) %&gt;% filter(village == &quot;Chirodzo&quot;) %&gt;% filter(interview_date &gt; &quot;2016-11-16&quot; &amp; interview_date &lt; &quot;2017-01-01&quot;) %&gt;% select(key_ID, interview_date, day, month, year, village) # housing housing &lt;- raw_data %&gt;% mutate(people_per_room = no_membrs / rooms, respondent_wall_type = as_factor(respondent_wall_type), respondent_wall_type = fct_recode(respondent_wall_type, &quot;Burned bricks&quot; = &quot;burntbricks&quot;, &quot;Mud Daub&quot; = &quot;muddaub&quot;, &quot;Sun bricks&quot; = &quot;sunbricks&quot;)) %&gt;% select(key_ID, no_membrs, rooms, people_per_room, respondent_wall_type) # conflict conflict &lt;- raw_data %&gt;% mutate(conflict_yn = case_when(affect_conflicts == &quot;frequently&quot; ~ 1, affect_conflicts == &quot;more_once&quot; ~ 1, affect_conflicts == &quot;once&quot; ~ 1, affect_conflicts == &quot;never&quot; ~ 0, .default = NA)) %&gt;% select(key_ID, conflict_yn) # join data clean_data &lt;- paradata %&gt;% left_join(housing) %&gt;% left_join(conflict) # saving clean data for later use clean_data %&gt;% saveRDS(here(&quot;data/SAFI_cleaner.rds&quot;)) Throughout this chapter, we will add things to this sctructure, until we end up with a basic .Rmd file that is easy to work with. First we will info on how to include plots, then how to use multi-level data, and finally some advanced techniques such as editing multiple varaibles all at once. Using plots to identify data issues reproducibly A key part of data cleaning is identifying issues in the data. This is often done by plotting the data, inspecting summary statistics, or tabulating values. In R, this is easy to do in a reproducible way using ggplot2. For example, to identify outliers in the years_liv variable, we can make a boxplot: raw_data %&gt;% ggplot(aes(x = years_liv)) + geom_boxplot() From the boxplot, we can see that there’s no super unplausible numbers. But let’s say we are worried, and want to winsorize this variable at 95%, just so that the few high values don’t affect our analysis too much. years_liv_clean &lt;- raw_data %&gt;% select(key_ID, years_liv) %&gt;% mutate(years_liv = if_else(years_liv &gt; quantile(years_liv, 0.95, na.rm = TRUE), quantile(years_liv, 0.95, na.rm = TRUE), years_liv)) I’ve saved the cleaned variable as a new object, ready to be merged into the clean data in the final .Rmd file. If find this to be a very useful pattern to repeat across my data cleaning scripts: plot data identify issues and outliers, and describe them in rmarkdown clean data merge cleanded data back in data The rendered RMarkdown file will then contain the code, the plots on which decisions are made, and documentation of these descisions. This means you can share it with people who have no access to the data, and they can still assess your work. Dealing with multiple levels of data In many surveys, data is collected at multiple levels, for example the village, household, and individual level, with each level having its own data set. For analysis purposes these data sets often need to be merged together. First, let’s make sure our dataset has multiple levels, by generating some fake individual-level data, making sure that the household roster has a number of lines for each household that is equal to the household size, and has two randomly generated variables: female and age. Note that age may be -99, which should be considered missing. long_data &lt;- read_csv(here(&quot;data/SAFI_clean.csv&quot;), na = &quot;NULL&quot;) %&gt;% select(key_ID,no_membrs ) %&gt;% uncount(no_membrs) %&gt;% group_by(key_ID) %&gt;% mutate(member_ID = row_number()) %&gt;% rowwise() %&gt;% mutate(female = sample(0:1,1), age = case_when(member_ID == 1 ~ sample(18:86,1), .default = sample(c(0:86,-99),1))) %&gt;% ungroup() long_data %&gt;% glimpse() ## Rows: 942 ## Columns: 4 ## $ key_ID &lt;dbl&gt; 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, … ## $ member_ID &lt;int&gt; 1, 2, 3, 1, 2, 3, 4, 5, 6, 7, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10,… ## $ female &lt;int&gt; 1, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 1, 1, 1, 1, 0, 0, 0, 0, 0, … ## $ age &lt;dbl&gt; 46, 81, 46, 79, 3, 47, 25, 47, 5, 71, 41, 13, 76, 28, 68, 83… # I save the data as a CSV long_data %&gt;% write_csv(here(&quot;data/raw/SAFI_roster.csv&quot;)) Pivoting long to wide To merge this roster data to our household data, we need to make sure we have one row per household. We do this by making age and female variables for each household member (age_1, age_2, etc.), For this, we use the pivot_wider() function (in Stata this would be called reshaping ). wide_data &lt;- long_data %&gt;% pivot_wider(names_from = member_ID, values_from = !ends_with(&quot;_ID&quot;), names_vary = &quot;slowest&quot;) wide_data %&gt;% glimpse() ## Rows: 131 ## Columns: 39 ## $ key_ID &lt;dbl&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 1… ## $ female_1 &lt;int&gt; 1, 0, 0, 0, 1, 1, 1, 1, 0, 0, 1, 1, 1, 1, 0, 1, 1, 1, 0, 1, … ## $ age_1 &lt;dbl&gt; 46, 79, 41, 36, 75, 59, 19, 52, 38, 39, 40, 22, 65, 42, 74, … ## $ female_2 &lt;int&gt; 0, 1, 1, 0, 0, 1, 0, 0, 0, 1, 1, 0, 1, 0, 0, 1, 1, 1, 1, 0, … ## $ age_2 &lt;dbl&gt; 81, 3, 13, 84, 23, 4, 1, 61, 79, 22, 3, 54, 57, 4, 35, 19, 1… ## $ female_3 &lt;int&gt; 0, 1, 1, 1, 1, 1, 1, 0, 1, 1, 1, 1, 0, 1, 0, 1, 1, 0, 0, 0, … ## $ age_3 &lt;dbl&gt; 46, 47, 76, 22, 32, 10, 57, 72, 82, 27, 84, 9, 36, 80, 18, 1… ## $ female_4 &lt;int&gt; NA, 0, 1, 0, 0, NA, 1, 1, 1, 1, 0, 0, 0, 1, 0, 1, 0, 0, 1, 1… ## $ age_4 &lt;dbl&gt; NA, 25, 28, 28, 11, NA, 80, 57, 47, 22, 70, 76, 73, 45, 34, … ## $ female_5 &lt;int&gt; NA, 0, 1, 0, 0, NA, 1, 0, 1, 1, 0, 1, 0, 1, 0, 0, 0, NA, 0, … ## $ age_5 &lt;dbl&gt; NA, 47, 68, 85, 42, NA, 53, 54, 73, 17, 55, 54, 60, 82, 55, … ## $ female_6 &lt;int&gt; NA, 0, 0, 1, 1, NA, 1, 1, 1, 0, 0, 0, 1, 0, NA, 1, 1, NA, 1,… ## $ age_6 &lt;dbl&gt; NA, 5, 83, 85, 5, NA, 11, 38, 15, 65, 54, 63, 31, 64, NA, 74… ## $ female_7 &lt;int&gt; NA, 0, 0, 1, 0, NA, NA, 1, 1, 0, NA, 0, NA, 0, NA, NA, 0, NA… ## $ age_7 &lt;dbl&gt; NA, 71, 76, 21, 6, NA, NA, 57, -99, 11, NA, 60, NA, 69, NA, … ## $ female_8 &lt;int&gt; NA, NA, 0, NA, NA, NA, NA, 0, 1, 0, NA, NA, NA, 0, NA, NA, 0… ## $ age_8 &lt;dbl&gt; NA, NA, 39, NA, NA, NA, NA, 83, 70, 55, NA, NA, NA, 41, NA, … ## $ female_9 &lt;int&gt; NA, NA, 0, NA, NA, NA, NA, 0, NA, 1, NA, NA, NA, 0, NA, NA, … ## $ age_9 &lt;dbl&gt; NA, NA, 9, NA, NA, NA, NA, 56, NA, 22, NA, NA, NA, 62, NA, N… ## $ female_10 &lt;int&gt; NA, NA, 0, NA, NA, NA, NA, 1, NA, 1, NA, NA, NA, 1, NA, NA, … ## $ age_10 &lt;dbl&gt; NA, NA, 41, NA, NA, NA, NA, 58, NA, 22, NA, NA, NA, 72, NA, … ## $ female_11 &lt;int&gt; NA, NA, NA, NA, NA, NA, NA, 1, NA, 0, NA, NA, NA, NA, NA, NA… ## $ age_11 &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, 71, NA, 7, NA, NA, NA, NA, NA, N… ## $ female_12 &lt;int&gt; NA, NA, NA, NA, NA, NA, NA, 1, NA, 0, NA, NA, NA, NA, NA, NA… ## $ age_12 &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, 34, NA, 50, NA, NA, NA, NA, NA, … ## $ female_13 &lt;int&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, … ## $ age_13 &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, … ## $ female_14 &lt;int&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, … ## $ age_14 &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, … ## $ female_15 &lt;int&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, … ## $ age_15 &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, … ## $ female_16 &lt;int&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, … ## $ age_16 &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, … ## $ female_17 &lt;int&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, … ## $ age_17 &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, … ## $ female_18 &lt;int&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, … ## $ age_18 &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, … ## $ female_19 &lt;int&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, … ## $ age_19 &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, … We only needed to specify three options: names_from: this is the column that contains the names (or often numbers) for each of our units of analysis. In this case, the member_ID. The values of this variable will be appended to the original variable names to create new variable names. So age becomes age_1, age_2, etc. values_from: the variables containing the data. All variables you specify here, will get one column for each possible value of names_from. In our case, these variables female and age. I used tidy select syntax to specify all variables except the ones ending in _ID. names_vary: this controls the ordering of the variables. By default (“fastest”), R will create all age variables, and then all female variables, by specifying slowest, we ensure that first all variables for member 1 are created, then all variables for member 2, etc. Pivoting wide to long If we had started with wide data, and had wanted to transform to long data, we’d have to use pivot_longer(): wide_data %&gt;% pivot_longer(!key_ID, names_to = &quot;name&quot;, values_to = &quot;value&quot;) %&gt;% glimpse() ## Rows: 4,978 ## Columns: 3 ## $ key_ID &lt;dbl&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, … ## $ name &lt;chr&gt; &quot;female_1&quot;, &quot;age_1&quot;, &quot;female_2&quot;, &quot;age_2&quot;, &quot;female_3&quot;, &quot;age_3&quot;, … ## $ value &lt;dbl&gt; 1, 46, 0, 81, 0, 46, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA… This was easy since the syntax of pivot_longer() is the exact opposite of pivot_wider(), but the result is pretty useless: The name column contains two things: a variable name and a member_ID; The data is too long: I’d like age and female to be two separate variables; and There’s many empty rows: there’s an age and female row for 19 possible members for each household, but most households are smaller than that. I could use separate_wider_delim(), pivot_wider(), and filter(!is.na()) to address those, but that’s not elegant at all. I can do all of this within the pivot_longer() call by using the names_to and names_sep options: wide_data %&gt;% pivot_longer(!key_ID, names_to = c(&quot;.value&quot;, &quot;member_ID&quot;), names_sep = &quot;_&quot;, values_drop_na = TRUE, names_transform = list(member_ID = as.integer)) ## # A tibble: 942 × 4 ## key_ID member_ID female age ## &lt;dbl&gt; &lt;int&gt; &lt;int&gt; &lt;dbl&gt; ## 1 1 1 1 46 ## 2 1 2 0 81 ## 3 1 3 0 46 ## 4 2 1 0 79 ## 5 2 2 1 3 ## 6 2 3 1 47 ## 7 2 4 0 25 ## 8 2 5 0 47 ## 9 2 6 0 5 ## 10 2 7 0 71 ## # ℹ 932 more rows In this case, the syntax is a bit harder to understand. It’s good to think first what the original data looks like, and how I intend to transform it. The wide data has columns key_ID, age_1-19 and female_1-19. I don’t really want to touch the key_ID column. I want to turn the columns age_1-19 and female_1-19 into three columns: female, age and member_ID. This translates to the options we passed to pivot_longer() as follows: !key_ID: We want to pivot the data that’s in all columns except key_ID. names_to = c(\".value\", \"member_ID\"): this specifies the new columns we want to create. It basically says that the existing column names consist of two parts: one part (i.e. female and age) that we wish to keep as column names of variables that will contain my values, and one part (i.e. the numbers 1-19) which should be put into a new column which we will “member_ID”. names_sep=: this indicates how the two parts mentioned above are separated. In more difficult cases, you’ll have to use the names_pattern option. This requires some knowledge of regular expressions, so here’s two examples: If there is no seperator (age1,female1 etc…): names_pattern = \"(.*\\\\D)([0-9]+)$\". In this regular expression, .*\\\\D matches a string of any length, of any characters, as long as it ends with something other than a digit. The [0-9]+$ matches any number of digits at the end of the string. The parentheses indicate how the string should be separated to form variable names and member_ID. If the separator is used in other places in variable names (member_age_1 etc…): names_pattern = \"(.*)_([0-9]+)$\". values_drop_na = TRUE: tells R to drop rows that have missing data for all variables. This prevents the issue where we hadd too many rows. names_transform: by default, all name columns will be character types, but member_ID only contains integers, so we transform it to integer. This is completely optional. Joining (or merging) data Tidyverse has four functions to join (or merge, as Stata calls it) two data sets. The functions that differ in the way they treat observations that are in one data set but not the other. Consider the diagram below. It has two data sets, x (in Stata terms, this is the master data set) and y (the using data set in Stata terms). They have overlapping rows (area B), but also rows that are only in x (area A) or only in y (area C). The four join functions work as follows: inner_join(x,y) will only keep area B. left_join(x,y) will keep areas A and B. right_join(x,y) will keep areas B and C. full_join(x,y) will keep areas A, B, and C. There’s also filtering joins: - `semi_join(x,y)` will only keep area B, but won&#39;t add columns to X - `anti_join(x,y)`, will only keep area A, and won&#39;t add columns to X. In our case, the data sets match perfectly, i.e. we only have an area B, so there is no practical difference between the four regular joins. I chose left_join() so the number of observations in my household survey is guaranteed to remain the same. To merge the roster to the household data, we use the join_by function: read_csv(here(&quot;data/SAFI_clean.csv&quot;), na = &quot;NULL&quot;) %&gt;% left_join(wide_data) ## Rows: 131 Columns: 14 ## ── Column specification ──────────────────────────────────────────────────────── ## Delimiter: &quot;,&quot; ## chr (7): village, respondent_wall_type, memb_assoc, affect_conflicts, items... ## dbl (6): key_ID, no_membrs, years_liv, rooms, liv_count, no_meals ## dttm (1): interview_date ## ## ℹ Use `spec()` to retrieve the full column specification for this data. ## ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message. ## Joining with `by = join_by(key_ID)` ## # A tibble: 131 × 52 ## key_ID village interview_date no_membrs years_liv respondent_wall_type ## &lt;dbl&gt; &lt;chr&gt; &lt;dttm&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt; ## 1 1 God 2016-11-17 00:00:00 3 4 muddaub ## 2 2 God 2016-11-17 00:00:00 7 9 muddaub ## 3 3 God 2016-11-17 00:00:00 10 15 burntbricks ## 4 4 God 2016-11-17 00:00:00 7 6 burntbricks ## 5 5 God 2016-11-17 00:00:00 7 40 burntbricks ## 6 6 God 2016-11-17 00:00:00 3 3 muddaub ## 7 7 God 2016-11-17 00:00:00 6 38 muddaub ## 8 8 Chirodzo 2016-11-16 00:00:00 12 70 burntbricks ## 9 9 Chirodzo 2016-11-16 00:00:00 8 6 burntbricks ## 10 10 Chirodzo 2016-12-16 00:00:00 12 23 burntbricks ## # ℹ 121 more rows ## # ℹ 46 more variables: rooms &lt;dbl&gt;, memb_assoc &lt;chr&gt;, affect_conflicts &lt;chr&gt;, ## # liv_count &lt;dbl&gt;, items_owned &lt;chr&gt;, no_meals &lt;dbl&gt;, months_lack_food &lt;chr&gt;, ## # instanceID &lt;chr&gt;, female_1 &lt;int&gt;, age_1 &lt;dbl&gt;, female_2 &lt;int&gt;, age_2 &lt;dbl&gt;, ## # female_3 &lt;int&gt;, age_3 &lt;dbl&gt;, female_4 &lt;int&gt;, age_4 &lt;dbl&gt;, female_5 &lt;int&gt;, ## # age_5 &lt;dbl&gt;, female_6 &lt;int&gt;, age_6 &lt;dbl&gt;, female_7 &lt;int&gt;, age_7 &lt;dbl&gt;, ## # female_8 &lt;int&gt;, age_8 &lt;dbl&gt;, female_9 &lt;int&gt;, age_9 &lt;dbl&gt;, … Note that we didn’t specify identifiers, like we would in Stata. R assumed that the variables that appear in both data frames are the identifiers, in this case key_ID. Use the by option to change this. Going the other way around, joining the household data to the roster data, is equally easy: long_data %&gt;% left_join( read_csv(here(&quot;data/SAFI_clean.csv&quot;), na = &quot;NULL&quot;) %&gt;% select(key_ID, village, interview_date) ) ## Rows: 131 Columns: 14 ## ── Column specification ──────────────────────────────────────────────────────── ## Delimiter: &quot;,&quot; ## chr (7): village, respondent_wall_type, memb_assoc, affect_conflicts, items... ## dbl (6): key_ID, no_membrs, years_liv, rooms, liv_count, no_meals ## dttm (1): interview_date ## ## ℹ Use `spec()` to retrieve the full column specification for this data. ## ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message. ## Joining with `by = join_by(key_ID)` ## # A tibble: 942 × 6 ## key_ID member_ID female age village interview_date ## &lt;dbl&gt; &lt;int&gt; &lt;int&gt; &lt;dbl&gt; &lt;chr&gt; &lt;dttm&gt; ## 1 1 1 1 46 God 2016-11-17 00:00:00 ## 2 1 2 0 81 God 2016-11-17 00:00:00 ## 3 1 3 0 46 God 2016-11-17 00:00:00 ## 4 2 1 0 79 God 2016-11-17 00:00:00 ## 5 2 2 1 3 God 2016-11-17 00:00:00 ## 6 2 3 1 47 God 2016-11-17 00:00:00 ## 7 2 4 0 25 God 2016-11-17 00:00:00 ## 8 2 5 0 47 God 2016-11-17 00:00:00 ## 9 2 6 0 5 God 2016-11-17 00:00:00 ## 10 2 7 0 71 God 2016-11-17 00:00:00 ## # ℹ 932 more rows Note that here I only merged in two variables, by using select and a pipe within the left_join() function. Summarizing over groups (or collapsing data) Another way to transform individual-level data to household-level data is to compute summary statistics (sums, counts, means etc.). For this, we use the group_by() and summarize() functions. For example, to compute the household size, number of women and average age in each household. But before doing anything, I make sure the -99s in the age variable are treated as missing, using a simple mutate() to conver them to NA. long_data %&gt;% group_by(key_ID) %&gt;% mutate(age = if_else(age == -99, NA, age)) %&gt;% summarize( hh_size = n(), num_women = sum(female), mean_age = mean(age, na.rm = TRUE) ) ## # A tibble: 131 × 4 ## key_ID hh_size num_women mean_age ## &lt;dbl&gt; &lt;int&gt; &lt;int&gt; &lt;dbl&gt; ## 1 1 3 1 57.7 ## 2 2 7 2 39.6 ## 3 3 10 4 47.4 ## 4 4 7 3 51.6 ## 5 5 7 3 27.7 ## 6 6 3 3 24.3 ## 7 7 6 5 36.8 ## 8 8 12 7 57.8 ## 9 9 8 6 57.7 ## 10 10 12 6 29.9 ## # ℹ 121 more rows Editing many variables at once Often, you’ll to do the same operation to many variables. For example, recoding missing values. While you can copy paste the code for each variable, this may lead to errors (if you forget to change the variable name somewhere), and is tedious to maintain (if you need to change something later on. So, it’s better to do this in a programmatic way. Here’s some pointers: across(): doing the same operations on multiple variables using across The main function to do this is across(), which is used within mutate() or summarize(). For example, we need to make sure we update -99 to NA in all age_ variables in our wide data. We could write this: wide_data %&gt;% mutate(age_1 = if_else(age_1 == -99,NA,age_1), age_2 = if_else(age_2 == -99,NA,age_2), age_3 = if_else(age_3 == -99,NA,age_3), age_4 = if_else(age_4 == -99,NA,age_4), age_5 = if_else(age_5 == -99,NA,age_5), age_6 = if_else(age_6 == -99,NA,age_6), age_7 = if_else(age_7 == -99,NA,age_7), age_8 = if_else(age_8 == -99,NA,age_8), age_9 = if_else(age_9 == -99,NA,age_9), age_10 = if_else(age_10 == -99,NA,age_10), age_11 = if_else(age_11 == -99,NA,age_11), age_12 = if_else(age_12 == -99,NA,age_12), age_13 = if_else(age_13 == -99,NA,age_13), age_14 = if_else(age_14 == -99,NA,age_14), age_15 = if_else(age_15 == -99,NA,age_15), age_16 = if_else(age_16 == -99,NA,age_16), age_17 = if_else(age_17 == -99,NA,age_17), age_18 = if_else(age_18 == -99,NA,age_18), age_19 = if_else(age_19 == -99,NA,age_19) ) ## # A tibble: 131 × 39 ## key_ID female_1 age_1 female_2 age_2 female_3 age_3 female_4 age_4 female_5 ## &lt;dbl&gt; &lt;int&gt; &lt;dbl&gt; &lt;int&gt; &lt;dbl&gt; &lt;int&gt; &lt;dbl&gt; &lt;int&gt; &lt;dbl&gt; &lt;int&gt; ## 1 1 1 46 0 81 0 46 NA NA NA ## 2 2 0 79 1 3 1 47 0 25 0 ## 3 3 0 41 1 13 1 76 1 28 1 ## 4 4 0 36 0 84 1 22 0 28 0 ## 5 5 1 75 0 23 1 32 0 11 0 ## 6 6 1 59 1 4 1 10 NA NA NA ## 7 7 1 19 0 1 1 57 1 80 1 ## 8 8 1 52 0 61 0 72 1 57 0 ## 9 9 0 38 0 79 1 82 1 47 1 ## 10 10 0 39 1 22 1 27 1 22 1 ## # ℹ 121 more rows ## # ℹ 29 more variables: age_5 &lt;dbl&gt;, female_6 &lt;int&gt;, age_6 &lt;dbl&gt;, ## # female_7 &lt;int&gt;, age_7 &lt;dbl&gt;, female_8 &lt;int&gt;, age_8 &lt;dbl&gt;, female_9 &lt;int&gt;, ## # age_9 &lt;dbl&gt;, female_10 &lt;int&gt;, age_10 &lt;dbl&gt;, female_11 &lt;int&gt;, age_11 &lt;dbl&gt;, ## # female_12 &lt;int&gt;, age_12 &lt;dbl&gt;, female_13 &lt;int&gt;, age_13 &lt;dbl&gt;, ## # female_14 &lt;int&gt;, age_14 &lt;dbl&gt;, female_15 &lt;int&gt;, age_15 &lt;dbl&gt;, ## # female_16 &lt;int&gt;, age_16 &lt;dbl&gt;, female_17 &lt;int&gt;, age_17 &lt;dbl&gt;, … However, this is extremely tedious and error-prone (though AI makes this easier nowadays!), and makes your code unreusable, as it depends on the highest number of members in your data set to be exactly 19. If you have households with 20 members, or no household with more than 10, you’d have to change this code. Instead, I use the across() function, which takes two arguments: a column specifcation (for which I use tidy select syntax), and a function. It will then apply the function to all columns: cleanmissing &lt;- function(x) { if_else(x == -99, NA, x) } wide_data %&gt;% mutate(across(.cols = starts_with(&quot;age_&quot;), .fns = cleanmissing)) ## # A tibble: 131 × 39 ## key_ID female_1 age_1 female_2 age_2 female_3 age_3 female_4 age_4 female_5 ## &lt;dbl&gt; &lt;int&gt; &lt;dbl&gt; &lt;int&gt; &lt;dbl&gt; &lt;int&gt; &lt;dbl&gt; &lt;int&gt; &lt;dbl&gt; &lt;int&gt; ## 1 1 1 46 0 81 0 46 NA NA NA ## 2 2 0 79 1 3 1 47 0 25 0 ## 3 3 0 41 1 13 1 76 1 28 1 ## 4 4 0 36 0 84 1 22 0 28 0 ## 5 5 1 75 0 23 1 32 0 11 0 ## 6 6 1 59 1 4 1 10 NA NA NA ## 7 7 1 19 0 1 1 57 1 80 1 ## 8 8 1 52 0 61 0 72 1 57 0 ## 9 9 0 38 0 79 1 82 1 47 1 ## 10 10 0 39 1 22 1 27 1 22 1 ## # ℹ 121 more rows ## # ℹ 29 more variables: age_5 &lt;dbl&gt;, female_6 &lt;int&gt;, age_6 &lt;dbl&gt;, ## # female_7 &lt;int&gt;, age_7 &lt;dbl&gt;, female_8 &lt;int&gt;, age_8 &lt;dbl&gt;, female_9 &lt;int&gt;, ## # age_9 &lt;dbl&gt;, female_10 &lt;int&gt;, age_10 &lt;dbl&gt;, female_11 &lt;int&gt;, age_11 &lt;dbl&gt;, ## # female_12 &lt;int&gt;, age_12 &lt;dbl&gt;, female_13 &lt;int&gt;, age_13 &lt;dbl&gt;, ## # female_14 &lt;int&gt;, age_14 &lt;dbl&gt;, female_15 &lt;int&gt;, age_15 &lt;dbl&gt;, ## # female_16 &lt;int&gt;, age_16 &lt;dbl&gt;, female_17 &lt;int&gt;, age_17 &lt;dbl&gt;, … We can have variables for 100 household members, and this code will still work! Notes: You can use across(.cols = where(is.numeric), .fn = ...) to apply a function to all numeric variables. You can also combine across() with summarize() to summarize multiple variables more easily. See the section on faceting for an example. You can also define the function in line, if you don’t plan on using the function anywhere else: wide_data %&gt;% mutate(across(.cols = starts_with(&quot;age_&quot;), .fns = function(var) if_else(var == -99,NA, var))) ## # A tibble: 131 × 39 ## key_ID female_1 age_1 female_2 age_2 female_3 age_3 female_4 age_4 female_5 ## &lt;dbl&gt; &lt;int&gt; &lt;dbl&gt; &lt;int&gt; &lt;dbl&gt; &lt;int&gt; &lt;dbl&gt; &lt;int&gt; &lt;dbl&gt; &lt;int&gt; ## 1 1 1 46 0 81 0 46 NA NA NA ## 2 2 0 79 1 3 1 47 0 25 0 ## 3 3 0 41 1 13 1 76 1 28 1 ## 4 4 0 36 0 84 1 22 0 28 0 ## 5 5 1 75 0 23 1 32 0 11 0 ## 6 6 1 59 1 4 1 10 NA NA NA ## 7 7 1 19 0 1 1 57 1 80 1 ## 8 8 1 52 0 61 0 72 1 57 0 ## 9 9 0 38 0 79 1 82 1 47 1 ## 10 10 0 39 1 22 1 27 1 22 1 ## # ℹ 121 more rows ## # ℹ 29 more variables: age_5 &lt;dbl&gt;, female_6 &lt;int&gt;, age_6 &lt;dbl&gt;, ## # female_7 &lt;int&gt;, age_7 &lt;dbl&gt;, female_8 &lt;int&gt;, age_8 &lt;dbl&gt;, female_9 &lt;int&gt;, ## # age_9 &lt;dbl&gt;, female_10 &lt;int&gt;, age_10 &lt;dbl&gt;, female_11 &lt;int&gt;, age_11 &lt;dbl&gt;, ## # female_12 &lt;int&gt;, age_12 &lt;dbl&gt;, female_13 &lt;int&gt;, age_13 &lt;dbl&gt;, ## # female_14 &lt;int&gt;, age_14 &lt;dbl&gt;, female_15 &lt;int&gt;, age_15 &lt;dbl&gt;, ## # female_16 &lt;int&gt;, age_16 &lt;dbl&gt;, female_17 &lt;int&gt;, age_17 &lt;dbl&gt;, … Note that throughout this page, I will use different ways of defining these inline functions. They all work, so pick what you like and be consistent. Converting all yes/no factors to dummies Sometimes you want nicely labelled factors, but sometimes need dummies. Here’s one way to convert factors to dummies. First, create a fake dataset using the fantastic fabricatr package: library(fabricatr library(tidyverse) # define some parameters, so we can easily change the size of the dataset num_vars &lt;- 10 num_obs &lt;- 200 factor_data &lt;- # i make long data first, so I only need to make one factor var fabricate( N = num_obs * num_vars, n = 1:N, key_ID = ceiling(n/num_vars), var = rep(1:num_vars, N/num_vars), value = as_factor(sample(c(&quot;yes&quot;, &quot;no&quot;),N, replace = TRUE)) ) %&gt;% # and then turn it to wide to create num_var factor variables pivot_wider( id_cols = key_ID, names_from = var, values_from = value, names_glue = &quot;factor_{var}&quot; ) factor_data %&gt;% glimpse() ## Error in parse(text = input): &lt;text&gt;:2:1: unexpected symbol ## 1: library(fabricatr ## 2: library ## ^ Then we need to select all columns that solely consist of “yes” and “no” values, and convert them to 1s and 0s. The where function can do this, by using setequal() to compare the levels of factors to the vector c(\"yes\",\"no\"): factor_data %&gt;% mutate(key_ID = as.character(key_ID)) %&gt;% mutate( across( where(~setequal(levels(.x), c(&quot;yes&quot;, &quot;no&quot;))), ~as.integer(.x == &quot;yes&quot;) ) ) %&gt;% mutate(across( where(~setequal(unique(.x), 0:1)), ~factor(.x, levels = c(0, 1), labels = c(&quot;no&quot;, &quot;yes&quot;)) )) ## Error: object &#39;factor_data&#39; not found glimpse() ## Error in glimpse.default(): argument &quot;x&quot; is missing, with no default You can reverse this by using where(~setequal(unique(.x), 0:1)) to select all variables that consist solely of 0s and 1s, and then use factor() to convert them to factors with labels “no” and “yes”. Pivoting Of course, in the example above, it would have been possible to pivot the data to long first, so that we have one age variable, and no need to use across. wide_data %&gt;% pivot_longer( !key_ID, names_to = c(&quot;.value&quot;, &quot;member_ID&quot;), names_sep = &quot;_&quot;, values_drop_na = TRUE, names_transform = list(member_ID = as.integer) ) %&gt;% mutate(age = if_else(age == -99,NA,age)) %&gt;% pivot_wider(names_from = member_ID, values_from = !ends_with(&quot;_ID&quot;), names_vary = &quot;slowest&quot;) ## # A tibble: 131 × 39 ## key_ID female_1 age_1 female_2 age_2 female_3 age_3 female_4 age_4 female_5 ## &lt;dbl&gt; &lt;int&gt; &lt;dbl&gt; &lt;int&gt; &lt;dbl&gt; &lt;int&gt; &lt;dbl&gt; &lt;int&gt; &lt;dbl&gt; &lt;int&gt; ## 1 1 1 46 0 81 0 46 NA NA NA ## 2 2 0 79 1 3 1 47 0 25 0 ## 3 3 0 41 1 13 1 76 1 28 1 ## 4 4 0 36 0 84 1 22 0 28 0 ## 5 5 1 75 0 23 1 32 0 11 0 ## 6 6 1 59 1 4 1 10 NA NA NA ## 7 7 1 19 0 1 1 57 1 80 1 ## 8 8 1 52 0 61 0 72 1 57 0 ## 9 9 0 38 0 79 1 82 1 47 1 ## 10 10 0 39 1 22 1 27 1 22 1 ## # ℹ 121 more rows ## # ℹ 29 more variables: age_5 &lt;dbl&gt;, female_6 &lt;int&gt;, age_6 &lt;dbl&gt;, ## # female_7 &lt;int&gt;, age_7 &lt;dbl&gt;, female_8 &lt;int&gt;, age_8 &lt;dbl&gt;, female_9 &lt;int&gt;, ## # age_9 &lt;dbl&gt;, female_10 &lt;int&gt;, age_10 &lt;dbl&gt;, female_11 &lt;int&gt;, age_11 &lt;dbl&gt;, ## # female_12 &lt;int&gt;, age_12 &lt;dbl&gt;, female_13 &lt;int&gt;, age_13 &lt;dbl&gt;, ## # female_14 &lt;int&gt;, age_14 &lt;dbl&gt;, female_15 &lt;int&gt;, age_15 &lt;dbl&gt;, ## # female_16 &lt;int&gt;, age_16 &lt;dbl&gt;, female_17 &lt;int&gt;, age_17 &lt;dbl&gt;, … This is a bit more work, but often more flexible, and the more operations you need to do, the more worthwhile it is to pivot to long first. The pivoting approach can also be useful even if you don’t really have another level of analysis, but just repeated questions. Let’s say we have a bunch of related variables, such as expenditures on inputs: expenditures_raw &lt;- wide_data %&gt;% select(key_ID) %&gt;% # generate some repeated questions mutate(expenditures_fertilizer = rnorm(n = nrow(.)), expenditures_seeds = rnorm(n = nrow(.)), expenditures_tools = rnorm(n = nrow(.))) These variabes all contain the same type of information, and should be dealth with in the same way. We could plot and clean each variable separately, or even in a loop, but by pivoting we can do it one go, since ggplot2 expects long data. expenditures_long &lt;- expenditures_raw %&gt;% #pivot pivot_longer(cols = starts_with(&quot;expenditures_&quot;), names_to = &quot;expenditure_type&quot;, values_to = &quot;amount&quot;) expenditures_long %&gt;% ggplot(aes(x = expenditure_type, y = amount)) + geom_boxplot() We now have one plot that we can look at, and one variable to clean. Following the pattern of plotting, documenting and cleaning, we notice negative values of expenditures here. That’s not possible, so I set them to 0 (though in the real world I’d have to argue why not NA), and pivot back to wide: expenditures_cleaned &lt;- expenditures_long %&gt;% mutate(amount = if_else(amount &lt; 0, 0, amount)) %&gt;% pivot_wider(names_from = expenditure_type, values_from = amount) Now you have a dataframe with a bunch of variables, ready to be merged in with the rest. Using many variables as inputs Suppose we wanted to use many variables as input for a calculation. For example to get the household size, number of women and average age from our wide data. The easiest, and probably best, way to do this in R is by reshaping to long, and then use summarize, like we did above. But in Stata you would probably use some sort of egen function, so that may come natural. To compute means and sums across rows in R, use rowSums() and rowMeans(): wide_data %&gt;% mutate(across(.cols = starts_with(&quot;age_&quot;), .fn = ~if_else(.x == -99,NA,.x))) %&gt;% mutate(mean_age = rowMeans(across(starts_with(&quot;age_&quot;)), na.rm=TRUE), num_women = rowSums(across(starts_with(&quot;female_&quot;)), na.rm=TRUE), hh_size = rowSums(!is.na(across(starts_with(&quot;female_&quot;))))) %&gt;% select(key_ID,hh_size,num_women, mean_age) %&gt;% ungroup() ## # A tibble: 131 × 4 ## key_ID hh_size num_women mean_age ## &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; ## 1 1 3 1 57.7 ## 2 2 7 2 39.6 ## 3 3 10 4 47.4 ## 4 4 7 3 51.6 ## 5 5 7 3 27.7 ## 6 6 3 3 24.3 ## 7 7 6 5 36.8 ## 8 8 12 7 57.8 ## 9 9 8 6 57.7 ## 10 10 12 6 29.9 ## # ℹ 121 more rows If you want to compute something other than means or sums, you can use rowwise() andc_across() to get a bunch of variables into any function you want: wide_data %&gt;% mutate(across(.cols = starts_with(&quot;age_&quot;), .fn = ~if_else(.x == -99,NA,.x))) %&gt;% rowwise() %&gt;% mutate(max_age = max(c_across(starts_with(&quot;age_&quot;)), na.rm=TRUE), sd_age = sd(c_across(starts_with(&quot;age_&quot;)), na.rm=TRUE)) %&gt;% select(key_ID,max_age,sd_age) %&gt;% ungroup() ## # A tibble: 131 × 3 ## key_ID max_age sd_age ## &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; ## 1 1 81 20.2 ## 2 2 79 30.0 ## 3 3 83 26.9 ## 4 4 85 31.3 ## 5 5 75 25.0 ## 6 6 59 30.2 ## 7 7 80 31.0 ## 8 8 83 13.6 ## 9 9 82 25.0 ## 10 10 65 18.2 ## # ℹ 121 more rows rowwise() ensures all summaries are computed per row, and c_across() allows you to use tidy select syntax within any function. Do note that while this is very flexible, it can be EXTREMELY slow, as all computations are done row by row. If you have a large dataset, it’s probably faster to pivot the data to long first. Renaming many variables While the pivoting option we discussed above is great, it does assume your variable names make sense. This is not always the case, so sometimes you need to rename a bunch of variables: One way is to use a named list: # this follows the pattern new_name = old_name newnames &lt;- c(&quot;no_livestock&quot; = &quot;liv_count&quot;, &quot;no_rooms&quot; = &quot;rooms&quot;, &quot;affect_conflicts&quot; = &quot;ffect_conflicts&quot;) read_csv(here(&quot;data/SAFI_clean.csv&quot;), na = &quot;NULL&quot;) %&gt;% rename(any_of(newnames)) %&gt;% glimpse() ## Rows: 131 ## Columns: 14 ## $ key_ID &lt;dbl&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15… ## $ village &lt;chr&gt; &quot;God&quot;, &quot;God&quot;, &quot;God&quot;, &quot;God&quot;, &quot;God&quot;, &quot;God&quot;, &quot;God&quot;, … ## $ interview_date &lt;dttm&gt; 2016-11-17, 2016-11-17, 2016-11-17, 2016-11-17, … ## $ no_membrs &lt;dbl&gt; 3, 7, 10, 7, 7, 3, 6, 12, 8, 12, 6, 7, 6, 10, 5, … ## $ years_liv &lt;dbl&gt; 4, 9, 15, 6, 40, 3, 38, 70, 6, 23, 20, 20, 8, 20,… ## $ respondent_wall_type &lt;chr&gt; &quot;muddaub&quot;, &quot;muddaub&quot;, &quot;burntbricks&quot;, &quot;burntbricks… ## $ no_rooms &lt;dbl&gt; 1, 1, 1, 1, 1, 1, 1, 3, 1, 5, 1, 3, 1, 3, 2, 1, 1… ## $ memb_assoc &lt;chr&gt; NA, &quot;yes&quot;, NA, NA, NA, NA, &quot;no&quot;, &quot;yes&quot;, &quot;no&quot;, &quot;no… ## $ affect_conflicts &lt;chr&gt; NA, &quot;once&quot;, NA, NA, NA, NA, &quot;never&quot;, &quot;never&quot;, &quot;ne… ## $ no_livestock &lt;dbl&gt; 1, 3, 1, 2, 4, 1, 1, 2, 3, 2, 2, 2, 3, 3, 3, 4, 1… ## $ items_owned &lt;chr&gt; &quot;bicycle;television;solar_panel;table&quot;, &quot;cow_cart… ## $ no_meals &lt;dbl&gt; 2, 2, 2, 2, 2, 2, 3, 2, 3, 3, 2, 3, 2, 3, 2, 3, 2… ## $ months_lack_food &lt;chr&gt; &quot;Jan&quot;, &quot;Jan;Sept;Oct;Nov;Dec&quot;, &quot;Jan;Feb;Mar;Oct;N… ## $ instanceID &lt;chr&gt; &quot;uuid:ec241f2c-0609-46ed-b5e8-fe575f6cefef&quot;, &quot;uui… Note that \"affect_conflicts\" = \"ffect_conflicts\" didn’t do anything, as there is no ffect_conflicts variable. any_of() just ignored any variables not present in the data. This can be useful in data pipelines using multiple files, where some files have mistyped variable names. What if we want to do the same thing to many variables? For example, turning them all to uppercase? We could use newnames = c(KEY_ID = key_ID, VILLAGE = village) etc. etc., but that’d be extremely tedious. Instead, there is rename_with(), which takes two arugments: .fn: A function that takes the variable names of your dataset as an argument. .cols: a tidy select statement defining which columns to change. Defaults to all columns. This is what it’d look like: read_csv(here(&quot;data/SAFI_clean.csv&quot;), na = &quot;NULL&quot;) %&gt;% rename_with(.fn = toupper) %&gt;% glimpse() ## Rows: 131 ## Columns: 14 ## $ KEY_ID &lt;dbl&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15… ## $ VILLAGE &lt;chr&gt; &quot;God&quot;, &quot;God&quot;, &quot;God&quot;, &quot;God&quot;, &quot;God&quot;, &quot;God&quot;, &quot;God&quot;, … ## $ INTERVIEW_DATE &lt;dttm&gt; 2016-11-17, 2016-11-17, 2016-11-17, 2016-11-17, … ## $ NO_MEMBRS &lt;dbl&gt; 3, 7, 10, 7, 7, 3, 6, 12, 8, 12, 6, 7, 6, 10, 5, … ## $ YEARS_LIV &lt;dbl&gt; 4, 9, 15, 6, 40, 3, 38, 70, 6, 23, 20, 20, 8, 20,… ## $ RESPONDENT_WALL_TYPE &lt;chr&gt; &quot;muddaub&quot;, &quot;muddaub&quot;, &quot;burntbricks&quot;, &quot;burntbricks… ## $ ROOMS &lt;dbl&gt; 1, 1, 1, 1, 1, 1, 1, 3, 1, 5, 1, 3, 1, 3, 2, 1, 1… ## $ MEMB_ASSOC &lt;chr&gt; NA, &quot;yes&quot;, NA, NA, NA, NA, &quot;no&quot;, &quot;yes&quot;, &quot;no&quot;, &quot;no… ## $ AFFECT_CONFLICTS &lt;chr&gt; NA, &quot;once&quot;, NA, NA, NA, NA, &quot;never&quot;, &quot;never&quot;, &quot;ne… ## $ LIV_COUNT &lt;dbl&gt; 1, 3, 1, 2, 4, 1, 1, 2, 3, 2, 2, 2, 3, 3, 3, 4, 1… ## $ ITEMS_OWNED &lt;chr&gt; &quot;bicycle;television;solar_panel;table&quot;, &quot;cow_cart… ## $ NO_MEALS &lt;dbl&gt; 2, 2, 2, 2, 2, 2, 3, 2, 3, 3, 2, 3, 2, 3, 2, 3, 2… ## $ MONTHS_LACK_FOOD &lt;chr&gt; &quot;Jan&quot;, &quot;Jan;Sept;Oct;Nov;Dec&quot;, &quot;Jan;Feb;Mar;Oct;N… ## $ INSTANCEID &lt;chr&gt; &quot;uuid:ec241f2c-0609-46ed-b5e8-fe575f6cefef&quot;, &quot;uui… The variables names are used as the argument to toupper(), which returns them in upper case. But what if we need to provide more arguments? Let’s say we want to append _0 to all columns, except the ID columns, to indicate this is baseline data. We use paste0() which takes two arguments, the variable name and string we wish to append: read_csv(here(&quot;data/SAFI_clean.csv&quot;), na = &quot;NULL&quot;) %&gt;% rename_with(.fn = ~paste0(.x, &quot;_0&quot;), .cols = !key_ID) %&gt;% glimpse() ## Rows: 131 ## Columns: 14 ## $ key_ID &lt;dbl&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, … ## $ village_0 &lt;chr&gt; &quot;God&quot;, &quot;God&quot;, &quot;God&quot;, &quot;God&quot;, &quot;God&quot;, &quot;God&quot;, &quot;God&quot;… ## $ interview_date_0 &lt;dttm&gt; 2016-11-17, 2016-11-17, 2016-11-17, 2016-11-17… ## $ no_membrs_0 &lt;dbl&gt; 3, 7, 10, 7, 7, 3, 6, 12, 8, 12, 6, 7, 6, 10, 5… ## $ years_liv_0 &lt;dbl&gt; 4, 9, 15, 6, 40, 3, 38, 70, 6, 23, 20, 20, 8, 2… ## $ respondent_wall_type_0 &lt;chr&gt; &quot;muddaub&quot;, &quot;muddaub&quot;, &quot;burntbricks&quot;, &quot;burntbric… ## $ rooms_0 &lt;dbl&gt; 1, 1, 1, 1, 1, 1, 1, 3, 1, 5, 1, 3, 1, 3, 2, 1,… ## $ memb_assoc_0 &lt;chr&gt; NA, &quot;yes&quot;, NA, NA, NA, NA, &quot;no&quot;, &quot;yes&quot;, &quot;no&quot;, &quot;… ## $ affect_conflicts_0 &lt;chr&gt; NA, &quot;once&quot;, NA, NA, NA, NA, &quot;never&quot;, &quot;never&quot;, &quot;… ## $ liv_count_0 &lt;dbl&gt; 1, 3, 1, 2, 4, 1, 1, 2, 3, 2, 2, 2, 3, 3, 3, 4,… ## $ items_owned_0 &lt;chr&gt; &quot;bicycle;television;solar_panel;table&quot;, &quot;cow_ca… ## $ no_meals_0 &lt;dbl&gt; 2, 2, 2, 2, 2, 2, 3, 2, 3, 3, 2, 3, 2, 3, 2, 3,… ## $ months_lack_food_0 &lt;chr&gt; &quot;Jan&quot;, &quot;Jan;Sept;Oct;Nov;Dec&quot;, &quot;Jan;Feb;Mar;Oct… ## $ instanceID_0 &lt;chr&gt; &quot;uuid:ec241f2c-0609-46ed-b5e8-fe575f6cefef&quot;, &quot;u… In this case, we specify the function as a a purrr-style inline anonymous function (i.e. preceded by a ~), and we supply the variable names as .x. (This all works the same as across() above.) Now, let’s replace all instances of membrs or memb in variable names with members (so no_membrs becomes no_members, and memb_assoc becomes members_assoc. For this I will use gsub(), which takes three arguments: A pattern (expressed as a regular expression) to look for; a replacement for all matches of the pattern; and, the data to look in (in this case the varaible names). read_csv(here(&quot;data/SAFI_clean.csv&quot;), na = &quot;NULL&quot;) %&gt;% rename_with(.fn = ~gsub(&quot;membrs|memb&quot;, &quot;members&quot;,.x)) %&gt;% glimpse() ## Rows: 131 ## Columns: 14 ## $ key_ID &lt;dbl&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15… ## $ village &lt;chr&gt; &quot;God&quot;, &quot;God&quot;, &quot;God&quot;, &quot;God&quot;, &quot;God&quot;, &quot;God&quot;, &quot;God&quot;, … ## $ interview_date &lt;dttm&gt; 2016-11-17, 2016-11-17, 2016-11-17, 2016-11-17, … ## $ no_members &lt;dbl&gt; 3, 7, 10, 7, 7, 3, 6, 12, 8, 12, 6, 7, 6, 10, 5, … ## $ years_liv &lt;dbl&gt; 4, 9, 15, 6, 40, 3, 38, 70, 6, 23, 20, 20, 8, 20,… ## $ respondent_wall_type &lt;chr&gt; &quot;muddaub&quot;, &quot;muddaub&quot;, &quot;burntbricks&quot;, &quot;burntbricks… ## $ rooms &lt;dbl&gt; 1, 1, 1, 1, 1, 1, 1, 3, 1, 5, 1, 3, 1, 3, 2, 1, 1… ## $ members_assoc &lt;chr&gt; NA, &quot;yes&quot;, NA, NA, NA, NA, &quot;no&quot;, &quot;yes&quot;, &quot;no&quot;, &quot;no… ## $ affect_conflicts &lt;chr&gt; NA, &quot;once&quot;, NA, NA, NA, NA, &quot;never&quot;, &quot;never&quot;, &quot;ne… ## $ liv_count &lt;dbl&gt; 1, 3, 1, 2, 4, 1, 1, 2, 3, 2, 2, 2, 3, 3, 3, 4, 1… ## $ items_owned &lt;chr&gt; &quot;bicycle;television;solar_panel;table&quot;, &quot;cow_cart… ## $ no_meals &lt;dbl&gt; 2, 2, 2, 2, 2, 2, 3, 2, 3, 3, 2, 3, 2, 3, 2, 3, 2… ## $ months_lack_food &lt;chr&gt; &quot;Jan&quot;, &quot;Jan;Sept;Oct;Nov;Dec&quot;, &quot;Jan;Feb;Mar;Oct;N… ## $ instanceID &lt;chr&gt; &quot;uuid:ec241f2c-0609-46ed-b5e8-fe575f6cefef&quot;, &quot;uui… Splitting multi-response variable into dummies The SAFI data contains a number of columns that contain all responses selected in a multiple response questions. For example, the variables items_owned can contain something like \"bicycle;television;solar_panel;table\". We want to split this into dummies: one for each possible answers. There’s a number of ways to do this, but the most convenient is using separate_longer() read_csv(here(&quot;data/SAFI_clean.csv&quot;), na = &quot;NULL&quot;) %&gt;% separate_longer_delim(items_owned, delim = &quot;;&quot;) %&gt;% mutate(value = 1) %&gt;% pivot_wider(names_from = items_owned, values_from = value, names_glue = &quot;owns_{items_owned}&quot;, values_fill = 0) %&gt;% left_join( read_csv(here(&quot;data/SAFI_clean.csv&quot;), na = &quot;NULL&quot;) %&gt;% select(key_ID,items_owned)) %&gt;% select(items_owned, starts_with(&quot;owns_&quot;) ) %&gt;% head() ## # A tibble: 6 × 19 ## items_owned owns_bicycle owns_television owns_solar_panel owns_table ## &lt;chr&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; ## 1 bicycle;television;s… 1 1 1 1 ## 2 cow_cart;bicycle;rad… 1 0 1 1 ## 3 solar_torch 0 0 0 0 ## 4 bicycle;radio;cow_pl… 1 0 1 0 ## 5 motorcyle;radio;cow_… 0 0 0 0 ## 6 &lt;NA&gt; 0 0 0 0 ## # ℹ 14 more variables: owns_cow_cart &lt;dbl&gt;, owns_radio &lt;dbl&gt;, ## # owns_cow_plough &lt;dbl&gt;, owns_solar_torch &lt;dbl&gt;, owns_mobile_phone &lt;dbl&gt;, ## # owns_motorcyle &lt;dbl&gt;, owns_NA &lt;dbl&gt;, owns_fridge &lt;dbl&gt;, ## # owns_electricity &lt;dbl&gt;, owns_sofa_set &lt;dbl&gt;, owns_lorry &lt;dbl&gt;, ## # owns_sterio &lt;dbl&gt;, owns_computer &lt;dbl&gt;, owns_car &lt;dbl&gt; Note that the original items_owned variable is lost during the separate_longer_delim() step, so I used left_join() to merge it back in for demonstration purposes. Structure of a cleaning Rmarkdown doc with multi-level data Putting it all together in one script, would look something like this. The rendered document can be shared more freely than the data, and includes everything to explain what happens to the data, including figures. This makes it much more insightful to share this document than the raw cleaning code. --- title: &quot;Example Data Cleaning RMarkdown&quot; output: html_document --- # introduction This is an example of a data cleaning RMarkdown script for multi-level data (household and individual level). It takes the raw data files in the data/raw folder, and outputs a cleaned data file in the data/cleaned folder. The cleaned dataset is ready to be used in analyses. This script uses the the tidyverse and here packages. Packages are managed with renv, so details on package versions can be found in the lock file. # loading libraries ```{r} library(tidyverse) library(here) ``` # loading raw data ```{r} raw_data_hh &lt;- read_csv(here(&quot;data/raw/SAFI_clean.csv&quot;), na = &quot;NULL&quot;) raw_data_individual &lt;- read_csv(here(&quot;data/raw/SAFI_roster.csv&quot;), na = &quot;NULL&quot;) ``` # data cleaning ## paradata We create a data object with all the IDs that we need for our anaylsis. We only include observations from the village Chirodzo, and interviews done between November 16th 2016 and January 1st 2017, for reasons that really should be explained here: ```{r} paradata &lt;- raw_data_hh %&gt;% mutate(day = day(interview_date), month = month(interview_date), year = year(interview_date)) %&gt;% filter(village == &quot;Chirodzo&quot;) %&gt;% filter(interview_date &gt; &quot;2016-11-16&quot; &amp; interview_date &lt; &quot;2017-01-01&quot;) %&gt;% select(key_ID, interview_date, day, month, year, village) ``` ## housing We compute people per room, and recode wall type: ```{r} housing &lt;- raw_data_hh %&gt;% mutate( people_per_room = no_membrs / rooms, respondent_wall_type = as_factor(respondent_wall_type), respondent_wall_type = fct_recode( respondent_wall_type, &quot;Burned bricks&quot; = &quot;burntbricks&quot;, &quot;Mud Daub&quot; = &quot;muddaub&quot;, &quot;Sun bricks&quot; = &quot;sunbricks&quot; ) ) %&gt;% select(key_ID, no_membrs, rooms, people_per_room, respondent_wall_type) ``` ## years_liv We plot years_live to check if there are outliers: ```{r} # years_liv cleaning raw_data_hh%&gt;% ggplot(aes(x = years_liv)) + geom_boxplot() ``` Anything higher than 90 years seems unlikely, so we set those to NA: ```{r} years_liv_clean &lt;- raw_data_hh %&gt;% select(key_ID, years_liv) %&gt;% mutate(years_liv = if_else(years_liv &gt; 90, NA, years_liv)) ``` ## items_owned We generate dummies based on the seet items_owned variable: ```{r} items_owned &lt;- raw_data_hh %&gt;% select(key_ID, items_owned) %&gt;% filter(!is.na(items_owned)) %&gt;% # non-answers are considered missing separate_longer_delim(items_owned, delim = &quot;;&quot;) %&gt;% mutate(value = 1) %&gt;% pivot_wider(names_from = items_owned, values_from = value, names_glue = &quot;owns_{items_owned}&quot;, values_fill = 0) %&gt;% select(key_ID, starts_with(&quot;owns_&quot;)) ``` Note that we set non-answers to missing by filtering them out (leading to NAs in the final merged dataset), because we assume this is because the questions is skipped, but we can&#39;t be sure (this is why there should always be a &#39;none&#39; option in such questions!). ## househod roster We reshape the household roster to wide format: ```{r} # individual level clean_data_individual &lt;- raw_data_individual %&gt;% mutate(age = if_else(age == -99,NA,age)) %&gt;% pivot_wider(names_from = member_ID, values_from = !ends_with(&quot;_ID&quot;), names_vary = &quot;slowest&quot;) ``` And we compute some summary statistics at the household level: ```{r} household_size &lt;- raw_data_individual %&gt;% group_by(key_ID) %&gt;% mutate(age = if_else(age == -99,NA,age)) %&gt;% summarize(hh_size = n(), num_women = sum(female), mean_age = mean(age, na.rm = TRUE)) ``` ## conflict ```{r} conflict &lt;- raw_data_hh %&gt;% mutate(conflict_yn = case_when(affect_conflicts == &quot;frequently&quot; ~ 1, affect_conflicts == &quot;more_once&quot; ~ 1, affect_conflicts == &quot;once&quot; ~ 1, affect_conflicts == &quot;never&quot; ~ 0, .default = NA)) %&gt;% select(key_ID, conflict_yn) ``` # join and save We join all clenaed ojects together, and save it in the clean data folder: ```{r} clean_data &lt;- paradata %&gt;% left_join(housing) %&gt;% left_join(years_liv_clean) %&gt;% left_join(clean_data_individual) %&gt;% left_join(household_size) %&gt;% left_join(items_owned) %&gt;% left_join(conflict) # saving clean data for later use clean_data %&gt;% saveRDS(here(&quot;data/clean/SAFI_cleaner.rds&quot;)) ``` "],["reporting.html", "5. Estimating and reporting Generating some fake data Making a table of summary statistics Regression Tables Plots", " 5. Estimating and reporting This chapter uses a large number of packages, and the SAFI data set, so make sure all are downloaded by running the code from the Set-up section. I will create a table of descriptive statistics, and a simple regression table. Generating some fake data First we make a fake intervention aimed at improving fertilizer adoption. Adoption depends on the treatment and education and a random component. The page on DeclareDesign has more advanced techniques to generate fake data. library(tidyverse) library(here) library(modelsummary) library(flextable) library(estimatr) library(lmtest) library(clubSandwich) rm(list=ls()) set.seed(1) data &lt;- read_csv(here(&quot;data/SAFI_clean.csv&quot;), na = &quot;NULL&quot;) %&gt;% left_join({.} %&gt;% select(village) %&gt;% distinct(village) %&gt;% rowwise %&gt;% mutate(treatment = rbinom(1,1,0.5)))%&gt;% rowwise() %&gt;% mutate(educated = rbinom(1,1,0.3), u = sample(c(0.1,0.2,0.3),1), prob = 0.3 * treatment + 0.1 * educated + u, uses_fertilizer = rbinom(1,1,prob)) %&gt;% ungroup() %&gt;% select(-prob,-u) Making a table of summary statistics Using modelsummary and flextable The modelsummary package is the most convenient to create tables. To convert them to word, I use the flextable package. For a simple table of descriptive statistics, use the datasummary() function. I also define a vector with variable labels, which I use throughout this chapter. Below, I use it in the labelizor() function, which applies labels to a flextable object. I also apply the autofit() and fix_border_issues() functions to make the table look nicer. library(modelsummary) library(flextable) # vector for labelling variable names labels = c(no_membrs = &quot;# HH Members&quot;, years_liv = &quot;Year in village&quot;, rooms = &quot;# Rooms&quot;, liv_count = &quot;# Livestock&quot;, no_meals = &quot;# Meals&quot;, treatment = &quot;Treated&quot;, educated = &quot;Educated&quot;, uses_fertilizer = &quot;Uses fertilizer&quot;, `(Intercept)` = &quot;Constant&quot;) # descriptive stats data %&gt;% select(where(is.numeric), -ends_with(&quot;ID&quot;)) %&gt;% datasummary(All(.) ~ Mean + SD + min + max + Histogram , data = ., output = &quot;flextable&quot;) %&gt;% labelizor(j =1,labels = labels, part = &quot;all&quot;)%&gt;% fix_border_issues() %&gt;% autofit() .cl-cc31a1a4{}.cl-cc2bc766{font-family:'DejaVu Sans';font-size:11pt;font-weight:normal;font-style:normal;text-decoration:none;color:rgba(0, 0, 0, 1.00);background-color:transparent;}.cl-cc2e3b36{margin:0;text-align:left;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);padding-bottom:5pt;padding-top:5pt;padding-left:5pt;padding-right:5pt;line-height: 1;background-color:transparent;}.cl-cc2e56ca{width:1.312in;background-color:transparent;vertical-align: middle;border-bottom: 1.5pt solid rgba(102, 102, 102, 1.00);border-top: 1.5pt solid rgba(102, 102, 102, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cc2e56d4{width:0.667in;background-color:transparent;vertical-align: middle;border-bottom: 1.5pt solid rgba(102, 102, 102, 1.00);border-top: 1.5pt solid rgba(102, 102, 102, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cc2e56d5{width:0.582in;background-color:transparent;vertical-align: middle;border-bottom: 1.5pt solid rgba(102, 102, 102, 1.00);border-top: 1.5pt solid rgba(102, 102, 102, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cc2e56de{width:0.981in;background-color:transparent;vertical-align: middle;border-bottom: 1.5pt solid rgba(102, 102, 102, 1.00);border-top: 1.5pt solid rgba(102, 102, 102, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cc2e56df{width:1.312in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cc2e56e0{width:0.667in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cc2e56e8{width:0.582in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cc2e56f2{width:0.981in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cc2e56f3{width:1.312in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cc2e56fc{width:0.667in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cc2e56fd{width:0.582in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cc2e5706{width:0.981in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cc2e5707{width:1.312in;background-color:transparent;vertical-align: middle;border-bottom: 1.5pt solid rgba(102, 102, 102, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cc2e5710{width:0.667in;background-color:transparent;vertical-align: middle;border-bottom: 1.5pt solid rgba(102, 102, 102, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cc2e5711{width:0.582in;background-color:transparent;vertical-align: middle;border-bottom: 1.5pt solid rgba(102, 102, 102, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cc2e5724{width:0.981in;background-color:transparent;vertical-align: middle;border-bottom: 1.5pt solid rgba(102, 102, 102, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;} MeanSDminmaxHistogram# HH Members7.193.172.0019.00▂▅▇▂▃▂▁Year in village23.0516.911.0096.00▆▇▆▁▂▁# Rooms1.741.091.008.00▇▃▂# Livestock2.371.081.005.00▆▅▇▂# Meals2.600.492.003.00▅▇Treated0.370.490.001.00▇▄Educated0.300.460.001.00▇▃Uses fertilizer0.340.480.001.00▇▄ Flextables can be easily exported to Word using the save_as_docx() function. Balance Table Using modelsummary’s datasummary_balance() table function, it is easy to create a balance table: treat_labels &lt;- c(&quot;0&quot; = &quot;Control&quot;, &quot;1&quot; = &quot;Treated&quot;) # balance table data %&gt;% select(where(is.numeric), -ends_with(&quot;ID&quot;)) %&gt;% datasummary_balance( ~ treatment , data = ., output = &quot;flextable&quot;, stars = TRUE, dinm = TRUE, dinm_statistic = &quot;p.value&quot;) %&gt;% labelizor(j =1,labels = labels, part = &quot;all&quot;)%&gt;% labelizor(labels = treat_labels, part = &quot;header&quot;)%&gt;% fix_border_issues() %&gt;% autofit() .cl-cc5d99ee{}.cl-cc57971a{font-family:'DejaVu Sans';font-size:11pt;font-weight:normal;font-style:normal;text-decoration:none;color:rgba(0, 0, 0, 1.00);background-color:transparent;}.cl-cc5a13b4{margin:0;text-align:left;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);padding-bottom:5pt;padding-top:5pt;padding-left:5pt;padding-right:5pt;line-height: 1;background-color:transparent;}.cl-cc5a2f8e{width:1.312in;background-color:transparent;vertical-align: middle;border-bottom: 1.5pt solid rgba(102, 102, 102, 1.00);border-top: 1.5pt solid rgba(102, 102, 102, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cc5a2f98{width:0.667in;background-color:transparent;vertical-align: middle;border-bottom: 1.5pt solid rgba(102, 102, 102, 1.00);border-top: 1.5pt solid rgba(102, 102, 102, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cc5a2fa2{width:0.914in;background-color:transparent;vertical-align: middle;border-bottom: 1.5pt solid rgba(102, 102, 102, 1.00);border-top: 1.5pt solid rgba(102, 102, 102, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cc5a2fac{width:0.71in;background-color:transparent;vertical-align: middle;border-bottom: 1.5pt solid rgba(102, 102, 102, 1.00);border-top: 1.5pt solid rgba(102, 102, 102, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cc5a2fad{width:0.956in;background-color:transparent;vertical-align: middle;border-bottom: 1.5pt solid rgba(102, 102, 102, 1.00);border-top: 1.5pt solid rgba(102, 102, 102, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cc5a2fb6{width:1.219in;background-color:transparent;vertical-align: middle;border-bottom: 1.5pt solid rgba(102, 102, 102, 1.00);border-top: 1.5pt solid rgba(102, 102, 102, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cc5a2fc0{width:0.667in;background-color:transparent;vertical-align: middle;border-bottom: 1.5pt solid rgba(102, 102, 102, 1.00);border-top: 1.5pt solid rgba(102, 102, 102, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cc5a2fc1{width:1.312in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cc5a2fca{width:0.667in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cc5a2fcb{width:0.914in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cc5a2fd4{width:0.71in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cc5a2fde{width:0.956in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cc5a2fdf{width:1.219in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cc5a2fe8{width:0.667in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cc5a2fe9{width:1.312in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cc5a2ff2{width:0.667in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cc5a2ffc{width:0.914in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cc5a2ffd{width:0.71in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cc5a3006{width:0.956in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cc5a3010{width:1.219in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cc5a301a{width:0.667in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cc5a301b{width:1.312in;background-color:transparent;vertical-align: middle;border-bottom: 1.5pt solid rgba(102, 102, 102, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cc5a3024{width:0.667in;background-color:transparent;vertical-align: middle;border-bottom: 1.5pt solid rgba(102, 102, 102, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cc5a302e{width:0.914in;background-color:transparent;vertical-align: middle;border-bottom: 1.5pt solid rgba(102, 102, 102, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cc5a302f{width:0.71in;background-color:transparent;vertical-align: middle;border-bottom: 1.5pt solid rgba(102, 102, 102, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cc5a3038{width:0.956in;background-color:transparent;vertical-align: middle;border-bottom: 1.5pt solid rgba(102, 102, 102, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cc5a3039{width:1.219in;background-color:transparent;vertical-align: middle;border-bottom: 1.5pt solid rgba(102, 102, 102, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cc5a303a{width:0.667in;background-color:transparent;vertical-align: middle;border-bottom: 1.5pt solid rgba(102, 102, 102, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;} ControlTreated MeanStd. Dev.Mean Std. Dev. Diff. in Meansp# HH Members7.02.97.63.60.60.320Year in village21.914.924.919.83.00.366# Rooms1.71.21.71.0-0.00.961# Livestock2.21.02.61.20.30.107# Meals2.60.52.60.50.00.594Educated0.30.50.30.50.00.873Uses fertilizer0.20.40.50.50.3**0.003 Advanced: Using only Flextable For more control, the flextable package can convert data frames into good-looking tables using the tabulator() function. First, make a data frame with summary statistics. I duplicate the data set using bind_rows() to create an overall group. Then I use summarize(across(...)) to apply summarizing functionsto a number of variables. summstats &lt;- bind_rows(data %&gt;% mutate(Treatment = ifelse(treatment, &quot; Treatment&quot;, &quot; Control&quot;)), data %&gt;% mutate(Treatment = &quot;Overall&quot;)) %&gt;% mutate(Treatment = factor(Treatment)) %&gt;% select(where(is.numeric),Treatment,-key_ID,-treatment) %&gt;% group_by(Treatment) %&gt;% summarize(across(.cols = everything(), .fns = list(n = ~sum(!is.na(.x)), nmiss = ~sum(is.na(.x)), mean = ~mean(.x,na.rm=TRUE), sd = ~sd(.x,na.rm=TRUE), min = ~min(.x,na.rm=TRUE), max = ~max(.x,na.rm=TRUE), iqr = ~IQR(.x,na.rm=TRUE)), .names = &quot;{.col}-{.fn}&quot;)) %&gt;% pivot_longer(cols = -Treatment, names_to = c(&quot;Variable&quot;,&quot;.value&quot;), names_sep=&quot;-&quot;) summstats ## # A tibble: 21 × 9 ## Treatment Variable n nmiss mean sd min max iqr ## &lt;fct&gt; &lt;chr&gt; &lt;int&gt; &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; ## 1 &quot; Control&quot; no_membrs 82 0 6.96 2.86 2 15 3.75 ## 2 &quot; Control&quot; years_liv 82 0 21.9 14.9 1 70 13.8 ## 3 &quot; Control&quot; rooms 82 0 1.74 1.17 1 8 1 ## 4 &quot; Control&quot; liv_count 82 0 2.24 1.01 1 4 2 ## 5 &quot; Control&quot; no_meals 82 0 2.59 0.496 2 3 1 ## 6 &quot; Control&quot; educated 82 0 0.293 0.458 0 1 1 ## 7 &quot; Control&quot; uses_fertilizer 82 0 0.244 0.432 0 1 0 ## 8 &quot; Treatment&quot; no_membrs 49 0 7.57 3.64 2 19 5 ## 9 &quot; Treatment&quot; years_liv 49 0 24.9 19.8 2 96 22 ## 10 &quot; Treatment&quot; rooms 49 0 1.73 0.953 1 4 1 ## # ℹ 11 more rows Then use I flextable’s tabulator() to make output that looks good in word. Note that tabulator() sorts the columns alphabetically, so that would be control - overall - treatment. That doesn’t make sense, so I have used spaces (\" Treatment\") to control the ordering. I’ve added a bunch of statistics to show the flexibility: library(flextable) summstats %&gt;% tabulator(rows = &quot;Variable&quot;, columns = &quot;Treatment&quot;, `N` = as_paragraph(as_chunk(n,digits=0)), `Mean (SD)` = as_paragraph(as_chunk(fmt_avg_dev(mean, sd, digit1=2,digit2 = 2))), Range = as_paragraph(as_chunk(min,digits=3), &quot;-&quot;,as_chunk(max,digits=3)) ) %&gt;% as_flextable() .cl-cca2b7b8{}.cl-cc9a67ac{font-family:'DejaVu Sans';font-size:11pt;font-weight:normal;font-style:normal;text-decoration:none;color:rgba(0, 0, 0, 1.00);background-color:transparent;}.cl-cc9eae70{margin:0;text-align:left;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);padding-bottom:5pt;padding-top:5pt;padding-left:5pt;padding-right:5pt;line-height: 1;background-color:transparent;}.cl-cc9eae7a{margin:0;text-align:center;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);padding-bottom:0;padding-top:0;padding-left:0;padding-right:0;line-height: 1;background-color:transparent;}.cl-cc9eae7b{margin:0;text-align:center;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);padding-bottom:5pt;padding-top:5pt;padding-left:5pt;padding-right:5pt;line-height: 1;background-color:transparent;}.cl-cc9eae84{margin:0;text-align:left;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);padding-bottom:0;padding-top:0;padding-left:0;padding-right:0;line-height: 1;background-color:transparent;}.cl-cc9eae85{margin:0;text-align:left;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);padding-bottom:5pt;padding-top:5pt;padding-left:5pt;padding-right:5pt;line-height: 1;background-color:transparent;}.cl-cc9eae8e{margin:0;text-align:left;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);padding-bottom:0;padding-top:0;padding-left:0;padding-right:0;line-height: 1;background-color:transparent;}.cl-cc9eae8f{margin:0;text-align:center;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);padding-bottom:5pt;padding-top:5pt;padding-left:5pt;padding-right:5pt;line-height: 1;background-color:transparent;}.cl-cc9ed5bc{width:1.206in;background-color:transparent;vertical-align: bottom;border-bottom: 1.5pt solid rgba(102, 102, 102, 1.00);border-top: 1.5pt solid rgba(102, 102, 102, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cc9ed5c6{width:0.079in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(102, 102, 102, 1.00);border-top: 0 solid rgba(102, 102, 102, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cc9ed5c7{width:0.434in;background-color:transparent;vertical-align: middle;border-bottom: 0.75pt solid rgba(102, 102, 102, 1.00);border-top: 1.5pt solid rgba(102, 102, 102, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cc9ed5c8{width:1.173in;background-color:transparent;vertical-align: middle;border-bottom: 0.75pt solid rgba(102, 102, 102, 1.00);border-top: 1.5pt solid rgba(102, 102, 102, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cc9ed5d0{width:1.164in;background-color:transparent;vertical-align: middle;border-bottom: 0.75pt solid rgba(102, 102, 102, 1.00);border-top: 1.5pt solid rgba(102, 102, 102, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cc9ed5d1{width:0.519in;background-color:transparent;vertical-align: middle;border-bottom: 0.75pt solid rgba(102, 102, 102, 1.00);border-top: 1.5pt solid rgba(102, 102, 102, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cc9ed5da{width:1.206in;background-color:transparent;vertical-align: bottom;border-bottom: 1.5pt solid rgba(102, 102, 102, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cc9ed5db{width:0.079in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(102, 102, 102, 1.00);border-top: 0 solid rgba(102, 102, 102, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cc9ed5e4{width:0.434in;background-color:transparent;vertical-align: middle;border-bottom: 1.5pt solid rgba(102, 102, 102, 1.00);border-top: 0.75pt solid rgba(102, 102, 102, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cc9ed5e5{width:1.173in;background-color:transparent;vertical-align: middle;border-bottom: 1.5pt solid rgba(102, 102, 102, 1.00);border-top: 0.75pt solid rgba(102, 102, 102, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cc9ed5e6{width:1.164in;background-color:transparent;vertical-align: middle;border-bottom: 1.5pt solid rgba(102, 102, 102, 1.00);border-top: 0.75pt solid rgba(102, 102, 102, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cc9ed5ee{width:0.519in;background-color:transparent;vertical-align: middle;border-bottom: 1.5pt solid rgba(102, 102, 102, 1.00);border-top: 0.75pt solid rgba(102, 102, 102, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cc9ed5f8{width:1.206in;background-color:transparent;vertical-align: top;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cc9ed5f9{width:0.079in;background-color:transparent;vertical-align: top;border-bottom: 0 solid rgba(102, 102, 102, 1.00);border-top: 0 solid rgba(102, 102, 102, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cc9ed602{width:0.434in;background-color:transparent;vertical-align: top;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cc9ed603{width:1.173in;background-color:transparent;vertical-align: top;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cc9ed604{width:1.164in;background-color:transparent;vertical-align: top;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cc9ed60c{width:0.519in;background-color:transparent;vertical-align: top;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cc9ed616{width:1.206in;background-color:transparent;vertical-align: top;border-bottom: 1.5pt solid rgba(102, 102, 102, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cc9ed617{width:0.079in;background-color:transparent;vertical-align: top;border-bottom: 0 solid rgba(102, 102, 102, 1.00);border-top: 0 solid rgba(102, 102, 102, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cc9ed618{width:0.434in;background-color:transparent;vertical-align: top;border-bottom: 1.5pt solid rgba(102, 102, 102, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cc9ed619{width:1.173in;background-color:transparent;vertical-align: top;border-bottom: 1.5pt solid rgba(102, 102, 102, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cc9ed620{width:1.164in;background-color:transparent;vertical-align: top;border-bottom: 1.5pt solid rgba(102, 102, 102, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cc9ed62a{width:0.519in;background-color:transparent;vertical-align: top;border-bottom: 1.5pt solid rgba(102, 102, 102, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}Variable Control TreatmentOverallNMean (SD)RangeNMean (SD)RangeNMean (SD)Rangeeducated820.29 (0.46)0.000-1.000490.31 (0.47)0.000-1.0001310.30 (0.46)0.000-1.000liv_count822.24 (1.01)1.000-4.000492.57 (1.17)1.000-5.0001312.37 (1.08)1.000-5.000no_meals822.59 (0.50)2.000-3.000492.63 (0.49)2.000-3.0001312.60 (0.49)2.000-3.000no_membrs826.96 (2.86)2.000-15.000497.57 (3.64)2.000-19.0001317.19 (3.17)2.000-19.000rooms821.74 (1.17)1.000-8.000491.73 (0.95)1.000-4.0001311.74 (1.09)1.000-8.000uses_fertilizer820.24 (0.43)0.000-1.000490.51 (0.51)0.000-1.0001310.34 (0.48)0.000-1.000years_liv8221.94 (14.92)1.000-70.0004924.92 (19.83)2.000-96.00013123.05 (16.91)1.000-96.000 To add a column with differences, I first define a function to compute the differences (I use a regression rather than a ttest, so I can cluster my standard errors etc. to this if I need to). Then I use summarize(across(...)) in much the same way as above, now to create a dataframe called difcol. library(estimatr) get_diffs &lt;- function(equation, clusters = NULL, weights = NULL, std.error = FALSE){ reg &lt;- lm_robust(equation, clusters = {{ clusters }}, weights = {{ weights }}) %&gt;% broom::tidy() estimate &lt;- round(reg[2,2],2) p &lt;- reg[2,5] stars = case_when(p &lt; 0.001 ~ &quot;***&quot;, p &lt; 0.01 ~ &quot;**&quot;, p &lt; 0.05 ~ &quot;*&quot;, .default = &quot;&quot; ) paste0(estimate,stars) } difcol &lt;- data %&gt;% select(where(is.numeric),-key_ID,treatment,village) %&gt;% summarize(across(.cols = c(everything(), -treatment, -village), .fns = ~get_diffs(.x ~ treatment, clusters = village))) %&gt;% pivot_longer(cols =everything(), names_to = &quot;Variable&quot;, values_to=&quot;Difference&quot;) Then, all I have to do is add it to tabulator() using its datasup_last argument. Below, I also use a few other flextable function to make the table nicer. In particular, labelizor() to add variable labels, for which I use the named vector I defined above. descriptive_table_flex &lt;- summstats %&gt;% tabulator(rows = &quot;Variable&quot;, columns = &quot;Treatment&quot;, datasup_last = difcol, `N` = as_paragraph(as_chunk(n,digits=0)), `Mean (SD)` = as_paragraph(as_chunk(fmt_avg_dev(mean, sd, digit1=2,digit2 = 2)))) %&gt;% as_flextable() %&gt;% labelizor(j = &quot;Variable&quot;, labels = labels, part = &quot;body&quot;) %&gt;% fix_border_issues() %&gt;% autofit() descriptive_table_flex .cl-cd1e25ec{}.cl-cd161d0c{font-family:'DejaVu Sans';font-size:11pt;font-weight:normal;font-style:normal;text-decoration:none;color:rgba(0, 0, 0, 1.00);background-color:transparent;}.cl-cd194ee6{margin:0;text-align:left;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);padding-bottom:5pt;padding-top:5pt;padding-left:5pt;padding-right:5pt;line-height: 1;background-color:transparent;}.cl-cd194ef0{margin:0;text-align:center;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);padding-bottom:0;padding-top:0;padding-left:0;padding-right:0;line-height: 1;background-color:transparent;}.cl-cd194efa{margin:0;text-align:center;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);padding-bottom:5pt;padding-top:5pt;padding-left:5pt;padding-right:5pt;line-height: 1;background-color:transparent;}.cl-cd194efb{margin:0;text-align:left;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);padding-bottom:0;padding-top:0;padding-left:0;padding-right:0;line-height: 1;background-color:transparent;}.cl-cd194f04{margin:0;text-align:left;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);padding-bottom:5pt;padding-top:5pt;padding-left:5pt;padding-right:5pt;line-height: 1;background-color:transparent;}.cl-cd194f05{margin:0;text-align:left;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);padding-bottom:0;padding-top:0;padding-left:0;padding-right:0;line-height: 1;background-color:transparent;}.cl-cd194f0e{margin:0;text-align:center;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);padding-bottom:5pt;padding-top:5pt;padding-left:5pt;padding-right:5pt;line-height: 1;background-color:transparent;}.cl-cd197574{width:1.312in;background-color:transparent;vertical-align: bottom;border-bottom: 1.5pt solid rgba(102, 102, 102, 1.00);border-top: 1.5pt solid rgba(102, 102, 102, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cd197588{width:0.1in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(102, 102, 102, 1.00);border-top: 0 solid rgba(102, 102, 102, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cd197589{width:0.455in;background-color:transparent;vertical-align: middle;border-bottom: 0.75pt solid rgba(102, 102, 102, 1.00);border-top: 1.5pt solid rgba(102, 102, 102, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cd19758a{width:1.194in;background-color:transparent;vertical-align: middle;border-bottom: 0.75pt solid rgba(102, 102, 102, 1.00);border-top: 1.5pt solid rgba(102, 102, 102, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cd197592{width:0.54in;background-color:transparent;vertical-align: middle;border-bottom: 0.75pt solid rgba(102, 102, 102, 1.00);border-top: 1.5pt solid rgba(102, 102, 102, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cd197593{width:0.981in;background-color:transparent;vertical-align: bottom;border-bottom: 1.5pt solid rgba(102, 102, 102, 1.00);border-top: 1.5pt solid rgba(102, 102, 102, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cd19759c{width:1.312in;background-color:transparent;vertical-align: bottom;border-bottom: 1.5pt solid rgba(102, 102, 102, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cd19759d{width:0.1in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(102, 102, 102, 1.00);border-top: 0 solid rgba(102, 102, 102, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cd19759e{width:0.455in;background-color:transparent;vertical-align: middle;border-bottom: 1.5pt solid rgba(102, 102, 102, 1.00);border-top: 0.75pt solid rgba(102, 102, 102, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cd19759f{width:1.194in;background-color:transparent;vertical-align: middle;border-bottom: 1.5pt solid rgba(102, 102, 102, 1.00);border-top: 0.75pt solid rgba(102, 102, 102, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cd1975a6{width:0.54in;background-color:transparent;vertical-align: middle;border-bottom: 1.5pt solid rgba(102, 102, 102, 1.00);border-top: 0.75pt solid rgba(102, 102, 102, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cd1975b0{width:0.981in;background-color:transparent;vertical-align: bottom;border-bottom: 1.5pt solid rgba(102, 102, 102, 1.00);border-top: 0.75pt solid rgba(102, 102, 102, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cd1975ba{width:1.312in;background-color:transparent;vertical-align: top;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cd1975bb{width:0.1in;background-color:transparent;vertical-align: top;border-bottom: 0 solid rgba(102, 102, 102, 1.00);border-top: 0 solid rgba(102, 102, 102, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cd1975c4{width:0.455in;background-color:transparent;vertical-align: top;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cd1975c5{width:1.194in;background-color:transparent;vertical-align: top;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cd1975ce{width:0.54in;background-color:transparent;vertical-align: top;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cd1975d8{width:0.981in;background-color:transparent;vertical-align: top;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cd1975e2{width:1.312in;background-color:transparent;vertical-align: top;border-bottom: 1.5pt solid rgba(102, 102, 102, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cd1975e3{width:0.1in;background-color:transparent;vertical-align: top;border-bottom: 0 solid rgba(102, 102, 102, 1.00);border-top: 0 solid rgba(102, 102, 102, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cd1975ec{width:0.455in;background-color:transparent;vertical-align: top;border-bottom: 1.5pt solid rgba(102, 102, 102, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cd1975ed{width:1.194in;background-color:transparent;vertical-align: top;border-bottom: 1.5pt solid rgba(102, 102, 102, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cd1975f6{width:0.54in;background-color:transparent;vertical-align: top;border-bottom: 1.5pt solid rgba(102, 102, 102, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cd1975f7{width:0.981in;background-color:transparent;vertical-align: top;border-bottom: 1.5pt solid rgba(102, 102, 102, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}Variable Control TreatmentOverallDifferenceNMean (SD)NMean (SD)NMean (SD)Educated820.29 (0.46)490.31 (0.47)1310.30 (0.46)0.01# Livestock822.24 (1.01)492.57 (1.17)1312.37 (1.08)0.33*# Meals822.59 (0.50)492.63 (0.49)1312.60 (0.49)0.05# HH Members826.96 (2.86)497.57 (3.64)1317.19 (3.17)0.61# Rooms821.74 (1.17)491.73 (0.95)1311.74 (1.09)-0.01Uses fertilizer820.24 (0.43)490.51 (0.51)1310.34 (0.48)0.27Year in village8221.94 (14.92)4924.92 (19.83)13123.05 (16.91)2.98 Again, to save it as a word file, use save_as_docx(path = \"my/file.docx\"). Regression Tables Simple regression A simple regression uses the lm() function. I use the modelsummary() function to display it: lm &lt;- lm(uses_fertilizer ~ treatment + educated, data = data) modelsummary(lm, output = &quot;flextable&quot;) .cl-cd46d884{}.cl-cd40d830{font-family:'DejaVu Sans';font-size:11pt;font-weight:normal;font-style:normal;text-decoration:none;color:rgba(0, 0, 0, 1.00);background-color:transparent;}.cl-cd43287e{margin:0;text-align:left;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);padding-bottom:5pt;padding-top:5pt;padding-left:5pt;padding-right:5pt;line-height: 1;background-color:transparent;}.cl-cd434228{width:0.75in;background-color:transparent;vertical-align: middle;border-bottom: 1.5pt solid rgba(102, 102, 102, 1.00);border-top: 1.5pt solid rgba(102, 102, 102, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cd434232{width:0.75in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cd43423c{width:0.75in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 1pt solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cd434246{width:0.75in;background-color:transparent;vertical-align: middle;border-bottom: 1.5pt solid rgba(102, 102, 102, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;} (1)(Intercept)0.207(0.057)treatment0.265(0.083)educated0.128(0.088)Num.Obs.131R20.089R2 Adj.0.074AIC172.5BIC184.0Log.Lik.-82.241F6.230RMSE0.45 Robust standard errors, and custom glance methods To get robust standard errors clustered at the village level, using the same procedures Stata uses, I use lm_robust(): library(estimatr) lmrobust &lt;- lm_robust(uses_fertilizer ~ treatment + educated, data = data, clusters = village, se_type = &quot;stata&quot;) modelsummary(list(&quot;LM&quot; = lm, &quot;Robust&quot; = lmrobust), output = &quot;flextable&quot;) .cl-cd87aa58{}.cl-cd820c7e{font-family:'DejaVu Sans';font-size:11pt;font-weight:normal;font-style:normal;text-decoration:none;color:rgba(0, 0, 0, 1.00);background-color:transparent;}.cl-cd8463b6{margin:0;text-align:left;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);padding-bottom:5pt;padding-top:5pt;padding-left:5pt;padding-right:5pt;line-height: 1;background-color:transparent;}.cl-cd847edc{width:0.75in;background-color:transparent;vertical-align: middle;border-bottom: 1.5pt solid rgba(102, 102, 102, 1.00);border-top: 1.5pt solid rgba(102, 102, 102, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cd847ee6{width:0.75in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cd847ef0{width:0.75in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 1pt solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cd847efa{width:0.75in;background-color:transparent;vertical-align: middle;border-bottom: 1.5pt solid rgba(102, 102, 102, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;} LMRobust(Intercept)0.2070.207(0.057)(0.068)treatment0.2650.265(0.083)(0.091)educated0.1280.128(0.088)(0.097)Num.Obs.131131R20.0890.089R2 Adj.0.0740.074AIC172.5172.5BIC184.0184.0Log.Lik.-82.241F6.230RMSE0.450.45Std.Errorsby: village I’d like to have just the N, r-squared and Adjusted R-squared, and a row indicating SEs are clustered or not: # define a custom row to denote clustered SEs custom_row &lt;- tribble( ~term, ~LM, ~Robust, &quot;Clustered SEs&quot;, &quot;No&quot;, &quot;Yes&quot; ) # choose what goodness-of-fit statistics to show using gof_map, # and add the custom row using add_rows modelsummary(list(&quot;LM&quot; = lm, &quot;Robust&quot; = lmrobust), gof_map = c(&quot;nobs&quot;,&quot;r.squared&quot;,&quot;adj.r.squared&quot;), add_rows = custom_row, output = &quot;flextable&quot;) %&gt;% autofit() .cl-cdcd155c{}.cl-cdc7a810{font-family:'DejaVu Sans';font-size:11pt;font-weight:normal;font-style:normal;text-decoration:none;color:rgba(0, 0, 0, 1.00);background-color:transparent;}.cl-cdc9ee4a{margin:0;text-align:left;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);padding-bottom:5pt;padding-top:5pt;padding-left:5pt;padding-right:5pt;line-height: 1;background-color:transparent;}.cl-cdca0826{width:1.262in;background-color:transparent;vertical-align: middle;border-bottom: 1.5pt solid rgba(102, 102, 102, 1.00);border-top: 1.5pt solid rgba(102, 102, 102, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cdca083a{width:0.769in;background-color:transparent;vertical-align: middle;border-bottom: 1.5pt solid rgba(102, 102, 102, 1.00);border-top: 1.5pt solid rgba(102, 102, 102, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cdca083b{width:1.262in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cdca0844{width:0.769in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cdca0845{width:1.262in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cdca0846{width:0.769in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cdca084e{width:1.262in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cdca0858{width:0.769in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cdca0859{width:1.262in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cdca0862{width:0.769in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cdca0863{width:1.262in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 1pt solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cdca0864{width:0.769in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 1pt solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cdca086c{width:1.262in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cdca086d{width:0.769in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cdca0876{width:1.262in;background-color:transparent;vertical-align: middle;border-bottom: 1.5pt solid rgba(102, 102, 102, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cdca0877{width:0.769in;background-color:transparent;vertical-align: middle;border-bottom: 1.5pt solid rgba(102, 102, 102, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;} LMRobust(Intercept)0.2070.207(0.057)(0.068)treatment0.2650.265(0.083)(0.091)educated0.1280.128(0.088)(0.097)Num.Obs.131131R20.0890.089R2 Adj.0.0740.074Clustered SEsNoYes If you want to add the number of clusters, you can do so manually, using add_row, but you can also spend a lot of time getting R to do if for you, which would save you the few seconds it would take to add it manually! But really, having R do it does make for more reproducible code, so that’s what we’ll do here. modelsummary() gets the N etc. from the broom::glance() function: broom::glance(lmrobust) ## r.squared adj.r.squared statistic p.value df.residual nobs se_type ## 1 0.08871322 0.07447437 27.5137 0.03507086 2 131 stata As you can see, this doesn’t report the number of clusters, but it is actually saved in the lm_robust() object: lmrobust$nclusters ## [1] 3 Fortunately, modelsummary accepts custom methods, so we make a ones for lm and `lm_robust objects and add information about the clustering: # the custom methods checks if there&#39;s a nclusters attribute, # and if so, adds it to the glance output glance_custom.lm &lt;- function(x) { # this function takes glance() output, and adds a nclusters column glance(x) %&gt;% mutate(nclusters = ifelse(!is.null(x$nclusters), x$nclusters, NA_integer_), clustered = ifelse(!is.null(x$nclusters), &quot;Yes&quot;, &quot;No&quot;)) } # the custom methods checks if there&#39;s a nclusters attribute, # and if so, adds it to the glance output glance_custom.lm_robust &lt;- function(x) { # this function takes glance() output, and adds a nclusters column glance(x) %&gt;% mutate(nclusters = ifelse(!is.null(x$nclusters), x$nclusters, NA_integer_), clustered = ifelse(!is.null(x$nclusters), &quot;Yes&quot;, &quot;No&quot;)) } # define a custom gof_map to control order and display of statistics gof_map_custom &lt;- tribble( ~raw, ~clean, ~fmt, &quot;nobs&quot;, &quot;N&quot;, 0, &quot;r.squared&quot;, &quot;R²&quot;, 2, &quot;adj.r.squared&quot;, &quot;Adj. R²&quot;, 2, &quot;clustered&quot;, &quot;Clustered SEs&quot;, 0, &quot;nclusters&quot;, &quot;Number of clusters&quot;, 0 ) modelsummary(list(&quot;LM&quot; = lm, &quot;Robust&quot; = lmrobust), #add_rows = custom_row, gof_map = gof_map_custom, output = &quot;flextable&quot;) .cl-ce0d9500{}.cl-ce079498{font-family:'DejaVu Sans';font-size:11pt;font-weight:normal;font-style:normal;text-decoration:none;color:rgba(0, 0, 0, 1.00);background-color:transparent;}.cl-ce0a0c5a{margin:0;text-align:left;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);padding-bottom:5pt;padding-top:5pt;padding-left:5pt;padding-right:5pt;line-height: 1;background-color:transparent;}.cl-ce0a2906{width:0.75in;background-color:transparent;vertical-align: middle;border-bottom: 1.5pt solid rgba(102, 102, 102, 1.00);border-top: 1.5pt solid rgba(102, 102, 102, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-ce0a2910{width:0.75in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-ce0a2911{width:0.75in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 1pt solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-ce0a291a{width:0.75in;background-color:transparent;vertical-align: middle;border-bottom: 1.5pt solid rgba(102, 102, 102, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;} LMRobust(Intercept)0.2070.207(0.057)(0.068)treatment0.2650.265(0.083)(0.091)educated0.1280.128(0.088)(0.097)N131131R²0.090.09Adj. R²0.070.07Clustered SEsNoYesNumber of clusters3 This was quite a bit more work than adding a custom row, but more flexible, and will keep being correct even if we change the number of clusters. Note that I also added a custom_gof_map to control the order and display of the goodness-of-fit statistics. Probit with cluster robust SEs Now lets add a probit model! probit &lt;- glm(uses_fertilizer ~ treatment + educated, family = binomial(link = &quot;probit&quot;), data = data) modelsummary(list(&quot;LM&quot; = lm, &quot;Robust&quot; = lmrobust, &quot;Probit&quot; = probit), gof_map = gof_map_custom, output = &quot;flextable&quot;) .cl-ce60e17e{}.cl-ce59cc0e{font-family:'DejaVu Sans';font-size:11pt;font-weight:normal;font-style:normal;text-decoration:none;color:rgba(0, 0, 0, 1.00);background-color:transparent;}.cl-ce5c36f6{margin:0;text-align:left;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);padding-bottom:5pt;padding-top:5pt;padding-left:5pt;padding-right:5pt;line-height: 1;background-color:transparent;}.cl-ce5c503c{width:0.75in;background-color:transparent;vertical-align: middle;border-bottom: 1.5pt solid rgba(102, 102, 102, 1.00);border-top: 1.5pt solid rgba(102, 102, 102, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-ce5c5046{width:0.75in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-ce5c5050{width:0.75in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 1pt solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-ce5c505a{width:0.75in;background-color:transparent;vertical-align: middle;border-bottom: 1.5pt solid rgba(102, 102, 102, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;} LMRobustProbit(Intercept)0.2070.207-0.813(0.057)(0.068)(0.173)treatment0.2650.2650.727(0.083)(0.091)(0.236)educated0.1280.1280.366(0.088)(0.097)(0.250)N131131131R²0.090.09Adj. R²0.070.07Clustered SEsNoYesNoNumber of clusters3 Adding cluster-robust standard errors to the probit model is a bit more complex. There is no glm_robust() function. You can estimate a probit model, then use the sandwich and lmtest packages to get clustered standard errors, and then use the glance_custom method to add the number of clusters to that. However, you can create your own glm_robust function, including tidy() and glance() methods that return everything you want to modelsummary(). I use vcovCR from the clubSandwich package to compute CR2 standard errors, which are the default in estimatr, but there’s many different options for variance-covariance matrices, and apapting the code to use them would be trivial. # this function estimates a probit model, and # then computes the cluster-robust standad errors using # clubSandwich and coeftest # it returns a glm_robust object, which is just a list with all the thing we may need. glm_robust &lt;- function(formula, family, data, cluster, type = &quot;CR2&quot;) { # initialize the list we want to return out &lt;- list() # Estimate model fit &lt;- glm(formula, family = family, data = data) # we need the cluster variable from the observations used in the model: # first get the data used in the model (the complete observations), # and extract the row numbers row_numbers &lt;- model.frame(fit) %&gt;% rownames() %&gt;% as.integer() # then use them to subset the original data and pull the cluster variable # The {{ }} syntax allows for unqouted variable names cluster_vec &lt;- data %&gt;% filter(row_number() %in% row_numbers) %&gt;% pull( {{ cluster }} ) # Cluster-robust VCOV vcov_cr &lt;- clubSandwich::vcovCR( fit, cluster = cluster_vec, type = type ) # populate are returned list: out$coef &lt;- lmtest::coeftest(fit, vcov. = vcov_cr) out$vcov &lt;- vcov_cr out$nclusters &lt;- length(unique(cluster_vec)) out$model &lt;- fit out$nobs &lt;- stats::nobs(fit) out$logLik &lt;- stats::logLik(fit) # set the class of my object: this controls what methods are used to extract info class(out) &lt;- c(&quot;glm_robust&quot;) out } # this is the custom tidy methods for glm_robust objects # it returns a dataframe with coefficients tidy.glm_robust &lt;- function(x, ...){ tibble::tibble( term = rownames(x$coef), estimate = x$coef[, &quot;Estimate&quot;], std.error = x$coef[, &quot;Std. Error&quot;], statistic = x$coef[, &quot;z value&quot;], p.value = x$coef[, &quot;Pr(&gt;|z|)&quot;] ) } # this is the glance method. It returns a data frame with # the number of obserations, log likelihood and number of clusters glance.glm_robust &lt;- function(x, ...){ tibble::tibble( nobs = x$nobs, logLik = as.numeric(x$logLik), nclusters = x$nclusters, clustered = &quot;Yes&quot; #we only accept clustered SEs in this function, so we can just say &quot;Yes&quot; ) } You can then simply use the glm_robust() function and modelsummary() will know how to handle its output! probitrobust &lt;- glm_robust(uses_fertilizer ~ treatment + educated, family = binomial(link = &quot;probit&quot;), data = data, cluster = village, type = &quot;CR2&quot;) modelsummary(list(&quot;LM&quot; = lm, &quot;LM Robust&quot; = lmrobust, &quot;Probit&quot; = probit, &quot;Probit Robust&quot; = probitrobust), gof_map = gof_map_custom, coef_map = labels, stars = TRUE, output = &quot;flextable&quot;) %&gt;% autofit() .cl-ceca8dc2{}.cl-cec433c8{font-family:'DejaVu Sans';font-size:11pt;font-weight:normal;font-style:normal;text-decoration:none;color:rgba(0, 0, 0, 1.00);background-color:transparent;}.cl-cec6cb10{margin:0;text-align:left;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);padding-bottom:5pt;padding-top:5pt;padding-left:5pt;padding-right:5pt;line-height: 1;background-color:transparent;}.cl-cec6e94c{width:1.567in;background-color:transparent;vertical-align: middle;border-bottom: 1.5pt solid rgba(102, 102, 102, 1.00);border-top: 1.5pt solid rgba(102, 102, 102, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cec6e956{width:0.846in;background-color:transparent;vertical-align: middle;border-bottom: 1.5pt solid rgba(102, 102, 102, 1.00);border-top: 1.5pt solid rgba(102, 102, 102, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cec6e957{width:1.024in;background-color:transparent;vertical-align: middle;border-bottom: 1.5pt solid rgba(102, 102, 102, 1.00);border-top: 1.5pt solid rgba(102, 102, 102, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cec6e960{width:0.897in;background-color:transparent;vertical-align: middle;border-bottom: 1.5pt solid rgba(102, 102, 102, 1.00);border-top: 1.5pt solid rgba(102, 102, 102, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cec6e961{width:1.211in;background-color:transparent;vertical-align: middle;border-bottom: 1.5pt solid rgba(102, 102, 102, 1.00);border-top: 1.5pt solid rgba(102, 102, 102, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cec6e96a{width:1.567in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cec6e974{width:0.846in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cec6e975{width:1.024in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cec6e97e{width:0.897in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cec6e97f{width:1.211in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cec6e988{width:1.567in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cec6e992{width:0.846in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cec6e993{width:1.024in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cec6e99c{width:0.897in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cec6e99d{width:1.211in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cec6e99e{width:1.567in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cec6e9a6{width:0.846in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cec6e9a7{width:1.024in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cec6e9a8{width:0.897in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cec6e9b0{width:1.211in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cec6e9ba{width:1.567in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 1pt solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cec6e9bb{width:0.846in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 1pt solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cec6e9c4{width:1.024in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 1pt solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cec6e9ce{width:0.897in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 1pt solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cec6e9cf{width:1.211in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 1pt solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cec6e9d0{width:1.567in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cec6e9d8{width:0.846in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cec6e9e2{width:1.024in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cec6e9e3{width:0.897in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cec6e9ec{width:1.211in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cec6e9ed{width:1.567in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cec6e9f6{width:0.846in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cec6e9f7{width:1.024in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cec6ea00{width:0.897in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cec6ea01{width:1.211in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cec6ea02{width:1.567in;background-color:transparent;vertical-align: middle;border-bottom: 1.5pt solid rgba(102, 102, 102, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cec6ea0a{width:0.846in;background-color:transparent;vertical-align: middle;border-bottom: 1.5pt solid rgba(102, 102, 102, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cec6ea14{width:1.024in;background-color:transparent;vertical-align: middle;border-bottom: 1.5pt solid rgba(102, 102, 102, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cec6ea15{width:0.897in;background-color:transparent;vertical-align: middle;border-bottom: 1.5pt solid rgba(102, 102, 102, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cec6ea1e{width:1.211in;background-color:transparent;vertical-align: middle;border-bottom: 1.5pt solid rgba(102, 102, 102, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cec6ea1f{width:1.567in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(255, 255, 255, 0.00);border-top: 0 solid rgba(255, 255, 255, 0.00);border-left: 0 solid rgba(255, 255, 255, 0.00);border-right: 0 solid rgba(255, 255, 255, 0.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cec6ea28{width:0.846in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(255, 255, 255, 0.00);border-top: 0 solid rgba(255, 255, 255, 0.00);border-left: 0 solid rgba(255, 255, 255, 0.00);border-right: 0 solid rgba(255, 255, 255, 0.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cec6ea32{width:1.024in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(255, 255, 255, 0.00);border-top: 0 solid rgba(255, 255, 255, 0.00);border-left: 0 solid rgba(255, 255, 255, 0.00);border-right: 0 solid rgba(255, 255, 255, 0.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cec6ea33{width:0.897in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(255, 255, 255, 0.00);border-top: 0 solid rgba(255, 255, 255, 0.00);border-left: 0 solid rgba(255, 255, 255, 0.00);border-right: 0 solid rgba(255, 255, 255, 0.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cec6ea34{width:1.211in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(255, 255, 255, 0.00);border-top: 0 solid rgba(255, 255, 255, 0.00);border-left: 0 solid rgba(255, 255, 255, 0.00);border-right: 0 solid rgba(255, 255, 255, 0.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;} LMLM RobustProbitProbit RobustTreated0.265**0.265**0.727**0.727*(0.083)(0.091)(0.236)(0.331)Educated0.1280.1280.3660.366(0.088)(0.097)(0.250)(0.273)Constant0.207***0.207**-0.813***-0.813**(0.057)(0.068)(0.173)(0.279)N131131131131R²0.090.09Adj. R²0.070.07Clustered SEsNoYesNoYesNumber of clusters33+ p &lt; 0.1, * p &lt; 0.05, ** p &lt; 0.01, *** p &lt; 0.001 These functions would be quite easy to reuse in other projects! Marginal Effects To add marginal effects to your probit, use the marginaleffects package. THe avg_slopes() function computes average marginal effects. Here I make a wrapper function (ame_robust()), with a glance method that makes sure the number of clusters is reported in modelsummary: library(marginaleffects) # wrapper function to make average marginal effects ame_robust &lt;- function(x) { ame &lt;- marginaleffects::avg_slopes( x$model, vcov = x$vcov, type = &quot;response&quot; ) out &lt;- x out$coef &lt;- ame class(out) &lt;- &quot;ame_robust&quot; out } tidy.ame_robust &lt;- function(x, ...){ broom::tidy(x$coef) # ame object come with their own tidy method, so we can just use that } # glance methods for ame_robust objects glance.ame_robust &lt;- function(x, ...) { tibble::tibble( nobs = x$nobs, logLik = x$logLik, nclusters = x$nclusters, clustered = &quot;Yes&quot; #we only accept clustered SEs in this function, so we can just say &quot;Yes&quot; ) } modelsummary(list(LM = lmrobust, Probit = probitrobust, &quot;Marginal Effects&quot; = ame_robust(probitrobust)), gof_map = gof_map_custom, coef_map = labels, stars = TRUE, output = &quot;flextable&quot;)%&gt;% autofit() .cl-cf15ce54{}.cl-cf0fc144{font-family:'DejaVu Sans';font-size:11pt;font-weight:normal;font-style:normal;text-decoration:none;color:rgba(0, 0, 0, 1.00);background-color:transparent;}.cl-cf124fcc{margin:0;text-align:left;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);padding-bottom:5pt;padding-top:5pt;padding-left:5pt;padding-right:5pt;line-height: 1;background-color:transparent;}.cl-cf126cc8{width:1.567in;background-color:transparent;vertical-align: middle;border-bottom: 1.5pt solid rgba(102, 102, 102, 1.00);border-top: 1.5pt solid rgba(102, 102, 102, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cf126cd2{width:0.786in;background-color:transparent;vertical-align: middle;border-bottom: 1.5pt solid rgba(102, 102, 102, 1.00);border-top: 1.5pt solid rgba(102, 102, 102, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cf126cd3{width:0.837in;background-color:transparent;vertical-align: middle;border-bottom: 1.5pt solid rgba(102, 102, 102, 1.00);border-top: 1.5pt solid rgba(102, 102, 102, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cf126cdc{width:1.38in;background-color:transparent;vertical-align: middle;border-bottom: 1.5pt solid rgba(102, 102, 102, 1.00);border-top: 1.5pt solid rgba(102, 102, 102, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cf126cdd{width:1.567in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cf126ce6{width:0.786in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cf126cf0{width:0.837in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cf126cf1{width:1.38in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cf126cfa{width:1.567in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cf126d04{width:0.786in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cf126d05{width:0.837in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cf126d06{width:1.38in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cf126d0e{width:1.567in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cf126d18{width:0.786in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cf126d19{width:0.837in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cf126d22{width:1.38in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cf126d23{width:1.567in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 1pt solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cf126d2c{width:0.786in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 1pt solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cf126d36{width:0.837in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 1pt solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cf126d40{width:1.38in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 1pt solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cf126d41{width:1.567in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cf126d4a{width:0.786in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cf126d4b{width:0.837in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cf126d4c{width:1.38in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cf126d54{width:1.567in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cf126d5e{width:0.786in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cf126d5f{width:0.837in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cf126d60{width:1.38in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cf126d68{width:1.567in;background-color:transparent;vertical-align: middle;border-bottom: 1.5pt solid rgba(102, 102, 102, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cf126d69{width:0.786in;background-color:transparent;vertical-align: middle;border-bottom: 1.5pt solid rgba(102, 102, 102, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cf126d72{width:0.837in;background-color:transparent;vertical-align: middle;border-bottom: 1.5pt solid rgba(102, 102, 102, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cf126d73{width:1.38in;background-color:transparent;vertical-align: middle;border-bottom: 1.5pt solid rgba(102, 102, 102, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cf126d7c{width:1.567in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(255, 255, 255, 0.00);border-top: 0 solid rgba(255, 255, 255, 0.00);border-left: 0 solid rgba(255, 255, 255, 0.00);border-right: 0 solid rgba(255, 255, 255, 0.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cf126d7d{width:0.786in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(255, 255, 255, 0.00);border-top: 0 solid rgba(255, 255, 255, 0.00);border-left: 0 solid rgba(255, 255, 255, 0.00);border-right: 0 solid rgba(255, 255, 255, 0.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cf126d86{width:0.837in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(255, 255, 255, 0.00);border-top: 0 solid rgba(255, 255, 255, 0.00);border-left: 0 solid rgba(255, 255, 255, 0.00);border-right: 0 solid rgba(255, 255, 255, 0.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-cf126d90{width:1.38in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(255, 255, 255, 0.00);border-top: 0 solid rgba(255, 255, 255, 0.00);border-left: 0 solid rgba(255, 255, 255, 0.00);border-right: 0 solid rgba(255, 255, 255, 0.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;} LMProbitMarginal EffectsTreated0.265**0.727*0.265*(0.091)(0.331)(0.106)Educated0.1280.3660.129(0.097)(0.273)(0.109)Constant0.207**-0.813**(0.068)(0.279)N131131131R²0.09Adj. R²0.07Clustered SEsYesYesYesNumber of clusters333+ p &lt; 0.1, * p &lt; 0.05, ** p &lt; 0.01, *** p &lt; 0.001 Plots To make plots, use ggplot2. Plenty of help out there, here’s some examples, using the following data: plot_data &lt;- read_csv(here(&quot;data/SAFI_clean.csv&quot;), na = &quot;NULL&quot;) %&gt;% separate_longer_delim(items_owned, delim = &quot;;&quot;) %&gt;% mutate(value = 1) %&gt;% pivot_wider(names_from = items_owned, values_from = value, names_glue = &quot;owns_{items_owned}&quot;, values_fill = 0) %&gt;% rowwise %&gt;% select(-&quot;owns_NA&quot;) %&gt;% mutate(number_items = sum(c_across(starts_with(&quot;owns_&quot;)))) Faceting Faceting allows splitting a graph in multiple parts: plot_data %&gt;% group_by(village) %&gt;% summarize(across(.cols = starts_with(&quot;owns_&quot;), .fns = ~sum(.x,na.rm=TRUE) / n() * 100, .names = &quot;{str_replace(.col, &#39;owns_&#39;, &#39;&#39;)}&quot;)) %&gt;% pivot_longer(-village, names_to = &quot;items&quot;, values_to = &quot;percent&quot;) %&gt;% ggplot(aes(x = village, y = percent)) + geom_bar(stat = &quot;identity&quot;, position = &quot;dodge&quot;) + facet_wrap(~ items) + theme_bw() + theme(panel.grid = element_blank()) Note that the .names argument to summarize(across()) is specified as a glue string that uses str_replace() to cut off the \"owns_\" bit of the column names. For more control, look into patchwork. Stacked bar plots in WUR style Stacked bar plots are useful to show distributions of categorical variables. Here is a function that makes a stacked bar plot, with percentages on the x-axis, counts inside the bars, and a legend at the bottom. It uses a bunch of techniques: The wur household is applied using [ggthemewur](https://git.wur.nl/wmrkdown/ggthemewur). The plot is complex, but because it is contained in a reusable function, it is easy to (re-)use. Category counts are computed, and added to factor labels, using count_label(). Cell counts are extracted and displayed inside the bars, using after_stat(). library(ggthemewur) stacked_bar_plot &lt;- function(df, by, fill) { # outputs a stacked bar chart df %&gt;% # the category labels should include counts mutate( {{ by }} := count_label( {{ by }})) %&gt;% ggplot(aes(y = {{ by }}, fill = {{ fill }})) + geom_bar(position = position_fill(reverse = TRUE)) + labs(x= &quot;&quot;) + theme_wur() + scale_fill_wur_discrete() + geom_text( stat = &quot;count&quot;, # for %: after_stat(scales::percent(count / sum(count),accuracy=1)) aes(label = after_stat(count)), position = position_fill(vjust = 0.5, reverse = TRUE), color = &quot;white&quot; ) + scale_x_continuous(labels = scales::percent_format()) + theme(legend.position=&quot;bottom&quot;) + guides( fill = guide_legend( nrow = 1, title.position=&quot;top&quot;, title.hjust = 0.5 ) ) } count_label &lt;- function(vector) { # takes a vector of strings or factor, # output a factor vector with N = N included in the labels fct_recode( factor(vector), !!!vector %&gt;% as_tibble() %&gt;% group_by(value) %&gt;% summarize(n = n()) %&gt;% mutate( value = as.character(value), newlabel = paste0(value,&quot;\\nn=&quot;,n) ) %&gt;% pull(value, name = newlabel) ) } read_csv(here(&quot;data/SAFI_clean.csv&quot;), na = &quot;NULL&quot;) %&gt;% stacked_bar_plot(village, respondent_wall_type) The point here is that plots can get quite complex, and by saving them in a function, you can reuse them easily. Lollipop plot A lollipop plot is a nice alternative to a bar chart. Here is an example. It uses reorder to put the longest lollipops are at the top, and and the brewur() function to select four colors from the WUR theme. I also quite like theme_ipsum from hrbrthemes: library(hrbrthemes) N &lt;- nrow(data) read_csv(here(&quot;data/SAFI_clean.csv&quot;), na = &quot;NULL&quot;) %&gt;% separate_longer_delim(items_owned, delim = &quot;;&quot;) %&gt;% select(items_owned) %&gt;% filter(!is.na(items_owned)) %&gt;% group_by(items_owned) %&gt;% summarize(Count = n() / N) %&gt;% mutate(items_owned = reorder(items_owned, Count)) %&gt;% ggplot(aes(x = Count, y = items_owned)) + geom_linerange( aes(y = items_owned, xmin = 0, xmax = Count), color = &quot;gray&quot; ) + geom_point( aes(x = Count, y = items_owned), size = 4, position = position_dodge(width = 0.5), color = brewur()[[1]] ) + theme_ipsum() + scale_x_continuous(labels = scales::percent_format()) + labs( title = &quot;Look at this graph&quot;, subtitle = &quot;People love radios, phones, and a good plough&quot;) Maps For maps, we use the sf package, and a sample data set, in geo-json format (but sf can use all sorts of shapefiles). I add some fake data to plot to the shapefile, using familiar mutate() syntax: library(sf) file &lt;- &quot;https://raw.githubusercontent.com/johan/world.geo.json/master/countries.geo.json&quot; shapefile &lt;- st_read(file) %&gt;% mutate(x = rnorm(n = nrow(.))) ## Reading layer `countries.geo&#39; from data source ## `https://raw.githubusercontent.com/johan/world.geo.json/master/countries.geo.json&#39; ## using driver `GeoJSON&#39; ## Simple feature collection with 180 features and 2 fields ## Geometry type: MULTIPOLYGON ## Dimension: XY ## Bounding box: xmin: -180 ymin: -85.60904 xmax: 180 ymax: 83.64513 ## Geodetic CRS: WGS 84 shapefile ## Simple feature collection with 180 features and 3 fields ## Geometry type: MULTIPOLYGON ## Dimension: XY ## Bounding box: xmin: -180 ymin: -85.60904 xmax: 180 ymax: 83.64513 ## Geodetic CRS: WGS 84 ## First 10 features: ## id name geometry ## 1 AFG Afghanistan MULTIPOLYGON (((61.21082 35... ## 2 AGO Angola MULTIPOLYGON (((16.32653 -5... ## 3 ALB Albania MULTIPOLYGON (((20.59025 41... ## 4 ARE United Arab Emirates MULTIPOLYGON (((51.57952 24... ## 5 ARG Argentina MULTIPOLYGON (((-65.5 -55.2... ## 6 ARM Armenia MULTIPOLYGON (((43.58275 41... ## 7 ATA Antarctica MULTIPOLYGON (((-59.57209 -... ## 8 ATF French Southern and Antarctic Lands MULTIPOLYGON (((68.935 -48.... ## 9 AUS Australia MULTIPOLYGON (((145.398 -40... ## 10 AUT Austria MULTIPOLYGON (((16.97967 48... ## x ## 1 -0.8874201 ## 2 0.1054214 ## 3 0.3528745 ## 4 0.5503934 ## 5 -1.1343310 ## 6 1.4623515 ## 7 0.7021167 ## 8 2.5071111 ## 9 -1.8900271 ## 10 -0.5898128 You can then use ggplot() and geom_sf() to make a map: You can use the fill aesthetic to color your shapefile: shapefile %&gt;% ggplot(aes(fill = x)) + geom_sf(colour = NA) + # removes borders theme_void() # removes grid You can also make an interactive map, which you can use in html documents created with rmarkdown, or in shiny applications. It uses a palette I created using the colorBin() function. library(leaflet) pallete &lt;- colorBin( palette = &quot;YlOrBr&quot;, domain = shapefile$x, na.color = &quot;transparent&quot;, bins = 5 ) shapefile %&gt;% #mutate(x = rnorm(n = nrow(.))) %&gt;% leaflet() %&gt;% addTiles() %&gt;% addPolygons(fillColor = ~pallete(x), stroke = TRUE, fillOpacity = 0.9, color = &quot;white&quot;, weight = 0.3) %&gt;% addLegend(pal = pallete, values = ~x, opacity = 0.9, title = &quot;Look at these pretty colours&quot;, position = &quot;bottomleft&quot;) "],["404.html", "Page not found", " Page not found The page you requested cannot be found (perhaps it was moved or renamed). You may want to try searching to find the page's new location, or use the table of contents to find the page you are looking for. "]]
