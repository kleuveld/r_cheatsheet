<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>4. Data Cleaning | Reproducible and reusable social science with R: a field guide</title>
  <meta name="description" content="This page contains tips to make your R code reproducible." />
  <meta name="generator" content="bookdown 0.42 and GitBook 2.6.7" />

  <meta property="og:title" content="4. Data Cleaning | Reproducible and reusable social science with R: a field guide" />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="This page contains tips to make your R code reproducible." />
  <meta name="github-repo" content="kleuveld/r_cheatsheet" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="4. Data Cleaning | Reproducible and reusable social science with R: a field guide" />
  
  <meta name="twitter:description" content="This page contains tips to make your R code reproducible." />
  

<meta name="author" content="Koen" />


<meta name="date" content="2026-02-19" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="declaredesign.html"/>
<link rel="next" href="reporting.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>
<link href="libs/tabwid-1.1.3/tabwid.css" rel="stylesheet" />
<script src="libs/tabwid-1.1.3/tabwid.js"></script>
<link href="libs/htmltools-fill-0.5.8.1/fill.css" rel="stylesheet" />
<script src="libs/htmlwidgets-1.6.4/htmlwidgets.js"></script>
<link href="libs/leaflet-1.3.1/leaflet.css" rel="stylesheet" />
<script src="libs/leaflet-1.3.1/leaflet.js"></script>
<link href="libs/leafletfix-1.0.0/leafletfix.css" rel="stylesheet" />
<script src="libs/proj4-2.6.2/proj4.min.js"></script>
<script src="libs/Proj4Leaflet-1.0.1/proj4leaflet.js"></script>
<link href="libs/rstudio_leaflet-1.3.1/rstudio_leaflet.css" rel="stylesheet" />
<script src="libs/leaflet-binding-2.2.2/leaflet.js"></script>


<style type="text/css">
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Reproducible and reusable social science with R: a field guide</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Introduction</a>
<ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#about"><i class="fa fa-check"></i>About</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#setup"><i class="fa fa-check"></i>Setting up</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="reproducible-workflows.html"><a href="reproducible-workflows.html"><i class="fa fa-check"></i>1. Reproducible Workflows</a>
<ul>
<li class="chapter" data-level="" data-path="reproducible-workflows.html"><a href="reproducible-workflows.html#introduction-1"><i class="fa fa-check"></i>Introduction</a></li>
<li class="chapter" data-level="" data-path="reproducible-workflows.html"><a href="reproducible-workflows.html#projects"><i class="fa fa-check"></i>Projects</a>
<ul>
<li class="chapter" data-level="" data-path="reproducible-workflows.html"><a href="reproducible-workflows.html#here"><i class="fa fa-check"></i>Here</a></li>
<li class="chapter" data-level="" data-path="reproducible-workflows.html"><a href="reproducible-workflows.html#using-machine-specific-paths"><i class="fa fa-check"></i>Using machine-specific paths</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="reproducible-workflows.html"><a href="reproducible-workflows.html#renv"><i class="fa fa-check"></i>renv</a>
<ul>
<li class="chapter" data-level="" data-path="reproducible-workflows.html"><a href="reproducible-workflows.html#starting-a-project-with-renv"><i class="fa fa-check"></i>Starting a project with Renv</a></li>
<li class="chapter" data-level="" data-path="reproducible-workflows.html"><a href="reproducible-workflows.html#installing-new-packages-with-renv"><i class="fa fa-check"></i>Installing new packages with Renv</a></li>
<li class="chapter" data-level="" data-path="reproducible-workflows.html"><a href="reproducible-workflows.html#restoring-a-project"><i class="fa fa-check"></i>Restoring a project</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="" data-path="programming.html"><a href="programming.html"><i class="fa fa-check"></i>2. Programming with R</a>
<ul>
<li class="chapter" data-level="" data-path="programming.html"><a href="programming.html#loops"><i class="fa fa-check"></i>Loops</a></li>
<li class="chapter" data-level="" data-path="programming.html"><a href="programming.html#functions"><i class="fa fa-check"></i>Functions</a>
<ul>
<li class="chapter" data-level="" data-path="programming.html"><a href="programming.html#basic-functions"><i class="fa fa-check"></i>Basic Functions</a></li>
<li class="chapter" data-level="" data-path="programming.html"><a href="programming.html#functions-and-the-tidyverse"><i class="fa fa-check"></i>Functions and the tidyverse</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="programming.html"><a href="programming.html#map"><i class="fa fa-check"></i>Map()</a></li>
<li class="chapter" data-level="" data-path="programming.html"><a href="programming.html#making-functions-re-usable-with-box"><i class="fa fa-check"></i>Making functions re-usable with box</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="declaredesign.html"><a href="declaredesign.html"><i class="fa fa-check"></i>3. Power Analysis using DeclareDesign</a>
<ul>
<li class="chapter" data-level="" data-path="declaredesign.html"><a href="declaredesign.html#simple-power-calculation"><i class="fa fa-check"></i>Simple Power Calculation</a>
<ul>
<li class="chapter" data-level="" data-path="declaredesign.html"><a href="declaredesign.html#loading-data"><i class="fa fa-check"></i>Loading data</a></li>
<li class="chapter" data-level="" data-path="declaredesign.html"><a href="declaredesign.html#declare-design"><i class="fa fa-check"></i>Declare Design</a></li>
<li class="chapter" data-level="" data-path="declaredesign.html"><a href="declaredesign.html#diagnosing-design-and-calculating-power"><i class="fa fa-check"></i>Diagnosing Design and calculating power</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="declaredesign.html"><a href="declaredesign.html#dif-in-diff"><i class="fa fa-check"></i>Dif in diff</a></li>
<li class="chapter" data-level="" data-path="declaredesign.html"><a href="declaredesign.html#matching"><i class="fa fa-check"></i>Matching</a>
<ul>
<li class="chapter" data-level="" data-path="declaredesign.html"><a href="declaredesign.html#declare-design-1"><i class="fa fa-check"></i>Declare Design</a></li>
<li class="chapter" data-level="" data-path="declaredesign.html"><a href="declaredesign.html#checking-balance"><i class="fa fa-check"></i>Checking balance</a></li>
<li class="chapter" data-level="" data-path="declaredesign.html"><a href="declaredesign.html#bias"><i class="fa fa-check"></i>Bias</a></li>
<li class="chapter" data-level="" data-path="declaredesign.html"><a href="declaredesign.html#power"><i class="fa fa-check"></i>Power</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="" data-path="datawrangling.html"><a href="datawrangling.html"><i class="fa fa-check"></i>4. Data Cleaning</a>
<ul>
<li class="chapter" data-level="" data-path="datawrangling.html"><a href="datawrangling.html#the-basic-pattern"><i class="fa fa-check"></i>The basic pattern</a></li>
<li class="chapter" data-level="" data-path="datawrangling.html"><a href="datawrangling.html#using-plots-to-identify-data-issues-reproducibly"><i class="fa fa-check"></i>Using plots to identify data issues reproducibly</a></li>
<li class="chapter" data-level="" data-path="datawrangling.html"><a href="datawrangling.html#dealing-with-multiple-levels-of-data"><i class="fa fa-check"></i>Dealing with multiple levels of data</a>
<ul>
<li class="chapter" data-level="" data-path="datawrangling.html"><a href="datawrangling.html#pivoting-long-to-wide"><i class="fa fa-check"></i>Pivoting long to wide</a></li>
<li class="chapter" data-level="" data-path="datawrangling.html"><a href="datawrangling.html#pivoting-wide-to-long"><i class="fa fa-check"></i>Pivoting wide to long</a></li>
<li class="chapter" data-level="" data-path="datawrangling.html"><a href="datawrangling.html#joining-or-merging-data"><i class="fa fa-check"></i>Joining (or merging) data</a></li>
<li class="chapter" data-level="" data-path="datawrangling.html"><a href="datawrangling.html#summarizing-over-groups-or-collapsing-data"><i class="fa fa-check"></i>Summarizing over groups (or collapsing data)</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="datawrangling.html"><a href="datawrangling.html#editing-many-variables-at-once"><i class="fa fa-check"></i>Editing many variables at once</a>
<ul>
<li class="chapter" data-level="" data-path="datawrangling.html"><a href="datawrangling.html#across"><i class="fa fa-check"></i>across(): doing the same operations on multiple variables using across</a></li>
<li class="chapter" data-level="" data-path="datawrangling.html"><a href="datawrangling.html#converting-all-yesno-factors-to-dummies"><i class="fa fa-check"></i>Converting all yes/no factors to dummies</a></li>
<li class="chapter" data-level="" data-path="datawrangling.html"><a href="datawrangling.html#pivoting"><i class="fa fa-check"></i>Pivoting</a></li>
<li class="chapter" data-level="" data-path="datawrangling.html"><a href="datawrangling.html#using-many-variables-as-inputs"><i class="fa fa-check"></i>Using many variables as inputs</a></li>
<li class="chapter" data-level="" data-path="datawrangling.html"><a href="datawrangling.html#renaming-many-variables"><i class="fa fa-check"></i>Renaming many variables</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="datawrangling.html"><a href="datawrangling.html#seperate_longer"><i class="fa fa-check"></i>Splitting multi-response variable into dummies</a></li>
<li class="chapter" data-level="" data-path="datawrangling.html"><a href="datawrangling.html#cleaning-rmd"><i class="fa fa-check"></i>Structure of a cleaning Rmarkdown doc with multi-level data</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="reporting.html"><a href="reporting.html"><i class="fa fa-check"></i>5. Estimating and reporting</a>
<ul>
<li class="chapter" data-level="" data-path="reporting.html"><a href="reporting.html#generating-some-fake-data"><i class="fa fa-check"></i>Generating some fake data</a></li>
<li class="chapter" data-level="" data-path="reporting.html"><a href="reporting.html#making-a-table-of-summary-statistics"><i class="fa fa-check"></i>Making a table of summary statistics</a>
<ul>
<li class="chapter" data-level="" data-path="reporting.html"><a href="reporting.html#using-modelsummary-and-flextable"><i class="fa fa-check"></i>Using modelsummary and flextable</a></li>
<li class="chapter" data-level="" data-path="reporting.html"><a href="reporting.html#balance-table"><i class="fa fa-check"></i>Balance Table</a></li>
<li class="chapter" data-level="" data-path="reporting.html"><a href="reporting.html#advanced-using-only-flextable"><i class="fa fa-check"></i>Advanced: Using only Flextable</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="reporting.html"><a href="reporting.html#regression-tables"><i class="fa fa-check"></i>Regression Tables</a>
<ul>
<li class="chapter" data-level="" data-path="reporting.html"><a href="reporting.html#simple-regression"><i class="fa fa-check"></i>Simple regression</a></li>
<li class="chapter" data-level="" data-path="reporting.html"><a href="reporting.html#robust-standard-errors-and-custom-glance-methods"><i class="fa fa-check"></i>Robust standard errors, and custom glance methods</a></li>
<li class="chapter" data-level="" data-path="reporting.html"><a href="reporting.html#probit-with-cluster-robust-ses"><i class="fa fa-check"></i>Probit with cluster robust SEs</a></li>
<li class="chapter" data-level="" data-path="reporting.html"><a href="reporting.html#marginal-effects"><i class="fa fa-check"></i>Marginal Effects</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="reporting.html"><a href="reporting.html#plots"><i class="fa fa-check"></i>Plots</a>
<ul>
<li class="chapter" data-level="" data-path="reporting.html"><a href="reporting.html#faceting"><i class="fa fa-check"></i>Faceting</a></li>
<li class="chapter" data-level="" data-path="reporting.html"><a href="reporting.html#stacked-bar-plots-in-wur-style"><i class="fa fa-check"></i>Stacked bar plots in WUR style</a></li>
<li class="chapter" data-level="" data-path="reporting.html"><a href="reporting.html#lollipop-plot"><i class="fa fa-check"></i>Lollipop plot</a></li>
<li class="chapter" data-level="" data-path="reporting.html"><a href="reporting.html#maps"><i class="fa fa-check"></i>Maps</a></li>
</ul></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Reproducible and reusable social science with R: a field guide</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="datawrangling" class="section level1 hasAnchor">
<h1>4. Data Cleaning<a href="datawrangling.html#datawrangling" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>Data from the field never quite comes in the form you want,
and the form you want your data in changes depending on what you want to do with it.
So for every project, you’ll likely do a substantial amount of data wrangling.</p>
<p>The goal of reproducible data cleaning is that at any moment,
you can re-run your code to go from raw data to outputs.
This is only useful, if you organize and document your code in such a way
that people unfamiliar with the project (this could be future you!) can understand
and modify the code.
For this, RMarkdown is great, as it contains code, results and documentation
all in one place.
This chapter will provide examples of common data wrangling patterns,
as well as how they can fit it into a reproducible data cleaning
RMarkdown file.</p>
<p>Make sure you have the <code>tidyverse</code> installed, and the SAFI data set
downloaded to your data folder by running the code from the <a href="index.html#setup">Set-up section</a></p>
<div id="the-basic-pattern" class="section level2 hasAnchor">
<h2>The basic pattern<a href="datawrangling.html#the-basic-pattern" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Below is an example R Script,
with some common data wrangling tasks, organized as follows:</p>
<ol style="list-style-type: decimal">
<li>Loading raw data</li>
<li>Cleaning variables by topic using <code>dplyr</code>, including mutating and changing factor levels.</li>
<li>Combine topics into one large data file</li>
<li>Saving cleaned data, so it can be used in analysis scripts.</li>
</ol>
<p>Note that objects are never overwritten:
data is loaded as <code>raw_data</code>,
and each topic takes its info from there, and then the cleaned variables are
saved in their own new data object.
The final <code>clean_data</code> is then assembled from all separate data files.
This has a number of advantages:</p>
<ul>
<li>It comparimentalizes your code: any cleaning you do on the conflict data will
not affect the housing data. This is especially useful when running code interactively
when you’re working on it, as you can run the bits out of order without causing problems.</li>
<li>Your analysis data set will only contain the data you need.
This makes for data files that are easier to handle, and minimizes the impact of data
breaches if analyses data needs to be shared with co-authors.</li>
</ul>
<p>Note furthermore that any filtering is done at the beginging,
in the “paradata” section.</p>
<p>Paradata are metadata recorded during data collection
(e.g., timestamps, interviewer IDs, and device logs)
that document how, when, and by whom data were collected;
here the paradata object serves as a central reference to which all other data are joined.
By doing the filter in a specific object,
near the top of your script, you make sure this is done transparently.</p>
<div class="sourceCode" id="cb125"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb125-1"><a href="datawrangling.html#cb125-1" tabindex="-1"></a><span class="co"># loading packages</span></span>
<span id="cb125-2"><a href="datawrangling.html#cb125-2" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb125-3"><a href="datawrangling.html#cb125-3" tabindex="-1"></a><span class="fu">library</span>(here)</span>
<span id="cb125-4"><a href="datawrangling.html#cb125-4" tabindex="-1"></a></span>
<span id="cb125-5"><a href="datawrangling.html#cb125-5" tabindex="-1"></a><span class="co"># loading raw data</span></span>
<span id="cb125-6"><a href="datawrangling.html#cb125-6" tabindex="-1"></a>raw_data <span class="ot">&lt;-</span> </span>
<span id="cb125-7"><a href="datawrangling.html#cb125-7" tabindex="-1"></a>  <span class="fu">read_csv</span>(<span class="fu">here</span>(<span class="st">&quot;data/SAFI_clean.csv&quot;</span>), <span class="at">na =</span> <span class="st">&quot;NULL&quot;</span>) </span>
<span id="cb125-8"><a href="datawrangling.html#cb125-8" tabindex="-1"></a></span>
<span id="cb125-9"><a href="datawrangling.html#cb125-9" tabindex="-1"></a><span class="co"># Paradata </span></span>
<span id="cb125-10"><a href="datawrangling.html#cb125-10" tabindex="-1"></a>paradata <span class="ot">&lt;-</span> </span>
<span id="cb125-11"><a href="datawrangling.html#cb125-11" tabindex="-1"></a>  raw_data <span class="sc">%&gt;%</span> </span>
<span id="cb125-12"><a href="datawrangling.html#cb125-12" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">day =</span> <span class="fu">day</span>(interview_date),</span>
<span id="cb125-13"><a href="datawrangling.html#cb125-13" tabindex="-1"></a>         <span class="at">month =</span> <span class="fu">month</span>(interview_date),</span>
<span id="cb125-14"><a href="datawrangling.html#cb125-14" tabindex="-1"></a>         <span class="at">year =</span> <span class="fu">year</span>(interview_date)) <span class="sc">%&gt;%</span> </span>
<span id="cb125-15"><a href="datawrangling.html#cb125-15" tabindex="-1"></a>  <span class="fu">filter</span>(village <span class="sc">==</span> <span class="st">&quot;Chirodzo&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb125-16"><a href="datawrangling.html#cb125-16" tabindex="-1"></a>  <span class="fu">filter</span>(interview_date <span class="sc">&gt;</span> <span class="st">&quot;2016-11-16&quot;</span> <span class="sc">&amp;</span> interview_date <span class="sc">&lt;</span> <span class="st">&quot;2017-01-01&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb125-17"><a href="datawrangling.html#cb125-17" tabindex="-1"></a>  <span class="fu">select</span>(key_ID, interview_date, day, month, year, village)</span>
<span id="cb125-18"><a href="datawrangling.html#cb125-18" tabindex="-1"></a></span>
<span id="cb125-19"><a href="datawrangling.html#cb125-19" tabindex="-1"></a><span class="co"># housing</span></span>
<span id="cb125-20"><a href="datawrangling.html#cb125-20" tabindex="-1"></a>housing <span class="ot">&lt;-</span> </span>
<span id="cb125-21"><a href="datawrangling.html#cb125-21" tabindex="-1"></a>  raw_data <span class="sc">%&gt;%</span> </span>
<span id="cb125-22"><a href="datawrangling.html#cb125-22" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">people_per_room =</span> no_membrs <span class="sc">/</span> rooms,</span>
<span id="cb125-23"><a href="datawrangling.html#cb125-23" tabindex="-1"></a>         <span class="at">respondent_wall_type =</span> <span class="fu">as_factor</span>(respondent_wall_type),</span>
<span id="cb125-24"><a href="datawrangling.html#cb125-24" tabindex="-1"></a>         <span class="at">respondent_wall_type =</span> <span class="fu">fct_recode</span>(respondent_wall_type, </span>
<span id="cb125-25"><a href="datawrangling.html#cb125-25" tabindex="-1"></a>                                           <span class="st">&quot;Burned bricks&quot;</span> <span class="ot">=</span> <span class="st">&quot;burntbricks&quot;</span>,</span>
<span id="cb125-26"><a href="datawrangling.html#cb125-26" tabindex="-1"></a>                                           <span class="st">&quot;Mud Daub&quot;</span> <span class="ot">=</span> <span class="st">&quot;muddaub&quot;</span>,</span>
<span id="cb125-27"><a href="datawrangling.html#cb125-27" tabindex="-1"></a>                                           <span class="st">&quot;Sun bricks&quot;</span> <span class="ot">=</span> <span class="st">&quot;sunbricks&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb125-28"><a href="datawrangling.html#cb125-28" tabindex="-1"></a>  <span class="fu">select</span>(key_ID, no_membrs, rooms, people_per_room, respondent_wall_type)</span>
<span id="cb125-29"><a href="datawrangling.html#cb125-29" tabindex="-1"></a>      </span>
<span id="cb125-30"><a href="datawrangling.html#cb125-30" tabindex="-1"></a><span class="co"># conflict</span></span>
<span id="cb125-31"><a href="datawrangling.html#cb125-31" tabindex="-1"></a>conflict <span class="ot">&lt;-</span> </span>
<span id="cb125-32"><a href="datawrangling.html#cb125-32" tabindex="-1"></a>  raw_data <span class="sc">%&gt;%</span> </span>
<span id="cb125-33"><a href="datawrangling.html#cb125-33" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">conflict_yn =</span> <span class="fu">case_when</span>(affect_conflicts <span class="sc">==</span> <span class="st">&quot;frequently&quot;</span> <span class="sc">~</span> <span class="dv">1</span>,</span>
<span id="cb125-34"><a href="datawrangling.html#cb125-34" tabindex="-1"></a>                                 affect_conflicts <span class="sc">==</span> <span class="st">&quot;more_once&quot;</span> <span class="sc">~</span> <span class="dv">1</span>,</span>
<span id="cb125-35"><a href="datawrangling.html#cb125-35" tabindex="-1"></a>                                 affect_conflicts <span class="sc">==</span> <span class="st">&quot;once&quot;</span> <span class="sc">~</span> <span class="dv">1</span>,</span>
<span id="cb125-36"><a href="datawrangling.html#cb125-36" tabindex="-1"></a>                                 affect_conflicts <span class="sc">==</span> <span class="st">&quot;never&quot;</span> <span class="sc">~</span> <span class="dv">0</span>,</span>
<span id="cb125-37"><a href="datawrangling.html#cb125-37" tabindex="-1"></a>                                 <span class="at">.default =</span> <span class="cn">NA</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb125-38"><a href="datawrangling.html#cb125-38" tabindex="-1"></a>  <span class="fu">select</span>(key_ID, conflict_yn)</span>
<span id="cb125-39"><a href="datawrangling.html#cb125-39" tabindex="-1"></a></span>
<span id="cb125-40"><a href="datawrangling.html#cb125-40" tabindex="-1"></a></span>
<span id="cb125-41"><a href="datawrangling.html#cb125-41" tabindex="-1"></a><span class="co"># join data</span></span>
<span id="cb125-42"><a href="datawrangling.html#cb125-42" tabindex="-1"></a>clean_data <span class="ot">&lt;-</span></span>
<span id="cb125-43"><a href="datawrangling.html#cb125-43" tabindex="-1"></a>  paradata <span class="sc">%&gt;%</span> </span>
<span id="cb125-44"><a href="datawrangling.html#cb125-44" tabindex="-1"></a>  <span class="fu">left_join</span>(housing) <span class="sc">%&gt;%</span> </span>
<span id="cb125-45"><a href="datawrangling.html#cb125-45" tabindex="-1"></a>  <span class="fu">left_join</span>(conflict)</span>
<span id="cb125-46"><a href="datawrangling.html#cb125-46" tabindex="-1"></a></span>
<span id="cb125-47"><a href="datawrangling.html#cb125-47" tabindex="-1"></a><span class="co"># saving clean data for later use</span></span>
<span id="cb125-48"><a href="datawrangling.html#cb125-48" tabindex="-1"></a>clean_data <span class="sc">%&gt;%</span> <span class="fu">saveRDS</span>(<span class="fu">here</span>(<span class="st">&quot;data/SAFI_cleaner.rds&quot;</span>)) </span></code></pre></div>
<p>Throughout this chapter, we will add things to this sctructure,
until we end up with a <a href="datawrangling.html#cleaning-rmd">basic .Rmd file</a> that is easy to work with.
First we will info on how to include plots,
then how to use multi-level data,
and finally some advanced techniques such as editing multiple varaibles all at once.</p>
</div>
<div id="using-plots-to-identify-data-issues-reproducibly" class="section level2 hasAnchor">
<h2>Using plots to identify data issues reproducibly<a href="datawrangling.html#using-plots-to-identify-data-issues-reproducibly" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>A key part of data cleaning is identifying issues in the data.
This is often done by plotting the data,
inspecting summary statistics, or tabulating values.
In R, this is easy to do in a reproducible way using <code>ggplot2</code>.
For example, to identify outliers in the <code>years_liv</code> variable,
we can make a boxplot:</p>
<div class="sourceCode" id="cb126"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb126-1"><a href="datawrangling.html#cb126-1" tabindex="-1"></a>raw_data <span class="sc">%&gt;%</span> </span>
<span id="cb126-2"><a href="datawrangling.html#cb126-2" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> years_liv)) <span class="sc">+</span> </span>
<span id="cb126-3"><a href="datawrangling.html#cb126-3" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>()</span></code></pre></div>
<p><img src="_main_files/figure-html/%7D%7B-1.png" width="672" /></p>
<p>From the boxplot, we can see that there’s no super unplausible numbers.
But let’s say we are worried, and want to winsorize this variable at 95%,
just so that the few high values don’t affect our analysis too much.</p>
<div class="sourceCode" id="cb127"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb127-1"><a href="datawrangling.html#cb127-1" tabindex="-1"></a>years_liv_clean <span class="ot">&lt;-</span></span>
<span id="cb127-2"><a href="datawrangling.html#cb127-2" tabindex="-1"></a>  raw_data <span class="sc">%&gt;%</span></span>
<span id="cb127-3"><a href="datawrangling.html#cb127-3" tabindex="-1"></a>  <span class="fu">select</span>(key_ID, years_liv) <span class="sc">%&gt;%</span> </span>
<span id="cb127-4"><a href="datawrangling.html#cb127-4" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">years_liv =</span> <span class="fu">if_else</span>(years_liv <span class="sc">&gt;</span> <span class="fu">quantile</span>(years_liv, <span class="fl">0.95</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb127-5"><a href="datawrangling.html#cb127-5" tabindex="-1"></a>                             <span class="fu">quantile</span>(years_liv, <span class="fl">0.95</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb127-6"><a href="datawrangling.html#cb127-6" tabindex="-1"></a>                             years_liv))</span></code></pre></div>
<p>I’ve saved the cleaned variable as a new object,
ready to be merged into the clean data in the <a href="datawrangling.html#cleaning-rmd">final .Rmd file</a>.</p>
<p>If find this to be a very useful pattern to repeat across my data cleaning scripts:</p>
<ul>
<li>plot data</li>
<li>identify issues and outliers, and describe them in rmarkdown</li>
<li>clean data</li>
<li>merge cleanded data back in data</li>
</ul>
<p>The rendered RMarkdown file will then contain the code, the plots on which
decisions are made, and documentation of these descisions.
This means you can share it with people who have no access to the data,
and they can still assess your work.</p>
</div>
<div id="dealing-with-multiple-levels-of-data" class="section level2 hasAnchor">
<h2>Dealing with multiple levels of data<a href="datawrangling.html#dealing-with-multiple-levels-of-data" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>In many surveys, data is collected at multiple levels, for example the village,
household, and individual level, with each level having its own data set.
For analysis purposes these data sets often need to be merged together.</p>
<p>First, let’s make sure our dataset has multiple levels,
by generating some fake individual-level data,
making sure that the household roster has a number of lines
for each household that is equal to the household size, and has two
randomly generated variables: <code>female</code> and <code>age</code>.
Note that <code>age</code> may
be <code>-99</code>, which should be considered missing.</p>
<div class="sourceCode" id="cb128"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb128-1"><a href="datawrangling.html#cb128-1" tabindex="-1"></a>long_data <span class="ot">&lt;-</span> </span>
<span id="cb128-2"><a href="datawrangling.html#cb128-2" tabindex="-1"></a>    <span class="fu">read_csv</span>(<span class="fu">here</span>(<span class="st">&quot;data/SAFI_clean.csv&quot;</span>), <span class="at">na =</span> <span class="st">&quot;NULL&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb128-3"><a href="datawrangling.html#cb128-3" tabindex="-1"></a>    <span class="fu">select</span>(key_ID,no_membrs ) <span class="sc">%&gt;%</span></span>
<span id="cb128-4"><a href="datawrangling.html#cb128-4" tabindex="-1"></a>    <span class="fu">uncount</span>(no_membrs) <span class="sc">%&gt;%</span></span>
<span id="cb128-5"><a href="datawrangling.html#cb128-5" tabindex="-1"></a>    <span class="fu">group_by</span>(key_ID) <span class="sc">%&gt;%</span> </span>
<span id="cb128-6"><a href="datawrangling.html#cb128-6" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">member_ID =</span> <span class="fu">row_number</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb128-7"><a href="datawrangling.html#cb128-7" tabindex="-1"></a>    <span class="fu">rowwise</span>() <span class="sc">%&gt;%</span></span>
<span id="cb128-8"><a href="datawrangling.html#cb128-8" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">female =</span> <span class="fu">sample</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>,<span class="dv">1</span>),</span>
<span id="cb128-9"><a href="datawrangling.html#cb128-9" tabindex="-1"></a>           <span class="at">age =</span> <span class="fu">case_when</span>(member_ID <span class="sc">==</span> <span class="dv">1</span> <span class="sc">~</span> <span class="fu">sample</span>(<span class="dv">18</span><span class="sc">:</span><span class="dv">86</span>,<span class="dv">1</span>),</span>
<span id="cb128-10"><a href="datawrangling.html#cb128-10" tabindex="-1"></a>                          <span class="at">.default =</span> <span class="fu">sample</span>(<span class="fu">c</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">86</span>,<span class="sc">-</span><span class="dv">99</span>),<span class="dv">1</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb128-11"><a href="datawrangling.html#cb128-11" tabindex="-1"></a>    <span class="fu">ungroup</span>()</span>
<span id="cb128-12"><a href="datawrangling.html#cb128-12" tabindex="-1"></a></span>
<span id="cb128-13"><a href="datawrangling.html#cb128-13" tabindex="-1"></a>long_data <span class="sc">%&gt;%</span> <span class="fu">glimpse</span>()</span></code></pre></div>
<pre><code>## Rows: 942
## Columns: 4
## $ key_ID    &lt;dbl&gt; 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, …
## $ member_ID &lt;int&gt; 1, 2, 3, 1, 2, 3, 4, 5, 6, 7, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10,…
## $ female    &lt;int&gt; 1, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 1, 1, 1, 1, 0, 0, 0, 0, 0, …
## $ age       &lt;dbl&gt; 46, 81, 46, 79, 3, 47, 25, 47, 5, 71, 41, 13, 76, 28, 68, 83…</code></pre>
<div class="sourceCode" id="cb130"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb130-1"><a href="datawrangling.html#cb130-1" tabindex="-1"></a><span class="co"># I save the data as a CSV</span></span>
<span id="cb130-2"><a href="datawrangling.html#cb130-2" tabindex="-1"></a>long_data <span class="sc">%&gt;%</span> <span class="fu">write_csv</span>(<span class="fu">here</span>(<span class="st">&quot;data/raw/SAFI_roster.csv&quot;</span>))</span></code></pre></div>
<div id="pivoting-long-to-wide" class="section level3 hasAnchor">
<h3>Pivoting long to wide<a href="datawrangling.html#pivoting-long-to-wide" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>To merge this roster data to our household data,
we need to make sure we have one row per household.
We do this by making <code>age</code> and <code>female</code> variables for each household member (age_1, age_2, etc.),
For this, we use the <code>pivot_wider()</code> function (in Stata this would be called reshaping ).</p>
<div class="sourceCode" id="cb131"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb131-1"><a href="datawrangling.html#cb131-1" tabindex="-1"></a>wide_data <span class="ot">&lt;-</span></span>
<span id="cb131-2"><a href="datawrangling.html#cb131-2" tabindex="-1"></a>    long_data <span class="sc">%&gt;%</span> </span>
<span id="cb131-3"><a href="datawrangling.html#cb131-3" tabindex="-1"></a>    <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> member_ID,</span>
<span id="cb131-4"><a href="datawrangling.html#cb131-4" tabindex="-1"></a>                <span class="at">values_from =</span> <span class="sc">!</span><span class="fu">ends_with</span>(<span class="st">&quot;_ID&quot;</span>),</span>
<span id="cb131-5"><a href="datawrangling.html#cb131-5" tabindex="-1"></a>                <span class="at">names_vary =</span> <span class="st">&quot;slowest&quot;</span>) </span>
<span id="cb131-6"><a href="datawrangling.html#cb131-6" tabindex="-1"></a></span>
<span id="cb131-7"><a href="datawrangling.html#cb131-7" tabindex="-1"></a>wide_data <span class="sc">%&gt;%</span> <span class="fu">glimpse</span>()</span></code></pre></div>
<pre><code>## Rows: 131
## Columns: 39
## $ key_ID    &lt;dbl&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 1…
## $ female_1  &lt;int&gt; 1, 0, 0, 0, 1, 1, 1, 1, 0, 0, 1, 1, 1, 1, 0, 1, 1, 1, 0, 1, …
## $ age_1     &lt;dbl&gt; 46, 79, 41, 36, 75, 59, 19, 52, 38, 39, 40, 22, 65, 42, 74, …
## $ female_2  &lt;int&gt; 0, 1, 1, 0, 0, 1, 0, 0, 0, 1, 1, 0, 1, 0, 0, 1, 1, 1, 1, 0, …
## $ age_2     &lt;dbl&gt; 81, 3, 13, 84, 23, 4, 1, 61, 79, 22, 3, 54, 57, 4, 35, 19, 1…
## $ female_3  &lt;int&gt; 0, 1, 1, 1, 1, 1, 1, 0, 1, 1, 1, 1, 0, 1, 0, 1, 1, 0, 0, 0, …
## $ age_3     &lt;dbl&gt; 46, 47, 76, 22, 32, 10, 57, 72, 82, 27, 84, 9, 36, 80, 18, 1…
## $ female_4  &lt;int&gt; NA, 0, 1, 0, 0, NA, 1, 1, 1, 1, 0, 0, 0, 1, 0, 1, 0, 0, 1, 1…
## $ age_4     &lt;dbl&gt; NA, 25, 28, 28, 11, NA, 80, 57, 47, 22, 70, 76, 73, 45, 34, …
## $ female_5  &lt;int&gt; NA, 0, 1, 0, 0, NA, 1, 0, 1, 1, 0, 1, 0, 1, 0, 0, 0, NA, 0, …
## $ age_5     &lt;dbl&gt; NA, 47, 68, 85, 42, NA, 53, 54, 73, 17, 55, 54, 60, 82, 55, …
## $ female_6  &lt;int&gt; NA, 0, 0, 1, 1, NA, 1, 1, 1, 0, 0, 0, 1, 0, NA, 1, 1, NA, 1,…
## $ age_6     &lt;dbl&gt; NA, 5, 83, 85, 5, NA, 11, 38, 15, 65, 54, 63, 31, 64, NA, 74…
## $ female_7  &lt;int&gt; NA, 0, 0, 1, 0, NA, NA, 1, 1, 0, NA, 0, NA, 0, NA, NA, 0, NA…
## $ age_7     &lt;dbl&gt; NA, 71, 76, 21, 6, NA, NA, 57, -99, 11, NA, 60, NA, 69, NA, …
## $ female_8  &lt;int&gt; NA, NA, 0, NA, NA, NA, NA, 0, 1, 0, NA, NA, NA, 0, NA, NA, 0…
## $ age_8     &lt;dbl&gt; NA, NA, 39, NA, NA, NA, NA, 83, 70, 55, NA, NA, NA, 41, NA, …
## $ female_9  &lt;int&gt; NA, NA, 0, NA, NA, NA, NA, 0, NA, 1, NA, NA, NA, 0, NA, NA, …
## $ age_9     &lt;dbl&gt; NA, NA, 9, NA, NA, NA, NA, 56, NA, 22, NA, NA, NA, 62, NA, N…
## $ female_10 &lt;int&gt; NA, NA, 0, NA, NA, NA, NA, 1, NA, 1, NA, NA, NA, 1, NA, NA, …
## $ age_10    &lt;dbl&gt; NA, NA, 41, NA, NA, NA, NA, 58, NA, 22, NA, NA, NA, 72, NA, …
## $ female_11 &lt;int&gt; NA, NA, NA, NA, NA, NA, NA, 1, NA, 0, NA, NA, NA, NA, NA, NA…
## $ age_11    &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, 71, NA, 7, NA, NA, NA, NA, NA, N…
## $ female_12 &lt;int&gt; NA, NA, NA, NA, NA, NA, NA, 1, NA, 0, NA, NA, NA, NA, NA, NA…
## $ age_12    &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, 34, NA, 50, NA, NA, NA, NA, NA, …
## $ female_13 &lt;int&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, …
## $ age_13    &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, …
## $ female_14 &lt;int&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, …
## $ age_14    &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, …
## $ female_15 &lt;int&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, …
## $ age_15    &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, …
## $ female_16 &lt;int&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, …
## $ age_16    &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, …
## $ female_17 &lt;int&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, …
## $ age_17    &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, …
## $ female_18 &lt;int&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, …
## $ age_18    &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, …
## $ female_19 &lt;int&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, …
## $ age_19    &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, …</code></pre>
<p>We only needed to specify three options:</p>
<ul>
<li>names_from: this is the column that contains the names (or often numbers)
for each of our units of analysis. In this case, the <code>member_ID</code>.
The values of this variable will be appended to the original variable names to create
new variable names. So <code>age</code> becomes <code>age_1</code>, <code>age_2</code>, etc.</li>
<li>values_from: the variables containing the data. All variables you specify
here, will get one column for each possible value of names_from.
In our case, these variables <code>female</code> and <code>age</code>.
I used <a href="https://tidyr.tidyverse.org/reference/tidyr_tidy_select.html">tidy select syntax</a>
to specify all variables except the ones ending in <code>_ID</code>.</li>
<li>names_vary: this controls the ordering of the variables.
By default (“fastest”), R will create all age variables, and then all female variables,
by specifying slowest, we ensure that first all variables for member 1 are created,
then all variables for member 2, etc.</li>
</ul>
</div>
<div id="pivoting-wide-to-long" class="section level3 hasAnchor">
<h3>Pivoting wide to long<a href="datawrangling.html#pivoting-wide-to-long" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>If we had started with wide data, and had wanted to transform to
long data, we’d have to use <code>pivot_longer()</code>:</p>
<div class="sourceCode" id="cb133"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb133-1"><a href="datawrangling.html#cb133-1" tabindex="-1"></a>wide_data <span class="sc">%&gt;%</span> </span>
<span id="cb133-2"><a href="datawrangling.html#cb133-2" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="sc">!</span>key_ID, <span class="at">names_to =</span> <span class="st">&quot;name&quot;</span>, <span class="at">values_to =</span> <span class="st">&quot;value&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb133-3"><a href="datawrangling.html#cb133-3" tabindex="-1"></a>  <span class="fu">glimpse</span>()</span></code></pre></div>
<pre><code>## Rows: 4,978
## Columns: 3
## $ key_ID &lt;dbl&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, …
## $ name   &lt;chr&gt; &quot;female_1&quot;, &quot;age_1&quot;, &quot;female_2&quot;, &quot;age_2&quot;, &quot;female_3&quot;, &quot;age_3&quot;, …
## $ value  &lt;dbl&gt; 1, 46, 0, 81, 0, 46, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA…</code></pre>
<p>This was easy since the syntax of <code>pivot_longer()</code> is the exact opposite of
<code>pivot_wider()</code>, but the result is pretty useless:</p>
<ul>
<li>The <code>name</code> column contains two things: a variable name and a <code>member_ID</code>;</li>
<li>The data is too long: I’d like <code>age</code> and <code>female</code> to be two separate variables; and</li>
<li>There’s many empty rows: there’s an age and female row for 19 possible members
for each household, but most households are smaller than that.</li>
</ul>
<p>I could use <a href="https://tidyr.tidyverse.org/reference/separate_wider_delim.html"><code>separate_wider_delim()</code></a>,
<code>pivot_wider()</code>, and <code>filter(!is.na())</code> to address those, but that’s not elegant
at all.
I can do all of this within the <code>pivot_longer()</code> call by using the <code>names_to</code>
and <code>names_sep</code> options:</p>
<div class="sourceCode" id="cb135"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb135-1"><a href="datawrangling.html#cb135-1" tabindex="-1"></a>wide_data <span class="sc">%&gt;%</span></span>
<span id="cb135-2"><a href="datawrangling.html#cb135-2" tabindex="-1"></a>    <span class="fu">pivot_longer</span>(<span class="sc">!</span>key_ID,</span>
<span id="cb135-3"><a href="datawrangling.html#cb135-3" tabindex="-1"></a>                 <span class="at">names_to =</span> <span class="fu">c</span>(<span class="st">&quot;.value&quot;</span>, <span class="st">&quot;member_ID&quot;</span>),</span>
<span id="cb135-4"><a href="datawrangling.html#cb135-4" tabindex="-1"></a>                 <span class="at">names_sep =</span> <span class="st">&quot;_&quot;</span>,</span>
<span id="cb135-5"><a href="datawrangling.html#cb135-5" tabindex="-1"></a>                 <span class="at">values_drop_na =</span> <span class="cn">TRUE</span>,</span>
<span id="cb135-6"><a href="datawrangling.html#cb135-6" tabindex="-1"></a>                 <span class="at">names_transform =</span> <span class="fu">list</span>(<span class="at">member_ID =</span> as.integer))</span></code></pre></div>
<pre><code>## # A tibble: 942 × 4
##    key_ID member_ID female   age
##     &lt;dbl&gt;     &lt;int&gt;  &lt;int&gt; &lt;dbl&gt;
##  1      1         1      1    46
##  2      1         2      0    81
##  3      1         3      0    46
##  4      2         1      0    79
##  5      2         2      1     3
##  6      2         3      1    47
##  7      2         4      0    25
##  8      2         5      0    47
##  9      2         6      0     5
## 10      2         7      0    71
## # ℹ 932 more rows</code></pre>
<p>In this case, the syntax is a bit harder to understand. It’s good to think first
what the original data looks like, and how I intend to transform it.
The wide data has columns key_ID, age_1-19 and female_1-19.
I don’t really want to touch the key_ID column.
I want to turn the columns age_1-19 and female_1-19 into three columns:
<code>female</code>, <code>age</code> and <code>member_ID</code>.
This translates to the options we passed to <code>pivot_longer()</code> as follows:</p>
<ul>
<li><code>!key_ID</code>: We want to pivot the data that’s in all columns except key_ID.</li>
<li><code>names_to = c(".value", "member_ID")</code>: this specifies the new columns we want
to create. It basically says that the existing column names consist of two parts:
one part (i.e. female and age) that we wish to keep as column names of variables
that will contain my values, and one part (i.e. the numbers 1-19) which should
be put into a new column which we will “member_ID”.</li>
<li><code>names_sep=</code>: this indicates how the two parts mentioned above are
separated. In more difficult cases, you’ll have to use the <code>names_pattern</code> option.
This requires some knowledge of
<a href="https://www.datacamp.com/tutorial/regex-r-regular-expressions-guide">regular expressions</a>,
so here’s two examples:
<ul>
<li>If there is no seperator (<code>age1</code>,<code>female1</code> etc…): <code>names_pattern = "(.*\\D)([0-9]+)$"</code>.
In this regular expression, <code>.*\\D</code> matches a string of any length, of any characters,
as long as it ends with something other than a digit.
The <code>[0-9]+$</code> matches any number of digits at the end of the string.
The parentheses indicate how the string should be separated to form variable names and member_ID.</li>
<li>If the separator is used in other places in variable names (<code>member_age_1</code> etc…):
<code>names_pattern = "(.*)_([0-9]+)$"</code>.</li>
</ul></li>
<li><code>values_drop_na = TRUE</code>: tells R to drop rows that have missing data for
all variables. This prevents the issue where we hadd too many rows.</li>
<li><code>names_transform</code>: by default, all <code>name</code> columns will be character types, but
<code>member_ID</code> only contains integers, so we transform it to integer. This is
completely optional.</li>
</ul>
</div>
<div id="joining-or-merging-data" class="section level3 hasAnchor">
<h3>Joining (or merging) data<a href="datawrangling.html#joining-or-merging-data" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Tidyverse has four functions to join (or merge, as Stata calls it) two
data sets. The functions that differ in the way they treat observations that are in one data set but not the other.
Consider the diagram below.
It has two data sets, <code>x</code> (in Stata terms, this is the master data set) and <code>y</code> (the using
data set in Stata terms). They have overlapping rows (area B), but also
rows that are only in <code>x</code> (area A) or only in <code>y</code> (area C).</p>
<p><img src="images/join_venn.png" /></p>
<p>The four join functions work as follows:</p>
<ul>
<li><code>inner_join(x,y)</code> will only keep area B.</li>
<li><code>left_join(x,y)</code> will keep areas A and B.</li>
<li><code>right_join(x,y)</code> will keep areas B and C.</li>
<li><code>full_join(x,y)</code> will keep areas A, B, and C.</li>
</ul>
<p>There’s also filtering joins:</p>
<pre><code>- `semi_join(x,y)` will only keep area B, but won&#39;t add columns to X
- `anti_join(x,y)`, will only keep area A, and won&#39;t add columns to X.</code></pre>
<p>In our case, the data sets match perfectly, i.e. we only have an area B,
so there is no practical difference between the four regular joins.
I chose <code>left_join()</code> so the number of
observations in my household survey is guaranteed to remain the same.
To merge the roster to the household data, we use the join_by function:</p>
<div class="sourceCode" id="cb138"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb138-1"><a href="datawrangling.html#cb138-1" tabindex="-1"></a><span class="fu">read_csv</span>(<span class="fu">here</span>(<span class="st">&quot;data/SAFI_clean.csv&quot;</span>), <span class="at">na =</span> <span class="st">&quot;NULL&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb138-2"><a href="datawrangling.html#cb138-2" tabindex="-1"></a><span class="fu">left_join</span>(wide_data)</span></code></pre></div>
<pre><code>## Rows: 131 Columns: 14
## ── Column specification ────────────────────────────────────────────────────────
## Delimiter: &quot;,&quot;
## chr  (7): village, respondent_wall_type, memb_assoc, affect_conflicts, items...
## dbl  (6): key_ID, no_membrs, years_liv, rooms, liv_count, no_meals
## dttm (1): interview_date
## 
## ℹ Use `spec()` to retrieve the full column specification for this data.
## ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.
## Joining with `by = join_by(key_ID)`</code></pre>
<pre><code>## # A tibble: 131 × 52
##    key_ID village  interview_date      no_membrs years_liv respondent_wall_type
##     &lt;dbl&gt; &lt;chr&gt;    &lt;dttm&gt;                  &lt;dbl&gt;     &lt;dbl&gt; &lt;chr&gt;               
##  1      1 God      2016-11-17 00:00:00         3         4 muddaub             
##  2      2 God      2016-11-17 00:00:00         7         9 muddaub             
##  3      3 God      2016-11-17 00:00:00        10        15 burntbricks         
##  4      4 God      2016-11-17 00:00:00         7         6 burntbricks         
##  5      5 God      2016-11-17 00:00:00         7        40 burntbricks         
##  6      6 God      2016-11-17 00:00:00         3         3 muddaub             
##  7      7 God      2016-11-17 00:00:00         6        38 muddaub             
##  8      8 Chirodzo 2016-11-16 00:00:00        12        70 burntbricks         
##  9      9 Chirodzo 2016-11-16 00:00:00         8         6 burntbricks         
## 10     10 Chirodzo 2016-12-16 00:00:00        12        23 burntbricks         
## # ℹ 121 more rows
## # ℹ 46 more variables: rooms &lt;dbl&gt;, memb_assoc &lt;chr&gt;, affect_conflicts &lt;chr&gt;,
## #   liv_count &lt;dbl&gt;, items_owned &lt;chr&gt;, no_meals &lt;dbl&gt;, months_lack_food &lt;chr&gt;,
## #   instanceID &lt;chr&gt;, female_1 &lt;int&gt;, age_1 &lt;dbl&gt;, female_2 &lt;int&gt;, age_2 &lt;dbl&gt;,
## #   female_3 &lt;int&gt;, age_3 &lt;dbl&gt;, female_4 &lt;int&gt;, age_4 &lt;dbl&gt;, female_5 &lt;int&gt;,
## #   age_5 &lt;dbl&gt;, female_6 &lt;int&gt;, age_6 &lt;dbl&gt;, female_7 &lt;int&gt;, age_7 &lt;dbl&gt;,
## #   female_8 &lt;int&gt;, age_8 &lt;dbl&gt;, female_9 &lt;int&gt;, age_9 &lt;dbl&gt;, …</code></pre>
<p>Note that we didn’t specify identifiers, like we would in Stata. R
assumed that the variables that appear in both data frames are the
identifiers, in this case <code>key_ID</code>. Use the <code>by</code> option to change this.</p>
<p>Going the other way around, joining the household data to the
roster data, is equally easy:</p>
<div class="sourceCode" id="cb141"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb141-1"><a href="datawrangling.html#cb141-1" tabindex="-1"></a>long_data <span class="sc">%&gt;%</span></span>
<span id="cb141-2"><a href="datawrangling.html#cb141-2" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb141-3"><a href="datawrangling.html#cb141-3" tabindex="-1"></a>    <span class="fu">read_csv</span>(<span class="fu">here</span>(<span class="st">&quot;data/SAFI_clean.csv&quot;</span>), <span class="at">na =</span> <span class="st">&quot;NULL&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb141-4"><a href="datawrangling.html#cb141-4" tabindex="-1"></a>      <span class="fu">select</span>(key_ID, village, interview_date)</span>
<span id="cb141-5"><a href="datawrangling.html#cb141-5" tabindex="-1"></a>  )</span></code></pre></div>
<pre><code>## Rows: 131 Columns: 14
## ── Column specification ────────────────────────────────────────────────────────
## Delimiter: &quot;,&quot;
## chr  (7): village, respondent_wall_type, memb_assoc, affect_conflicts, items...
## dbl  (6): key_ID, no_membrs, years_liv, rooms, liv_count, no_meals
## dttm (1): interview_date
## 
## ℹ Use `spec()` to retrieve the full column specification for this data.
## ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.
## Joining with `by = join_by(key_ID)`</code></pre>
<pre><code>## # A tibble: 942 × 6
##    key_ID member_ID female   age village interview_date     
##     &lt;dbl&gt;     &lt;int&gt;  &lt;int&gt; &lt;dbl&gt; &lt;chr&gt;   &lt;dttm&gt;             
##  1      1         1      1    46 God     2016-11-17 00:00:00
##  2      1         2      0    81 God     2016-11-17 00:00:00
##  3      1         3      0    46 God     2016-11-17 00:00:00
##  4      2         1      0    79 God     2016-11-17 00:00:00
##  5      2         2      1     3 God     2016-11-17 00:00:00
##  6      2         3      1    47 God     2016-11-17 00:00:00
##  7      2         4      0    25 God     2016-11-17 00:00:00
##  8      2         5      0    47 God     2016-11-17 00:00:00
##  9      2         6      0     5 God     2016-11-17 00:00:00
## 10      2         7      0    71 God     2016-11-17 00:00:00
## # ℹ 932 more rows</code></pre>
<p>Note that here I only merged in two variables,
by using <code>select</code> and a pipe within the <code>left_join()</code> function.</p>
</div>
<div id="summarizing-over-groups-or-collapsing-data" class="section level3 hasAnchor">
<h3>Summarizing over groups (or collapsing data)<a href="datawrangling.html#summarizing-over-groups-or-collapsing-data" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Another way to transform individual-level data to household-level data is to compute summary statistics (sums, counts, means etc.).
For this, we use the <code>group_by()</code> and <code>summarize()</code> functions.
For example,
to compute the household size, number of women and average age in each household.
But before doing anything, I make sure the <code>-99</code>s in the <code>age</code> variable are treated
as missing, using a simple <code>mutate()</code> to conver them to <code>NA</code>.</p>
<div class="sourceCode" id="cb144"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb144-1"><a href="datawrangling.html#cb144-1" tabindex="-1"></a>long_data <span class="sc">%&gt;%</span></span>
<span id="cb144-2"><a href="datawrangling.html#cb144-2" tabindex="-1"></a>  <span class="fu">group_by</span>(key_ID) <span class="sc">%&gt;%</span></span>
<span id="cb144-3"><a href="datawrangling.html#cb144-3" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">age =</span> <span class="fu">if_else</span>(age <span class="sc">==</span> <span class="sc">-</span><span class="dv">99</span>, <span class="cn">NA</span>, age)) <span class="sc">%&gt;%</span></span>
<span id="cb144-4"><a href="datawrangling.html#cb144-4" tabindex="-1"></a>  <span class="fu">summarize</span>(</span>
<span id="cb144-5"><a href="datawrangling.html#cb144-5" tabindex="-1"></a>    <span class="at">hh_size =</span> <span class="fu">n</span>(),</span>
<span id="cb144-6"><a href="datawrangling.html#cb144-6" tabindex="-1"></a>    <span class="at">num_women =</span> <span class="fu">sum</span>(female),</span>
<span id="cb144-7"><a href="datawrangling.html#cb144-7" tabindex="-1"></a>    <span class="at">mean_age =</span> <span class="fu">mean</span>(age, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb144-8"><a href="datawrangling.html#cb144-8" tabindex="-1"></a>  )</span></code></pre></div>
<pre><code>## # A tibble: 131 × 4
##    key_ID hh_size num_women mean_age
##     &lt;dbl&gt;   &lt;int&gt;     &lt;int&gt;    &lt;dbl&gt;
##  1      1       3         1     57.7
##  2      2       7         2     39.6
##  3      3      10         4     47.4
##  4      4       7         3     51.6
##  5      5       7         3     27.7
##  6      6       3         3     24.3
##  7      7       6         5     36.8
##  8      8      12         7     57.8
##  9      9       8         6     57.7
## 10     10      12         6     29.9
## # ℹ 121 more rows</code></pre>
</div>
</div>
<div id="editing-many-variables-at-once" class="section level2 hasAnchor">
<h2>Editing many variables at once<a href="datawrangling.html#editing-many-variables-at-once" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Often, you’ll to do the same operation to many variables.
For example, recoding missing values.
While you can copy paste the code for each variable,
this may lead to errors (if you forget to change the variable name somewhere),
and is tedious to maintain (if you need to change something later on.
So, it’s better to do this in a programmatic way.
Here’s some pointers:</p>
<div id="across" class="section level3 hasAnchor">
<h3>across(): doing the same operations on multiple variables using across<a href="datawrangling.html#across" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The main function to do this is <code>across()</code>, which is used within <code>mutate()</code> or <code>summarize()</code>.
For example, we need to make sure we update <code>-99</code> to <code>NA</code> in <em>all</em> <code>age_</code> variables
in our wide data.</p>
<p>We could write this:</p>
<div class="sourceCode" id="cb146"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb146-1"><a href="datawrangling.html#cb146-1" tabindex="-1"></a>wide_data <span class="sc">%&gt;%</span></span>
<span id="cb146-2"><a href="datawrangling.html#cb146-2" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">age_1 =</span> <span class="fu">if_else</span>(age_1 <span class="sc">==</span> <span class="sc">-</span><span class="dv">99</span>,<span class="cn">NA</span>,age_1),</span>
<span id="cb146-3"><a href="datawrangling.html#cb146-3" tabindex="-1"></a>          <span class="at">age_2 =</span> <span class="fu">if_else</span>(age_2 <span class="sc">==</span> <span class="sc">-</span><span class="dv">99</span>,<span class="cn">NA</span>,age_2),</span>
<span id="cb146-4"><a href="datawrangling.html#cb146-4" tabindex="-1"></a>          <span class="at">age_3 =</span> <span class="fu">if_else</span>(age_3 <span class="sc">==</span> <span class="sc">-</span><span class="dv">99</span>,<span class="cn">NA</span>,age_3),</span>
<span id="cb146-5"><a href="datawrangling.html#cb146-5" tabindex="-1"></a>          <span class="at">age_4 =</span> <span class="fu">if_else</span>(age_4 <span class="sc">==</span> <span class="sc">-</span><span class="dv">99</span>,<span class="cn">NA</span>,age_4),</span>
<span id="cb146-6"><a href="datawrangling.html#cb146-6" tabindex="-1"></a>          <span class="at">age_5 =</span> <span class="fu">if_else</span>(age_5 <span class="sc">==</span> <span class="sc">-</span><span class="dv">99</span>,<span class="cn">NA</span>,age_5),</span>
<span id="cb146-7"><a href="datawrangling.html#cb146-7" tabindex="-1"></a>          <span class="at">age_6 =</span> <span class="fu">if_else</span>(age_6 <span class="sc">==</span> <span class="sc">-</span><span class="dv">99</span>,<span class="cn">NA</span>,age_6),</span>
<span id="cb146-8"><a href="datawrangling.html#cb146-8" tabindex="-1"></a>          <span class="at">age_7 =</span> <span class="fu">if_else</span>(age_7 <span class="sc">==</span> <span class="sc">-</span><span class="dv">99</span>,<span class="cn">NA</span>,age_7),</span>
<span id="cb146-9"><a href="datawrangling.html#cb146-9" tabindex="-1"></a>          <span class="at">age_8 =</span> <span class="fu">if_else</span>(age_8 <span class="sc">==</span> <span class="sc">-</span><span class="dv">99</span>,<span class="cn">NA</span>,age_8),</span>
<span id="cb146-10"><a href="datawrangling.html#cb146-10" tabindex="-1"></a>          <span class="at">age_9 =</span> <span class="fu">if_else</span>(age_9 <span class="sc">==</span> <span class="sc">-</span><span class="dv">99</span>,<span class="cn">NA</span>,age_9),</span>
<span id="cb146-11"><a href="datawrangling.html#cb146-11" tabindex="-1"></a>          <span class="at">age_10 =</span> <span class="fu">if_else</span>(age_10 <span class="sc">==</span> <span class="sc">-</span><span class="dv">99</span>,<span class="cn">NA</span>,age_10),</span>
<span id="cb146-12"><a href="datawrangling.html#cb146-12" tabindex="-1"></a>          <span class="at">age_11 =</span> <span class="fu">if_else</span>(age_11 <span class="sc">==</span> <span class="sc">-</span><span class="dv">99</span>,<span class="cn">NA</span>,age_11),</span>
<span id="cb146-13"><a href="datawrangling.html#cb146-13" tabindex="-1"></a>          <span class="at">age_12 =</span> <span class="fu">if_else</span>(age_12 <span class="sc">==</span> <span class="sc">-</span><span class="dv">99</span>,<span class="cn">NA</span>,age_12),</span>
<span id="cb146-14"><a href="datawrangling.html#cb146-14" tabindex="-1"></a>          <span class="at">age_13 =</span> <span class="fu">if_else</span>(age_13 <span class="sc">==</span> <span class="sc">-</span><span class="dv">99</span>,<span class="cn">NA</span>,age_13),</span>
<span id="cb146-15"><a href="datawrangling.html#cb146-15" tabindex="-1"></a>          <span class="at">age_14 =</span> <span class="fu">if_else</span>(age_14 <span class="sc">==</span> <span class="sc">-</span><span class="dv">99</span>,<span class="cn">NA</span>,age_14),</span>
<span id="cb146-16"><a href="datawrangling.html#cb146-16" tabindex="-1"></a>          <span class="at">age_15 =</span> <span class="fu">if_else</span>(age_15 <span class="sc">==</span> <span class="sc">-</span><span class="dv">99</span>,<span class="cn">NA</span>,age_15),</span>
<span id="cb146-17"><a href="datawrangling.html#cb146-17" tabindex="-1"></a>          <span class="at">age_16 =</span> <span class="fu">if_else</span>(age_16 <span class="sc">==</span> <span class="sc">-</span><span class="dv">99</span>,<span class="cn">NA</span>,age_16),</span>
<span id="cb146-18"><a href="datawrangling.html#cb146-18" tabindex="-1"></a>          <span class="at">age_17 =</span> <span class="fu">if_else</span>(age_17 <span class="sc">==</span> <span class="sc">-</span><span class="dv">99</span>,<span class="cn">NA</span>,age_17),</span>
<span id="cb146-19"><a href="datawrangling.html#cb146-19" tabindex="-1"></a>          <span class="at">age_18 =</span> <span class="fu">if_else</span>(age_18 <span class="sc">==</span> <span class="sc">-</span><span class="dv">99</span>,<span class="cn">NA</span>,age_18),</span>
<span id="cb146-20"><a href="datawrangling.html#cb146-20" tabindex="-1"></a>          <span class="at">age_19 =</span> <span class="fu">if_else</span>(age_19 <span class="sc">==</span> <span class="sc">-</span><span class="dv">99</span>,<span class="cn">NA</span>,age_19)</span>
<span id="cb146-21"><a href="datawrangling.html#cb146-21" tabindex="-1"></a>  )</span></code></pre></div>
<pre><code>## # A tibble: 131 × 39
##    key_ID female_1 age_1 female_2 age_2 female_3 age_3 female_4 age_4 female_5
##     &lt;dbl&gt;    &lt;int&gt; &lt;dbl&gt;    &lt;int&gt; &lt;dbl&gt;    &lt;int&gt; &lt;dbl&gt;    &lt;int&gt; &lt;dbl&gt;    &lt;int&gt;
##  1      1        1    46        0    81        0    46       NA    NA       NA
##  2      2        0    79        1     3        1    47        0    25        0
##  3      3        0    41        1    13        1    76        1    28        1
##  4      4        0    36        0    84        1    22        0    28        0
##  5      5        1    75        0    23        1    32        0    11        0
##  6      6        1    59        1     4        1    10       NA    NA       NA
##  7      7        1    19        0     1        1    57        1    80        1
##  8      8        1    52        0    61        0    72        1    57        0
##  9      9        0    38        0    79        1    82        1    47        1
## 10     10        0    39        1    22        1    27        1    22        1
## # ℹ 121 more rows
## # ℹ 29 more variables: age_5 &lt;dbl&gt;, female_6 &lt;int&gt;, age_6 &lt;dbl&gt;,
## #   female_7 &lt;int&gt;, age_7 &lt;dbl&gt;, female_8 &lt;int&gt;, age_8 &lt;dbl&gt;, female_9 &lt;int&gt;,
## #   age_9 &lt;dbl&gt;, female_10 &lt;int&gt;, age_10 &lt;dbl&gt;, female_11 &lt;int&gt;, age_11 &lt;dbl&gt;,
## #   female_12 &lt;int&gt;, age_12 &lt;dbl&gt;, female_13 &lt;int&gt;, age_13 &lt;dbl&gt;,
## #   female_14 &lt;int&gt;, age_14 &lt;dbl&gt;, female_15 &lt;int&gt;, age_15 &lt;dbl&gt;,
## #   female_16 &lt;int&gt;, age_16 &lt;dbl&gt;, female_17 &lt;int&gt;, age_17 &lt;dbl&gt;, …</code></pre>
<p>However, this is extremely tedious and error-prone (though AI makes this easier nowadays!),
and makes your code unreusable,
as it depends on the highest number of members in your data set to be exactly 19.
If you have households with 20 members, or no household with more than 10,
you’d have to change this code.</p>
<p>Instead, I use the <code>across()</code> function, which takes two arguments: a column specifcation
(for which I use <a href="https://dplyr.tidyverse.org/reference/dplyr_tidy_select.html">tidy select</a>
syntax), and a <a href="programming.html#functions">function</a>. It will then apply the function to all columns:</p>
<div class="sourceCode" id="cb148"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb148-1"><a href="datawrangling.html#cb148-1" tabindex="-1"></a>cleanmissing <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb148-2"><a href="datawrangling.html#cb148-2" tabindex="-1"></a>  <span class="fu">if_else</span>(x <span class="sc">==</span> <span class="sc">-</span><span class="dv">99</span>, <span class="cn">NA</span>, x)</span>
<span id="cb148-3"><a href="datawrangling.html#cb148-3" tabindex="-1"></a>}</span>
<span id="cb148-4"><a href="datawrangling.html#cb148-4" tabindex="-1"></a></span>
<span id="cb148-5"><a href="datawrangling.html#cb148-5" tabindex="-1"></a></span>
<span id="cb148-6"><a href="datawrangling.html#cb148-6" tabindex="-1"></a>wide_data <span class="sc">%&gt;%</span></span>
<span id="cb148-7"><a href="datawrangling.html#cb148-7" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="at">.cols =</span> <span class="fu">starts_with</span>(<span class="st">&quot;age_&quot;</span>),</span>
<span id="cb148-8"><a href="datawrangling.html#cb148-8" tabindex="-1"></a>                <span class="at">.fns =</span> cleanmissing))</span></code></pre></div>
<pre><code>## # A tibble: 131 × 39
##    key_ID female_1 age_1 female_2 age_2 female_3 age_3 female_4 age_4 female_5
##     &lt;dbl&gt;    &lt;int&gt; &lt;dbl&gt;    &lt;int&gt; &lt;dbl&gt;    &lt;int&gt; &lt;dbl&gt;    &lt;int&gt; &lt;dbl&gt;    &lt;int&gt;
##  1      1        1    46        0    81        0    46       NA    NA       NA
##  2      2        0    79        1     3        1    47        0    25        0
##  3      3        0    41        1    13        1    76        1    28        1
##  4      4        0    36        0    84        1    22        0    28        0
##  5      5        1    75        0    23        1    32        0    11        0
##  6      6        1    59        1     4        1    10       NA    NA       NA
##  7      7        1    19        0     1        1    57        1    80        1
##  8      8        1    52        0    61        0    72        1    57        0
##  9      9        0    38        0    79        1    82        1    47        1
## 10     10        0    39        1    22        1    27        1    22        1
## # ℹ 121 more rows
## # ℹ 29 more variables: age_5 &lt;dbl&gt;, female_6 &lt;int&gt;, age_6 &lt;dbl&gt;,
## #   female_7 &lt;int&gt;, age_7 &lt;dbl&gt;, female_8 &lt;int&gt;, age_8 &lt;dbl&gt;, female_9 &lt;int&gt;,
## #   age_9 &lt;dbl&gt;, female_10 &lt;int&gt;, age_10 &lt;dbl&gt;, female_11 &lt;int&gt;, age_11 &lt;dbl&gt;,
## #   female_12 &lt;int&gt;, age_12 &lt;dbl&gt;, female_13 &lt;int&gt;, age_13 &lt;dbl&gt;,
## #   female_14 &lt;int&gt;, age_14 &lt;dbl&gt;, female_15 &lt;int&gt;, age_15 &lt;dbl&gt;,
## #   female_16 &lt;int&gt;, age_16 &lt;dbl&gt;, female_17 &lt;int&gt;, age_17 &lt;dbl&gt;, …</code></pre>
<p>We can have variables for 100 household members, and this code will still work!
Notes:</p>
<ul>
<li>You can use <code>across(.cols = where(is.numeric), .fn = ...)</code> to apply a function to all numeric variables.</li>
<li>You can also combine <code>across()</code> with <code>summarize()</code> to summarize multiple variables more easily. See the
section on <a href="reporting.html#faceting">faceting</a> for an example.</li>
</ul>
<p>You can also define the function in line, if you don’t plan on using the function
anywhere else:</p>
<div class="sourceCode" id="cb150"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb150-1"><a href="datawrangling.html#cb150-1" tabindex="-1"></a>wide_data <span class="sc">%&gt;%</span></span>
<span id="cb150-2"><a href="datawrangling.html#cb150-2" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="at">.cols =</span> <span class="fu">starts_with</span>(<span class="st">&quot;age_&quot;</span>),</span>
<span id="cb150-3"><a href="datawrangling.html#cb150-3" tabindex="-1"></a>                  <span class="at">.fns =</span> <span class="cf">function</span>(var) <span class="fu">if_else</span>(var <span class="sc">==</span> <span class="sc">-</span><span class="dv">99</span>,<span class="cn">NA</span>, var)))</span></code></pre></div>
<pre><code>## # A tibble: 131 × 39
##    key_ID female_1 age_1 female_2 age_2 female_3 age_3 female_4 age_4 female_5
##     &lt;dbl&gt;    &lt;int&gt; &lt;dbl&gt;    &lt;int&gt; &lt;dbl&gt;    &lt;int&gt; &lt;dbl&gt;    &lt;int&gt; &lt;dbl&gt;    &lt;int&gt;
##  1      1        1    46        0    81        0    46       NA    NA       NA
##  2      2        0    79        1     3        1    47        0    25        0
##  3      3        0    41        1    13        1    76        1    28        1
##  4      4        0    36        0    84        1    22        0    28        0
##  5      5        1    75        0    23        1    32        0    11        0
##  6      6        1    59        1     4        1    10       NA    NA       NA
##  7      7        1    19        0     1        1    57        1    80        1
##  8      8        1    52        0    61        0    72        1    57        0
##  9      9        0    38        0    79        1    82        1    47        1
## 10     10        0    39        1    22        1    27        1    22        1
## # ℹ 121 more rows
## # ℹ 29 more variables: age_5 &lt;dbl&gt;, female_6 &lt;int&gt;, age_6 &lt;dbl&gt;,
## #   female_7 &lt;int&gt;, age_7 &lt;dbl&gt;, female_8 &lt;int&gt;, age_8 &lt;dbl&gt;, female_9 &lt;int&gt;,
## #   age_9 &lt;dbl&gt;, female_10 &lt;int&gt;, age_10 &lt;dbl&gt;, female_11 &lt;int&gt;, age_11 &lt;dbl&gt;,
## #   female_12 &lt;int&gt;, age_12 &lt;dbl&gt;, female_13 &lt;int&gt;, age_13 &lt;dbl&gt;,
## #   female_14 &lt;int&gt;, age_14 &lt;dbl&gt;, female_15 &lt;int&gt;, age_15 &lt;dbl&gt;,
## #   female_16 &lt;int&gt;, age_16 &lt;dbl&gt;, female_17 &lt;int&gt;, age_17 &lt;dbl&gt;, …</code></pre>
<p>Note that throughout this page, I will use different ways of defining these inline
functions. They all work, so pick what you like and be consistent.</p>
</div>
<div id="converting-all-yesno-factors-to-dummies" class="section level3 hasAnchor">
<h3>Converting all yes/no factors to dummies<a href="datawrangling.html#converting-all-yesno-factors-to-dummies" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Sometimes you want nicely labelled factors,
but sometimes need dummies.
Here’s one way to convert factors to dummies.</p>
<p>First, create a fake dataset using the fantastic <code>fabricatr</code> package:</p>
<div class="sourceCode" id="cb152"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb152-1"><a href="datawrangling.html#cb152-1" tabindex="-1"></a><span class="fu">library</span>(fabricatr</span>
<span id="cb152-2"><a href="datawrangling.html#cb152-2" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb152-3"><a href="datawrangling.html#cb152-3" tabindex="-1"></a></span>
<span id="cb152-4"><a href="datawrangling.html#cb152-4" tabindex="-1"></a><span class="co"># define some parameters, so we can easily change the size of the dataset</span></span>
<span id="cb152-5"><a href="datawrangling.html#cb152-5" tabindex="-1"></a>num_vars <span class="ot">&lt;-</span> <span class="dv">10</span></span>
<span id="cb152-6"><a href="datawrangling.html#cb152-6" tabindex="-1"></a>num_obs <span class="ot">&lt;-</span> <span class="dv">200</span></span>
<span id="cb152-7"><a href="datawrangling.html#cb152-7" tabindex="-1"></a></span>
<span id="cb152-8"><a href="datawrangling.html#cb152-8" tabindex="-1"></a>factor_data <span class="ot">&lt;-</span></span>
<span id="cb152-9"><a href="datawrangling.html#cb152-9" tabindex="-1"></a>  <span class="co"># i make long data first, so I only need to make one factor var</span></span>
<span id="cb152-10"><a href="datawrangling.html#cb152-10" tabindex="-1"></a>  <span class="fu">fabricate</span>(</span>
<span id="cb152-11"><a href="datawrangling.html#cb152-11" tabindex="-1"></a>    <span class="at">N =</span> num_obs <span class="sc">*</span> num_vars,</span>
<span id="cb152-12"><a href="datawrangling.html#cb152-12" tabindex="-1"></a>    <span class="at">n =</span> <span class="dv">1</span><span class="sc">:</span>N,</span>
<span id="cb152-13"><a href="datawrangling.html#cb152-13" tabindex="-1"></a>    <span class="at">key_ID =</span> <span class="fu">ceiling</span>(n<span class="sc">/</span>num_vars),</span>
<span id="cb152-14"><a href="datawrangling.html#cb152-14" tabindex="-1"></a>    <span class="at">var =</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span>num_vars, N<span class="sc">/</span>num_vars),</span>
<span id="cb152-15"><a href="datawrangling.html#cb152-15" tabindex="-1"></a>    <span class="at">value =</span> <span class="fu">as_factor</span>(<span class="fu">sample</span>(<span class="fu">c</span>(<span class="st">&quot;yes&quot;</span>, <span class="st">&quot;no&quot;</span>),N, <span class="at">replace =</span> <span class="cn">TRUE</span>))</span>
<span id="cb152-16"><a href="datawrangling.html#cb152-16" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb152-17"><a href="datawrangling.html#cb152-17" tabindex="-1"></a>  <span class="co"># and then turn it to wide to create num_var factor variables</span></span>
<span id="cb152-18"><a href="datawrangling.html#cb152-18" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(</span>
<span id="cb152-19"><a href="datawrangling.html#cb152-19" tabindex="-1"></a>    <span class="at">id_cols =</span> key_ID,</span>
<span id="cb152-20"><a href="datawrangling.html#cb152-20" tabindex="-1"></a>    <span class="at">names_from =</span> var, </span>
<span id="cb152-21"><a href="datawrangling.html#cb152-21" tabindex="-1"></a>    <span class="at">values_from =</span> value, </span>
<span id="cb152-22"><a href="datawrangling.html#cb152-22" tabindex="-1"></a>    <span class="at">names_glue =</span> <span class="st">&quot;factor_{var}&quot;</span></span>
<span id="cb152-23"><a href="datawrangling.html#cb152-23" tabindex="-1"></a>  )</span>
<span id="cb152-24"><a href="datawrangling.html#cb152-24" tabindex="-1"></a></span>
<span id="cb152-25"><a href="datawrangling.html#cb152-25" tabindex="-1"></a></span>
<span id="cb152-26"><a href="datawrangling.html#cb152-26" tabindex="-1"></a>factor_data <span class="sc">%&gt;%</span> <span class="fu">glimpse</span>()</span></code></pre></div>
<pre><code>## Error in parse(text = input): &lt;text&gt;:2:1: unexpected symbol
## 1: library(fabricatr
## 2: library
##    ^</code></pre>
<p>Then we need to select all columns that solely consist of “yes” and “no” values,
and convert them to 1s and 0s.
The <code>where</code> function can do this,
by using <code>setequal()</code> to compare the levels of factors to the vector <code>c("yes","no")</code>:</p>
<div class="sourceCode" id="cb154"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb154-1"><a href="datawrangling.html#cb154-1" tabindex="-1"></a>factor_data <span class="sc">%&gt;%</span></span>
<span id="cb154-2"><a href="datawrangling.html#cb154-2" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">key_ID =</span> <span class="fu">as.character</span>(key_ID)) <span class="sc">%&gt;%</span></span>
<span id="cb154-3"><a href="datawrangling.html#cb154-3" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb154-4"><a href="datawrangling.html#cb154-4" tabindex="-1"></a>    <span class="fu">across</span>(</span>
<span id="cb154-5"><a href="datawrangling.html#cb154-5" tabindex="-1"></a>      <span class="fu">where</span>(<span class="sc">~</span><span class="fu">setequal</span>(<span class="fu">levels</span>(.x), <span class="fu">c</span>(<span class="st">&quot;yes&quot;</span>, <span class="st">&quot;no&quot;</span>))),</span>
<span id="cb154-6"><a href="datawrangling.html#cb154-6" tabindex="-1"></a>      <span class="sc">~</span><span class="fu">as.integer</span>(.x <span class="sc">==</span> <span class="st">&quot;yes&quot;</span>)</span>
<span id="cb154-7"><a href="datawrangling.html#cb154-7" tabindex="-1"></a>    )</span>
<span id="cb154-8"><a href="datawrangling.html#cb154-8" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb154-9"><a href="datawrangling.html#cb154-9" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(</span>
<span id="cb154-10"><a href="datawrangling.html#cb154-10" tabindex="-1"></a>    <span class="fu">where</span>(<span class="sc">~</span><span class="fu">setequal</span>(<span class="fu">unique</span>(.x), <span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>)),</span>
<span id="cb154-11"><a href="datawrangling.html#cb154-11" tabindex="-1"></a>    <span class="sc">~</span><span class="fu">factor</span>(.x, <span class="at">levels =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">&quot;no&quot;</span>, <span class="st">&quot;yes&quot;</span>))</span>
<span id="cb154-12"><a href="datawrangling.html#cb154-12" tabindex="-1"></a>  ))</span></code></pre></div>
<pre><code>## Error: object &#39;factor_data&#39; not found</code></pre>
<div class="sourceCode" id="cb156"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb156-1"><a href="datawrangling.html#cb156-1" tabindex="-1"></a>  <span class="fu">glimpse</span>()</span></code></pre></div>
<pre><code>## Error in glimpse.default(): argument &quot;x&quot; is missing, with no default</code></pre>
<p>You can reverse this by using <code>where(~setequal(unique(.x), 0:1))</code>
to select all variables that consist solely of 0s and 1s,
and then use <code>factor()</code> to convert them to factors with labels “no” and “yes”.</p>
</div>
<div id="pivoting" class="section level3 hasAnchor">
<h3>Pivoting<a href="datawrangling.html#pivoting" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Of course, in the example above,
it would have been possible to pivot the data to long first,
so that we have one <code>age</code> variable, and no need to use across.</p>
<div class="sourceCode" id="cb158"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb158-1"><a href="datawrangling.html#cb158-1" tabindex="-1"></a>wide_data <span class="sc">%&gt;%</span></span>
<span id="cb158-2"><a href="datawrangling.html#cb158-2" tabindex="-1"></a>    <span class="fu">pivot_longer</span>(</span>
<span id="cb158-3"><a href="datawrangling.html#cb158-3" tabindex="-1"></a>    <span class="sc">!</span>key_ID,</span>
<span id="cb158-4"><a href="datawrangling.html#cb158-4" tabindex="-1"></a>    <span class="at">names_to =</span> <span class="fu">c</span>(<span class="st">&quot;.value&quot;</span>, <span class="st">&quot;member_ID&quot;</span>),</span>
<span id="cb158-5"><a href="datawrangling.html#cb158-5" tabindex="-1"></a>    <span class="at">names_sep =</span> <span class="st">&quot;_&quot;</span>,</span>
<span id="cb158-6"><a href="datawrangling.html#cb158-6" tabindex="-1"></a>    <span class="at">values_drop_na =</span> <span class="cn">TRUE</span>,</span>
<span id="cb158-7"><a href="datawrangling.html#cb158-7" tabindex="-1"></a>    <span class="at">names_transform =</span> <span class="fu">list</span>(<span class="at">member_ID =</span> as.integer)</span>
<span id="cb158-8"><a href="datawrangling.html#cb158-8" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb158-9"><a href="datawrangling.html#cb158-9" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">age =</span> <span class="fu">if_else</span>(age <span class="sc">==</span> <span class="sc">-</span><span class="dv">99</span>,<span class="cn">NA</span>,age))  <span class="sc">%&gt;%</span> </span>
<span id="cb158-10"><a href="datawrangling.html#cb158-10" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> member_ID,</span>
<span id="cb158-11"><a href="datawrangling.html#cb158-11" tabindex="-1"></a>              <span class="at">values_from =</span> <span class="sc">!</span><span class="fu">ends_with</span>(<span class="st">&quot;_ID&quot;</span>),</span>
<span id="cb158-12"><a href="datawrangling.html#cb158-12" tabindex="-1"></a>              <span class="at">names_vary =</span> <span class="st">&quot;slowest&quot;</span>) </span></code></pre></div>
<pre><code>## # A tibble: 131 × 39
##    key_ID female_1 age_1 female_2 age_2 female_3 age_3 female_4 age_4 female_5
##     &lt;dbl&gt;    &lt;int&gt; &lt;dbl&gt;    &lt;int&gt; &lt;dbl&gt;    &lt;int&gt; &lt;dbl&gt;    &lt;int&gt; &lt;dbl&gt;    &lt;int&gt;
##  1      1        1    46        0    81        0    46       NA    NA       NA
##  2      2        0    79        1     3        1    47        0    25        0
##  3      3        0    41        1    13        1    76        1    28        1
##  4      4        0    36        0    84        1    22        0    28        0
##  5      5        1    75        0    23        1    32        0    11        0
##  6      6        1    59        1     4        1    10       NA    NA       NA
##  7      7        1    19        0     1        1    57        1    80        1
##  8      8        1    52        0    61        0    72        1    57        0
##  9      9        0    38        0    79        1    82        1    47        1
## 10     10        0    39        1    22        1    27        1    22        1
## # ℹ 121 more rows
## # ℹ 29 more variables: age_5 &lt;dbl&gt;, female_6 &lt;int&gt;, age_6 &lt;dbl&gt;,
## #   female_7 &lt;int&gt;, age_7 &lt;dbl&gt;, female_8 &lt;int&gt;, age_8 &lt;dbl&gt;, female_9 &lt;int&gt;,
## #   age_9 &lt;dbl&gt;, female_10 &lt;int&gt;, age_10 &lt;dbl&gt;, female_11 &lt;int&gt;, age_11 &lt;dbl&gt;,
## #   female_12 &lt;int&gt;, age_12 &lt;dbl&gt;, female_13 &lt;int&gt;, age_13 &lt;dbl&gt;,
## #   female_14 &lt;int&gt;, age_14 &lt;dbl&gt;, female_15 &lt;int&gt;, age_15 &lt;dbl&gt;,
## #   female_16 &lt;int&gt;, age_16 &lt;dbl&gt;, female_17 &lt;int&gt;, age_17 &lt;dbl&gt;, …</code></pre>
<p>This is a bit more work, but often more flexible,
and the more operations you need to do, the more worthwhile it is to pivot to long first.</p>
<p>The pivoting approach can also be useful even if you don’t really have another
level of analysis, but just repeated questions.
Let’s say we have a bunch of related variables, such as expenditures on inputs:</p>
<div class="sourceCode" id="cb160"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb160-1"><a href="datawrangling.html#cb160-1" tabindex="-1"></a>expenditures_raw <span class="ot">&lt;-</span> </span>
<span id="cb160-2"><a href="datawrangling.html#cb160-2" tabindex="-1"></a></span>
<span id="cb160-3"><a href="datawrangling.html#cb160-3" tabindex="-1"></a>  wide_data <span class="sc">%&gt;%</span></span>
<span id="cb160-4"><a href="datawrangling.html#cb160-4" tabindex="-1"></a>  <span class="fu">select</span>(key_ID) <span class="sc">%&gt;%</span></span>
<span id="cb160-5"><a href="datawrangling.html#cb160-5" tabindex="-1"></a></span>
<span id="cb160-6"><a href="datawrangling.html#cb160-6" tabindex="-1"></a>  <span class="co"># generate some repeated questions</span></span>
<span id="cb160-7"><a href="datawrangling.html#cb160-7" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">expenditures_fertilizer =</span> <span class="fu">rnorm</span>(<span class="at">n =</span> <span class="fu">nrow</span>(.)),</span>
<span id="cb160-8"><a href="datawrangling.html#cb160-8" tabindex="-1"></a>         <span class="at">expenditures_seeds =</span> <span class="fu">rnorm</span>(<span class="at">n =</span> <span class="fu">nrow</span>(.)),</span>
<span id="cb160-9"><a href="datawrangling.html#cb160-9" tabindex="-1"></a>         <span class="at">expenditures_tools =</span> <span class="fu">rnorm</span>(<span class="at">n =</span> <span class="fu">nrow</span>(.))) </span></code></pre></div>
<p>These variabes all contain the same type of information,
and should be dealth with in the same way.</p>
<p>We could plot and clean each variable separately,
or even in a loop,
but by pivoting we can do it one go,
since <code>ggplot2</code> expects long data.</p>
<div class="sourceCode" id="cb161"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb161-1"><a href="datawrangling.html#cb161-1" tabindex="-1"></a>expenditures_long <span class="ot">&lt;-</span> </span>
<span id="cb161-2"><a href="datawrangling.html#cb161-2" tabindex="-1"></a>  expenditures_raw <span class="sc">%&gt;%</span></span>
<span id="cb161-3"><a href="datawrangling.html#cb161-3" tabindex="-1"></a>  </span>
<span id="cb161-4"><a href="datawrangling.html#cb161-4" tabindex="-1"></a>  <span class="co">#pivot</span></span>
<span id="cb161-5"><a href="datawrangling.html#cb161-5" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">starts_with</span>(<span class="st">&quot;expenditures_&quot;</span>),</span>
<span id="cb161-6"><a href="datawrangling.html#cb161-6" tabindex="-1"></a>               <span class="at">names_to =</span> <span class="st">&quot;expenditure_type&quot;</span>,</span>
<span id="cb161-7"><a href="datawrangling.html#cb161-7" tabindex="-1"></a>               <span class="at">values_to =</span> <span class="st">&quot;amount&quot;</span>)</span>
<span id="cb161-8"><a href="datawrangling.html#cb161-8" tabindex="-1"></a></span>
<span id="cb161-9"><a href="datawrangling.html#cb161-9" tabindex="-1"></a>expenditures_long <span class="sc">%&gt;%</span> </span>
<span id="cb161-10"><a href="datawrangling.html#cb161-10" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> expenditure_type, <span class="at">y =</span> amount)) <span class="sc">+</span></span>
<span id="cb161-11"><a href="datawrangling.html#cb161-11" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>()</span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-86-1.png" width="672" /></p>
<p>We now have one plot that we can look at, and one variable to clean.
Following the pattern of plotting, documenting and cleaning,
we notice negative values of expenditures here.
That’s not possible, so I set them to 0
(though in the real world I’d have to argue why not <code>NA</code>),
and pivot back to wide:</p>
<div class="sourceCode" id="cb162"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb162-1"><a href="datawrangling.html#cb162-1" tabindex="-1"></a>expenditures_cleaned <span class="ot">&lt;-</span></span>
<span id="cb162-2"><a href="datawrangling.html#cb162-2" tabindex="-1"></a>  expenditures_long <span class="sc">%&gt;%</span> </span>
<span id="cb162-3"><a href="datawrangling.html#cb162-3" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">amount =</span> <span class="fu">if_else</span>(amount <span class="sc">&lt;</span> <span class="dv">0</span>, <span class="dv">0</span>, amount)) <span class="sc">%&gt;%</span> </span>
<span id="cb162-4"><a href="datawrangling.html#cb162-4" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> expenditure_type,</span>
<span id="cb162-5"><a href="datawrangling.html#cb162-5" tabindex="-1"></a>              <span class="at">values_from =</span> amount)</span></code></pre></div>
<p>Now you have a dataframe with a bunch of variables, ready to be merged in with the
rest.</p>
</div>
<div id="using-many-variables-as-inputs" class="section level3 hasAnchor">
<h3>Using many variables as inputs<a href="datawrangling.html#using-many-variables-as-inputs" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Suppose we wanted to use many variables as input for a calculation.
For example to
get the household size, number of women and average age from our wide data.
The easiest, and probably best, way to do this in R is by reshaping to long,
and then use summarize, like we did above.
But in Stata you would probably use some sort of
<code>egen</code> function, so that may come natural.
To compute means and sums across rows in R, use <code>rowSums()</code> and <code>rowMeans()</code>:</p>
<div class="sourceCode" id="cb163"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb163-1"><a href="datawrangling.html#cb163-1" tabindex="-1"></a>wide_data <span class="sc">%&gt;%</span></span>
<span id="cb163-2"><a href="datawrangling.html#cb163-2" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="at">.cols =</span> <span class="fu">starts_with</span>(<span class="st">&quot;age_&quot;</span>),</span>
<span id="cb163-3"><a href="datawrangling.html#cb163-3" tabindex="-1"></a>                <span class="at">.fn   =</span> <span class="sc">~</span><span class="fu">if_else</span>(.x <span class="sc">==</span> <span class="sc">-</span><span class="dv">99</span>,<span class="cn">NA</span>,.x))) <span class="sc">%&gt;%</span></span>
<span id="cb163-4"><a href="datawrangling.html#cb163-4" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">mean_age =</span> <span class="fu">rowMeans</span>(<span class="fu">across</span>(<span class="fu">starts_with</span>(<span class="st">&quot;age_&quot;</span>)),</span>
<span id="cb163-5"><a href="datawrangling.html#cb163-5" tabindex="-1"></a>                          <span class="at">na.rm=</span><span class="cn">TRUE</span>),</span>
<span id="cb163-6"><a href="datawrangling.html#cb163-6" tabindex="-1"></a>         <span class="at">num_women =</span>  <span class="fu">rowSums</span>(<span class="fu">across</span>(<span class="fu">starts_with</span>(<span class="st">&quot;female_&quot;</span>)),</span>
<span id="cb163-7"><a href="datawrangling.html#cb163-7" tabindex="-1"></a>                              <span class="at">na.rm=</span><span class="cn">TRUE</span>),</span>
<span id="cb163-8"><a href="datawrangling.html#cb163-8" tabindex="-1"></a>         <span class="at">hh_size =</span> <span class="fu">rowSums</span>(<span class="sc">!</span><span class="fu">is.na</span>(<span class="fu">across</span>(<span class="fu">starts_with</span>(<span class="st">&quot;female_&quot;</span>))))) <span class="sc">%&gt;%</span></span>
<span id="cb163-9"><a href="datawrangling.html#cb163-9" tabindex="-1"></a>  <span class="fu">select</span>(key_ID,hh_size,num_women, mean_age) <span class="sc">%&gt;%</span></span>
<span id="cb163-10"><a href="datawrangling.html#cb163-10" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span></code></pre></div>
<pre><code>## # A tibble: 131 × 4
##    key_ID hh_size num_women mean_age
##     &lt;dbl&gt;   &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;
##  1      1       3         1     57.7
##  2      2       7         2     39.6
##  3      3      10         4     47.4
##  4      4       7         3     51.6
##  5      5       7         3     27.7
##  6      6       3         3     24.3
##  7      7       6         5     36.8
##  8      8      12         7     57.8
##  9      9       8         6     57.7
## 10     10      12         6     29.9
## # ℹ 121 more rows</code></pre>
<p>If you want to compute something other than means or sums,
you can use <code>rowwise()</code> and<code>c_across()</code>
to get a bunch of variables into any function you want:</p>
<div class="sourceCode" id="cb165"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb165-1"><a href="datawrangling.html#cb165-1" tabindex="-1"></a>wide_data <span class="sc">%&gt;%</span></span>
<span id="cb165-2"><a href="datawrangling.html#cb165-2" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="at">.cols =</span> <span class="fu">starts_with</span>(<span class="st">&quot;age_&quot;</span>),</span>
<span id="cb165-3"><a href="datawrangling.html#cb165-3" tabindex="-1"></a>                  <span class="at">.fn =</span> <span class="sc">~</span><span class="fu">if_else</span>(.x <span class="sc">==</span> <span class="sc">-</span><span class="dv">99</span>,<span class="cn">NA</span>,.x))) <span class="sc">%&gt;%</span></span>
<span id="cb165-4"><a href="datawrangling.html#cb165-4" tabindex="-1"></a>    <span class="fu">rowwise</span>() <span class="sc">%&gt;%</span></span>
<span id="cb165-5"><a href="datawrangling.html#cb165-5" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">max_age =</span> <span class="fu">max</span>(<span class="fu">c_across</span>(<span class="fu">starts_with</span>(<span class="st">&quot;age_&quot;</span>)),</span>
<span id="cb165-6"><a href="datawrangling.html#cb165-6" tabindex="-1"></a>                           <span class="at">na.rm=</span><span class="cn">TRUE</span>),</span>
<span id="cb165-7"><a href="datawrangling.html#cb165-7" tabindex="-1"></a>           <span class="at">sd_age =</span>  <span class="fu">sd</span>(<span class="fu">c_across</span>(<span class="fu">starts_with</span>(<span class="st">&quot;age_&quot;</span>)),</span>
<span id="cb165-8"><a href="datawrangling.html#cb165-8" tabindex="-1"></a>                            <span class="at">na.rm=</span><span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb165-9"><a href="datawrangling.html#cb165-9" tabindex="-1"></a>    <span class="fu">select</span>(key_ID,max_age,sd_age) <span class="sc">%&gt;%</span></span>
<span id="cb165-10"><a href="datawrangling.html#cb165-10" tabindex="-1"></a>    <span class="fu">ungroup</span>()</span></code></pre></div>
<pre><code>## # A tibble: 131 × 3
##    key_ID max_age sd_age
##     &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;
##  1      1      81   20.2
##  2      2      79   30.0
##  3      3      83   26.9
##  4      4      85   31.3
##  5      5      75   25.0
##  6      6      59   30.2
##  7      7      80   31.0
##  8      8      83   13.6
##  9      9      82   25.0
## 10     10      65   18.2
## # ℹ 121 more rows</code></pre>
<p><code>rowwise()</code> ensures all summaries are computed per row, and <code>c_across()</code>
allows you to use <a href="https://dplyr.tidyverse.org/reference/dplyr_tidy_select.html">tidy select</a> syntax within any function.</p>
<p>Do note that while this is very flexible, it can be EXTREMELY slow,
as all computations are done row by row.
If you have a large dataset, it’s probably faster to pivot the data to long first.</p>
</div>
<div id="renaming-many-variables" class="section level3 hasAnchor">
<h3>Renaming many variables<a href="datawrangling.html#renaming-many-variables" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>While the pivoting option we discussed above is great,
it does assume your variable names make sense.
This is not always the case, so sometimes you need to rename a bunch of variables:</p>
<p>One way is to use a named list:</p>
<div class="sourceCode" id="cb167"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb167-1"><a href="datawrangling.html#cb167-1" tabindex="-1"></a><span class="co"># this follows the pattern new_name = old_name</span></span>
<span id="cb167-2"><a href="datawrangling.html#cb167-2" tabindex="-1"></a>newnames <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;no_livestock&quot;</span> <span class="ot">=</span> <span class="st">&quot;liv_count&quot;</span>, </span>
<span id="cb167-3"><a href="datawrangling.html#cb167-3" tabindex="-1"></a>              <span class="st">&quot;no_rooms&quot;</span> <span class="ot">=</span> <span class="st">&quot;rooms&quot;</span>,</span>
<span id="cb167-4"><a href="datawrangling.html#cb167-4" tabindex="-1"></a>               <span class="st">&quot;affect_conflicts&quot;</span> <span class="ot">=</span> <span class="st">&quot;ffect_conflicts&quot;</span>)</span>
<span id="cb167-5"><a href="datawrangling.html#cb167-5" tabindex="-1"></a></span>
<span id="cb167-6"><a href="datawrangling.html#cb167-6" tabindex="-1"></a><span class="fu">read_csv</span>(<span class="fu">here</span>(<span class="st">&quot;data/SAFI_clean.csv&quot;</span>), <span class="at">na =</span> <span class="st">&quot;NULL&quot;</span>) <span class="sc">%&gt;%</span>  </span>
<span id="cb167-7"><a href="datawrangling.html#cb167-7" tabindex="-1"></a>    <span class="fu">rename</span>(<span class="fu">any_of</span>(newnames)) <span class="sc">%&gt;%</span></span>
<span id="cb167-8"><a href="datawrangling.html#cb167-8" tabindex="-1"></a>    <span class="fu">glimpse</span>()</span></code></pre></div>
<pre><code>## Rows: 131
## Columns: 14
## $ key_ID               &lt;dbl&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15…
## $ village              &lt;chr&gt; &quot;God&quot;, &quot;God&quot;, &quot;God&quot;, &quot;God&quot;, &quot;God&quot;, &quot;God&quot;, &quot;God&quot;, …
## $ interview_date       &lt;dttm&gt; 2016-11-17, 2016-11-17, 2016-11-17, 2016-11-17, …
## $ no_membrs            &lt;dbl&gt; 3, 7, 10, 7, 7, 3, 6, 12, 8, 12, 6, 7, 6, 10, 5, …
## $ years_liv            &lt;dbl&gt; 4, 9, 15, 6, 40, 3, 38, 70, 6, 23, 20, 20, 8, 20,…
## $ respondent_wall_type &lt;chr&gt; &quot;muddaub&quot;, &quot;muddaub&quot;, &quot;burntbricks&quot;, &quot;burntbricks…
## $ no_rooms             &lt;dbl&gt; 1, 1, 1, 1, 1, 1, 1, 3, 1, 5, 1, 3, 1, 3, 2, 1, 1…
## $ memb_assoc           &lt;chr&gt; NA, &quot;yes&quot;, NA, NA, NA, NA, &quot;no&quot;, &quot;yes&quot;, &quot;no&quot;, &quot;no…
## $ affect_conflicts     &lt;chr&gt; NA, &quot;once&quot;, NA, NA, NA, NA, &quot;never&quot;, &quot;never&quot;, &quot;ne…
## $ no_livestock         &lt;dbl&gt; 1, 3, 1, 2, 4, 1, 1, 2, 3, 2, 2, 2, 3, 3, 3, 4, 1…
## $ items_owned          &lt;chr&gt; &quot;bicycle;television;solar_panel;table&quot;, &quot;cow_cart…
## $ no_meals             &lt;dbl&gt; 2, 2, 2, 2, 2, 2, 3, 2, 3, 3, 2, 3, 2, 3, 2, 3, 2…
## $ months_lack_food     &lt;chr&gt; &quot;Jan&quot;, &quot;Jan;Sept;Oct;Nov;Dec&quot;, &quot;Jan;Feb;Mar;Oct;N…
## $ instanceID           &lt;chr&gt; &quot;uuid:ec241f2c-0609-46ed-b5e8-fe575f6cefef&quot;, &quot;uui…</code></pre>
<p>Note that <code>"affect_conflicts" = "ffect_conflicts"</code> didn’t do anything,
as there is no <code>ffect_conflicts</code> variable.
<code>any_of()</code> just ignored any variables not present in the data.
This can be useful in data pipelines using multiple files,
where some files have mistyped variable names.</p>
<p>What if we want to do the same thing to many variables?
For example, turning them all to uppercase?</p>
<p>We could use <code>newnames = c(KEY_ID = key_ID, VILLAGE = village)</code>
etc. etc.,
but that’d be extremely tedious.
Instead, there is <code>rename_with()</code>, which takes two arugments:</p>
<ul>
<li><code>.fn</code>: A <a href="programming.html#functions">function</a> that takes the variable names of your dataset as an argument.</li>
<li><code>.cols</code>: a tidy select statement defining which columns to change. Defaults
to all columns.</li>
</ul>
<p>This is what it’d look like:</p>
<div class="sourceCode" id="cb169"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb169-1"><a href="datawrangling.html#cb169-1" tabindex="-1"></a><span class="fu">read_csv</span>(<span class="fu">here</span>(<span class="st">&quot;data/SAFI_clean.csv&quot;</span>), <span class="at">na =</span> <span class="st">&quot;NULL&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb169-2"><a href="datawrangling.html#cb169-2" tabindex="-1"></a>    <span class="fu">rename_with</span>(<span class="at">.fn =</span> toupper) <span class="sc">%&gt;%</span> </span>
<span id="cb169-3"><a href="datawrangling.html#cb169-3" tabindex="-1"></a>    <span class="fu">glimpse</span>()</span></code></pre></div>
<pre><code>## Rows: 131
## Columns: 14
## $ KEY_ID               &lt;dbl&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15…
## $ VILLAGE              &lt;chr&gt; &quot;God&quot;, &quot;God&quot;, &quot;God&quot;, &quot;God&quot;, &quot;God&quot;, &quot;God&quot;, &quot;God&quot;, …
## $ INTERVIEW_DATE       &lt;dttm&gt; 2016-11-17, 2016-11-17, 2016-11-17, 2016-11-17, …
## $ NO_MEMBRS            &lt;dbl&gt; 3, 7, 10, 7, 7, 3, 6, 12, 8, 12, 6, 7, 6, 10, 5, …
## $ YEARS_LIV            &lt;dbl&gt; 4, 9, 15, 6, 40, 3, 38, 70, 6, 23, 20, 20, 8, 20,…
## $ RESPONDENT_WALL_TYPE &lt;chr&gt; &quot;muddaub&quot;, &quot;muddaub&quot;, &quot;burntbricks&quot;, &quot;burntbricks…
## $ ROOMS                &lt;dbl&gt; 1, 1, 1, 1, 1, 1, 1, 3, 1, 5, 1, 3, 1, 3, 2, 1, 1…
## $ MEMB_ASSOC           &lt;chr&gt; NA, &quot;yes&quot;, NA, NA, NA, NA, &quot;no&quot;, &quot;yes&quot;, &quot;no&quot;, &quot;no…
## $ AFFECT_CONFLICTS     &lt;chr&gt; NA, &quot;once&quot;, NA, NA, NA, NA, &quot;never&quot;, &quot;never&quot;, &quot;ne…
## $ LIV_COUNT            &lt;dbl&gt; 1, 3, 1, 2, 4, 1, 1, 2, 3, 2, 2, 2, 3, 3, 3, 4, 1…
## $ ITEMS_OWNED          &lt;chr&gt; &quot;bicycle;television;solar_panel;table&quot;, &quot;cow_cart…
## $ NO_MEALS             &lt;dbl&gt; 2, 2, 2, 2, 2, 2, 3, 2, 3, 3, 2, 3, 2, 3, 2, 3, 2…
## $ MONTHS_LACK_FOOD     &lt;chr&gt; &quot;Jan&quot;, &quot;Jan;Sept;Oct;Nov;Dec&quot;, &quot;Jan;Feb;Mar;Oct;N…
## $ INSTANCEID           &lt;chr&gt; &quot;uuid:ec241f2c-0609-46ed-b5e8-fe575f6cefef&quot;, &quot;uui…</code></pre>
<p>The variables names are used as the argument to <code>toupper()</code>,
which returns them in upper case.</p>
<p>But what if we need to provide more arguments?
Let’s say we want to append <code>_0</code> to all columns,
except the ID columns,
to indicate this is baseline data.</p>
<p>We use <code>paste0()</code> which takes two arguments,
the variable name and string we wish to append:</p>
<div class="sourceCode" id="cb171"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb171-1"><a href="datawrangling.html#cb171-1" tabindex="-1"></a><span class="fu">read_csv</span>(<span class="fu">here</span>(<span class="st">&quot;data/SAFI_clean.csv&quot;</span>), <span class="at">na =</span> <span class="st">&quot;NULL&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb171-2"><a href="datawrangling.html#cb171-2" tabindex="-1"></a>    <span class="fu">rename_with</span>(<span class="at">.fn =</span> <span class="sc">~</span><span class="fu">paste0</span>(.x, <span class="st">&quot;_0&quot;</span>), <span class="at">.cols =</span> <span class="sc">!</span>key_ID) <span class="sc">%&gt;%</span></span>
<span id="cb171-3"><a href="datawrangling.html#cb171-3" tabindex="-1"></a>    <span class="fu">glimpse</span>()</span></code></pre></div>
<pre><code>## Rows: 131
## Columns: 14
## $ key_ID                 &lt;dbl&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, …
## $ village_0              &lt;chr&gt; &quot;God&quot;, &quot;God&quot;, &quot;God&quot;, &quot;God&quot;, &quot;God&quot;, &quot;God&quot;, &quot;God&quot;…
## $ interview_date_0       &lt;dttm&gt; 2016-11-17, 2016-11-17, 2016-11-17, 2016-11-17…
## $ no_membrs_0            &lt;dbl&gt; 3, 7, 10, 7, 7, 3, 6, 12, 8, 12, 6, 7, 6, 10, 5…
## $ years_liv_0            &lt;dbl&gt; 4, 9, 15, 6, 40, 3, 38, 70, 6, 23, 20, 20, 8, 2…
## $ respondent_wall_type_0 &lt;chr&gt; &quot;muddaub&quot;, &quot;muddaub&quot;, &quot;burntbricks&quot;, &quot;burntbric…
## $ rooms_0                &lt;dbl&gt; 1, 1, 1, 1, 1, 1, 1, 3, 1, 5, 1, 3, 1, 3, 2, 1,…
## $ memb_assoc_0           &lt;chr&gt; NA, &quot;yes&quot;, NA, NA, NA, NA, &quot;no&quot;, &quot;yes&quot;, &quot;no&quot;, &quot;…
## $ affect_conflicts_0     &lt;chr&gt; NA, &quot;once&quot;, NA, NA, NA, NA, &quot;never&quot;, &quot;never&quot;, &quot;…
## $ liv_count_0            &lt;dbl&gt; 1, 3, 1, 2, 4, 1, 1, 2, 3, 2, 2, 2, 3, 3, 3, 4,…
## $ items_owned_0          &lt;chr&gt; &quot;bicycle;television;solar_panel;table&quot;, &quot;cow_ca…
## $ no_meals_0             &lt;dbl&gt; 2, 2, 2, 2, 2, 2, 3, 2, 3, 3, 2, 3, 2, 3, 2, 3,…
## $ months_lack_food_0     &lt;chr&gt; &quot;Jan&quot;, &quot;Jan;Sept;Oct;Nov;Dec&quot;, &quot;Jan;Feb;Mar;Oct…
## $ instanceID_0           &lt;chr&gt; &quot;uuid:ec241f2c-0609-46ed-b5e8-fe575f6cefef&quot;, &quot;u…</code></pre>
<p>In this case, we specify the function as a
<a href="https://adv-r.hadley.nz/functionals.html#purrr-shortcuts">a purrr-style inline anonymous function</a>
(i.e. preceded by a <code>~</code>), and we supply the variable names as <code>.x</code>.
(This all works the same as <code>across()</code> above.)</p>
<p>Now, let’s replace all instances of <code>membrs</code> or <code>memb</code> in variable names with
<code>members</code> (so <code>no_membrs</code> becomes <code>no_members</code>,
and <code>memb_assoc</code> becomes <code>members_assoc</code>.
For this I will use <code>gsub()</code>,
which takes three arguments:</p>
<ul>
<li>A pattern (expressed as a <a href="https://www.datacamp.com/tutorial/regex-r-regular-expressions-guide">regular expression</a>) to look for;</li>
<li>a replacement for all matches of the pattern; and,</li>
<li>the data to look in (in this case the varaible names).</li>
</ul>
<div class="sourceCode" id="cb173"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb173-1"><a href="datawrangling.html#cb173-1" tabindex="-1"></a><span class="fu">read_csv</span>(<span class="fu">here</span>(<span class="st">&quot;data/SAFI_clean.csv&quot;</span>), <span class="at">na =</span> <span class="st">&quot;NULL&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb173-2"><a href="datawrangling.html#cb173-2" tabindex="-1"></a>    <span class="fu">rename_with</span>(<span class="at">.fn =</span> <span class="sc">~</span><span class="fu">gsub</span>(<span class="st">&quot;membrs|memb&quot;</span>, <span class="st">&quot;members&quot;</span>,.x)) <span class="sc">%&gt;%</span></span>
<span id="cb173-3"><a href="datawrangling.html#cb173-3" tabindex="-1"></a>    <span class="fu">glimpse</span>()</span></code></pre></div>
<pre><code>## Rows: 131
## Columns: 14
## $ key_ID               &lt;dbl&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15…
## $ village              &lt;chr&gt; &quot;God&quot;, &quot;God&quot;, &quot;God&quot;, &quot;God&quot;, &quot;God&quot;, &quot;God&quot;, &quot;God&quot;, …
## $ interview_date       &lt;dttm&gt; 2016-11-17, 2016-11-17, 2016-11-17, 2016-11-17, …
## $ no_members           &lt;dbl&gt; 3, 7, 10, 7, 7, 3, 6, 12, 8, 12, 6, 7, 6, 10, 5, …
## $ years_liv            &lt;dbl&gt; 4, 9, 15, 6, 40, 3, 38, 70, 6, 23, 20, 20, 8, 20,…
## $ respondent_wall_type &lt;chr&gt; &quot;muddaub&quot;, &quot;muddaub&quot;, &quot;burntbricks&quot;, &quot;burntbricks…
## $ rooms                &lt;dbl&gt; 1, 1, 1, 1, 1, 1, 1, 3, 1, 5, 1, 3, 1, 3, 2, 1, 1…
## $ members_assoc        &lt;chr&gt; NA, &quot;yes&quot;, NA, NA, NA, NA, &quot;no&quot;, &quot;yes&quot;, &quot;no&quot;, &quot;no…
## $ affect_conflicts     &lt;chr&gt; NA, &quot;once&quot;, NA, NA, NA, NA, &quot;never&quot;, &quot;never&quot;, &quot;ne…
## $ liv_count            &lt;dbl&gt; 1, 3, 1, 2, 4, 1, 1, 2, 3, 2, 2, 2, 3, 3, 3, 4, 1…
## $ items_owned          &lt;chr&gt; &quot;bicycle;television;solar_panel;table&quot;, &quot;cow_cart…
## $ no_meals             &lt;dbl&gt; 2, 2, 2, 2, 2, 2, 3, 2, 3, 3, 2, 3, 2, 3, 2, 3, 2…
## $ months_lack_food     &lt;chr&gt; &quot;Jan&quot;, &quot;Jan;Sept;Oct;Nov;Dec&quot;, &quot;Jan;Feb;Mar;Oct;N…
## $ instanceID           &lt;chr&gt; &quot;uuid:ec241f2c-0609-46ed-b5e8-fe575f6cefef&quot;, &quot;uui…</code></pre>
</div>
</div>
<div id="seperate_longer" class="section level2 hasAnchor">
<h2>Splitting multi-response variable into dummies<a href="datawrangling.html#seperate_longer" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>The SAFI data contains a number of columns that contain all responses selected
in a multiple response questions. For example, the variables <code>items_owned</code> can
contain something like <code>"bicycle;television;solar_panel;table"</code>. We want to
split this into dummies: one for each possible answers. There’s a number of
ways to do this, but the most convenient is using <code>separate_longer()</code></p>
<div class="sourceCode" id="cb175"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb175-1"><a href="datawrangling.html#cb175-1" tabindex="-1"></a><span class="fu">read_csv</span>(<span class="fu">here</span>(<span class="st">&quot;data/SAFI_clean.csv&quot;</span>), <span class="at">na =</span> <span class="st">&quot;NULL&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb175-2"><a href="datawrangling.html#cb175-2" tabindex="-1"></a>    <span class="fu">separate_longer_delim</span>(items_owned, <span class="at">delim =</span> <span class="st">&quot;;&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb175-3"><a href="datawrangling.html#cb175-3" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">value =</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb175-4"><a href="datawrangling.html#cb175-4" tabindex="-1"></a>    <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> items_owned,</span>
<span id="cb175-5"><a href="datawrangling.html#cb175-5" tabindex="-1"></a>                <span class="at">values_from =</span> value,</span>
<span id="cb175-6"><a href="datawrangling.html#cb175-6" tabindex="-1"></a>                <span class="at">names_glue =</span> <span class="st">&quot;owns_{items_owned}&quot;</span>,</span>
<span id="cb175-7"><a href="datawrangling.html#cb175-7" tabindex="-1"></a>                <span class="at">values_fill =</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb175-8"><a href="datawrangling.html#cb175-8" tabindex="-1"></a>    <span class="fu">left_join</span>(</span>
<span id="cb175-9"><a href="datawrangling.html#cb175-9" tabindex="-1"></a>        <span class="fu">read_csv</span>(<span class="fu">here</span>(<span class="st">&quot;data/SAFI_clean.csv&quot;</span>), <span class="at">na =</span> <span class="st">&quot;NULL&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb175-10"><a href="datawrangling.html#cb175-10" tabindex="-1"></a>            <span class="fu">select</span>(key_ID,items_owned)) <span class="sc">%&gt;%</span></span>
<span id="cb175-11"><a href="datawrangling.html#cb175-11" tabindex="-1"></a>            <span class="fu">select</span>(items_owned, <span class="fu">starts_with</span>(<span class="st">&quot;owns_&quot;</span>)</span>
<span id="cb175-12"><a href="datawrangling.html#cb175-12" tabindex="-1"></a>        ) <span class="sc">%&gt;%</span></span>
<span id="cb175-13"><a href="datawrangling.html#cb175-13" tabindex="-1"></a>    <span class="fu">head</span>()</span></code></pre></div>
<pre><code>## # A tibble: 6 × 19
##   items_owned           owns_bicycle owns_television owns_solar_panel owns_table
##   &lt;chr&gt;                        &lt;dbl&gt;           &lt;dbl&gt;            &lt;dbl&gt;      &lt;dbl&gt;
## 1 bicycle;television;s…            1               1                1          1
## 2 cow_cart;bicycle;rad…            1               0                1          1
## 3 solar_torch                      0               0                0          0
## 4 bicycle;radio;cow_pl…            1               0                1          0
## 5 motorcyle;radio;cow_…            0               0                0          0
## 6 &lt;NA&gt;                             0               0                0          0
## # ℹ 14 more variables: owns_cow_cart &lt;dbl&gt;, owns_radio &lt;dbl&gt;,
## #   owns_cow_plough &lt;dbl&gt;, owns_solar_torch &lt;dbl&gt;, owns_mobile_phone &lt;dbl&gt;,
## #   owns_motorcyle &lt;dbl&gt;, owns_NA &lt;dbl&gt;, owns_fridge &lt;dbl&gt;,
## #   owns_electricity &lt;dbl&gt;, owns_sofa_set &lt;dbl&gt;, owns_lorry &lt;dbl&gt;,
## #   owns_sterio &lt;dbl&gt;, owns_computer &lt;dbl&gt;, owns_car &lt;dbl&gt;</code></pre>
<p>Note that the original <code>items_owned</code> variable is lost during the <code>separate_longer_delim()</code>
step, so I used <code>left_join()</code> to merge it back in for demonstration purposes.</p>
</div>
<div id="cleaning-rmd" class="section level2 hasAnchor">
<h2>Structure of a cleaning Rmarkdown doc with multi-level data<a href="datawrangling.html#cleaning-rmd" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Putting it all together in one script, would look something like this.
The rendered document can be shared more freely than the data,
and includes everything to explain what happens to the data,
including figures.
This makes it much more insightful to share this document than the raw cleaning code.</p>
<pre><code>---
title: &quot;Example Data Cleaning RMarkdown&quot;
output: html_document
---

# introduction
This is an example of a data cleaning RMarkdown script for multi-level data
(household and individual level).

It takes the raw data files in the data/raw folder,
and outputs a cleaned data file in the data/cleaned folder.
The cleaned dataset is ready to be used in analyses.

This script uses the the tidyverse and here packages. 
Packages are managed with renv, 
so details on package versions can be found in the lock file.

# loading libraries

```{r}

library(tidyverse)
library(here)

```

# loading raw data

```{r}
raw_data_hh &lt;- 
  read_csv(here(&quot;data/raw/SAFI_clean.csv&quot;), na = &quot;NULL&quot;)


raw_data_individual &lt;- read_csv(here(&quot;data/raw/SAFI_roster.csv&quot;), na = &quot;NULL&quot;)

```

# data cleaning

## paradata

We create a data object with all the IDs that we need for our anaylsis.
We only include observations from the village Chirodzo,
and interviews done between November 16th 2016 and January 1st 2017,
for reasons that really should be explained here:

```{r}
paradata &lt;- 
  raw_data_hh %&gt;% 
  mutate(day = day(interview_date),
         month = month(interview_date),
         year = year(interview_date)) %&gt;% 
  filter(village == &quot;Chirodzo&quot;) %&gt;%
  filter(interview_date &gt; &quot;2016-11-16&quot; &amp; interview_date &lt; &quot;2017-01-01&quot;) %&gt;% 
  select(key_ID, interview_date, day, month, year, village)
```

## housing

We compute people per room, and recode wall type:

```{r}

housing &lt;-
  raw_data_hh %&gt;% 
  mutate(
    people_per_room = no_membrs / rooms,
    respondent_wall_type = as_factor(respondent_wall_type),
    respondent_wall_type = fct_recode(
      respondent_wall_type, 
      &quot;Burned bricks&quot; = &quot;burntbricks&quot;,
      &quot;Mud Daub&quot; = &quot;muddaub&quot;,
      &quot;Sun bricks&quot; = &quot;sunbricks&quot;
    )
  ) %&gt;% 
  select(key_ID, no_membrs, rooms, people_per_room, respondent_wall_type)

```

## years_liv

We plot years_live to check if there are outliers:

```{r}
# years_liv cleaning
raw_data_hh%&gt;% 
  ggplot(aes(x = years_liv)) + 
  geom_boxplot()

```

Anything higher than 90 years seems unlikely, so we set those to NA:

```{r}
years_liv_clean &lt;-
  raw_data_hh %&gt;% 
  select(key_ID, years_liv) %&gt;%
  mutate(years_liv = if_else(years_liv &gt; 90, NA, years_liv))

```


## items_owned

We generate dummies based on the seet items_owned variable:

```{r}
items_owned &lt;- 
  raw_data_hh %&gt;%
  select(key_ID, items_owned) %&gt;%
  filter(!is.na(items_owned)) %&gt;% # non-answers are considered missing
  separate_longer_delim(items_owned, delim = &quot;;&quot;) %&gt;%
  mutate(value = 1) %&gt;%
  pivot_wider(names_from = items_owned,
              values_from = value,
              names_glue = &quot;owns_{items_owned}&quot;,
              values_fill = 0) %&gt;%
  select(key_ID, starts_with(&quot;owns_&quot;))

```

Note that we set non-answers to missing by filtering them out 
(leading to NAs in the final merged dataset),
because we assume this is because the questions is skipped, but we can&#39;t be sure
(this is why there should always be a &#39;none&#39; option in such questions!).

## househod roster

We reshape the household roster to wide format:

```{r}
# individual level
clean_data_individual &lt;-
  raw_data_individual %&gt;%
  mutate(age = if_else(age == -99,NA,age))  %&gt;% 
    pivot_wider(names_from = member_ID,
                values_from = !ends_with(&quot;_ID&quot;),
                names_vary = &quot;slowest&quot;) 

```

And we compute some summary statistics at the household level:

```{r}

household_size &lt;-
  raw_data_individual %&gt;%
  group_by(key_ID) %&gt;%
  mutate(age = if_else(age == -99,NA,age)) %&gt;%
  summarize(hh_size = n(), num_women = sum(female), mean_age = mean(age, na.rm = TRUE))

```


## conflict 

```{r}
conflict &lt;- 
  raw_data_hh %&gt;% 
  mutate(conflict_yn = case_when(affect_conflicts == &quot;frequently&quot; ~ 1,
                                 affect_conflicts == &quot;more_once&quot; ~ 1,
                                 affect_conflicts == &quot;once&quot; ~ 1,
                                 affect_conflicts == &quot;never&quot; ~ 0,
                                 .default = NA)) %&gt;% 
  select(key_ID, conflict_yn)

```


# join and save 

We join all clenaed ojects together, 
and save it in the clean data folder: 

```{r}

clean_data &lt;-
  paradata %&gt;% 
  left_join(housing) %&gt;% 
  left_join(years_liv_clean) %&gt;%
  left_join(clean_data_individual) %&gt;%
  left_join(household_size) %&gt;%
  left_join(items_owned) %&gt;%
  left_join(conflict)

# saving clean data for later use
clean_data %&gt;% saveRDS(here(&quot;data/clean/SAFI_cleaner.rds&quot;)) 

```</code></pre>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="declaredesign.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="reporting.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
  "sharing": {
    "github": false,
    "facebook": false,
    "twitter": false,
    "linkedin": false,
    "weibo": false,
    "instapaper": false,
    "vk": false,
    "whatsapp": false,
    "all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
  },
  "fontsettings": {
    "theme": "white",
    "family": "sans",
    "size": 2
  },
  "edit": {
    "link": "https://github.com/kleuveld/r_cheatsheet/edit/main/chapters/04-datawrangling.Rmd",
    "text": "Edit"
  },
  "history": {
    "link": null,
    "text": null
  },
  "view": {
    "link": null,
    "text": null
  },
  "download": null,
  "search": {
    "engine": "fuse",
    "options": null
  },
  "toc": {
    "collapse": "section"
  }
});
});
</script>

</body>

</html>
